{% extends "base.html" %}
{% block title %}Sector Emotion{% endblock %}
{% block content %}

<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }

.header { background: linear-gradient(135deg, #ff6b9d, #c44569, #ff6b9d); padding: 22px; text-align: center; border-radius: 16px; margin-bottom: 20px; position: relative; overflow: hidden; }
.header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.15), transparent); animation: shimmer 3s infinite; }
@keyframes shimmer { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }
.header h1 { font-size: 26px; color: white; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); position: relative; z-index: 1; }
/* Highlight for search terms */
.highlight {
    background: #fff9c4;
    padding: 1px 3px;
    border-radius: 3px;
    font-weight: 600;
    color: #333;
}

/* Keyword Actions */
.keyword-actions {
    display: flex;
    gap: 4px;
}

.edit-keyword-modal {
    max-width: 500px;
    width: 95%;
    background: white;
    border-radius: 24px;
    box-shadow: 0 25px 80px rgba(0,0,0,0.3);
    animation: modalIn 0.4s ease;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
}
.keyword-action-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.keyword-action-btn.edit {
    background: rgba(66, 165, 245, 0.1);
    color: #42a5f5;
}

.keyword-action-btn.delete {
    background: rgba(244, 67, 54, 0.1);
    color: #f44336;
}

.keyword-action-btn.edit:hover {
    background: rgba(66, 165, 245, 0.2);
    transform: translateY(-1px);
}

.keyword-action-btn.delete:hover {
    background: rgba(244, 67, 54, 0.2);
    transform: translateY(-1px);
}

/* Edit Keyword Modal Styles */
/* .edit-keyword-modal {
    max-width: 500px;
    width: 95%;
} */

.edit-keyword-modal .modal-body {
    padding: 25px;
}

.edit-keyword-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
}

.edit-keyword-header .emoji {
    font-size: 24px;
}

.edit-keyword-header .title {
    font-size: 18px;
    font-weight: 600;
    color: #1a1a2e;
}

.keyword-to-edit {
    background: #f8f9fa;
    padding: 12px 15px;
    border-radius: 8px;
    font-weight: 600;
    color: #1a1a2e;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
    word-break: break-word;
}

/* Emotion Selection Buttons */
.emotion-select-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.emotion-select-btn {
    flex: 1;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 600;
}

.emotion-select-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.emotion-select-btn.selected {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}

.emotion-select-btn.happy {
    color: #2e7d32;
}

.emotion-select-btn.neutral {
    color: #f57c00;
}

.emotion-select-btn.sad {
    color: #c62828;
}

/* Score Weight Input */
.score-weight-container {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.score-weight-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-weight: 600;
    color: #1a1a2e;
}

.score-weight-value {
    font-size: 18px;
    color: #667eea;
    font-weight: 700;
}

.score-slider {
    width: 100%;
    height: 8px;
    -webkit-appearance: none;
    appearance: none;
    background: #e0e0e0;
    border-radius: 4px;
    outline: none;
}

.score-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
}

.score-slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
}

.score-ticks {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 11px;
    color: #666;
}

/* Danger Zone for Delete */
.danger-zone {
    background: #ffebee;
    border: 1px solid #ffcdd2;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
}

.danger-zone h4 {
    color: #c62828;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.danger-zone p {
    font-size: 13px;
    color: #666;
    margin-bottom: 15px;
}
/* Enhanced Keyword Modal Styles */
.keyword-tabs-nav {
  display: flex;
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border-bottom: 1px solid #e9ecef;
  padding: 0 30px;
  overflow-x: auto;
}

.keyword-tab-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 15px 20px;
  border: none;
  background: none;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  white-space: nowrap;
  position: relative;
}

.keyword-tab-btn:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.keyword-tab-btn.active {
  color: #667eea;
  border-bottom: 3px solid #667eea;
  background: rgba(102, 126, 234, 0.1);
}

.keyword-count-badge {
  background: #e9ecef;
  color: #666;
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 10px;
  min-width: 24px;
  text-align: center;
}

.keyword-tab-btn.active .keyword-count-badge {
  background: #667eea;
  color: white;
}

/* Keywords Container */
.keywords-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  max-height: 500px;
  overflow-y: auto;
  padding: 20px 0;
}

.keyword-item {
  background: white;
  border-radius: 12px;
  padding: 15px;
  border: 2px solid #e9ecef;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.keyword-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  border-color: #667eea;
}

.keyword-item.happy {
  border-left: 4px solid #4caf50;
  background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
}

.keyword-item.neutral {
  border-left: 4px solid #ff9800;
  background: linear-gradient(135deg, #fff3e0, #fff8e1);
}

.keyword-item.sad {
  border-left: 4px solid #f44336;
  background: linear-gradient(135deg, #ffebee, #fce4ec);
}

.keyword-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.keyword-text {
  font-weight: 600;
  font-size: 14px;
  color: #1a1a2e;
  word-break: break-word;
  flex: 1;
}

.keyword-score {
  background: rgba(255,255,255,0.8);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  min-width: 24px;
  text-align: center;
  margin-left: 8px;
}

.keyword-item.happy .keyword-score {
  background: rgba(76, 175, 80, 0.1);
  color: #2e7d32;
}

.keyword-item.neutral .keyword-score {
  background: rgba(255, 152, 0, 0.1);
  color: #f57c00;
}

.keyword-item.sad .keyword-score {
  background: rgba(244, 67, 54, 0.1);
  color: #c62828;
}

.keyword-emotion {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-top: 8px;
}

.keyword-item.happy .keyword-emotion {
  background: rgba(76, 175, 80, 0.15);
  color: #2e7d32;
}

.keyword-item.neutral .keyword-emotion {
  background: rgba(255, 152, 0, 0.15);
  color: #f57c00;
}

.keyword-item.sad .keyword-emotion {
  background: rgba(244, 67, 54, 0.15);
  color: #c62828;
}

/* REMOVED EDIT CSS: .keyword-actions and related styles deleted */

/* REMOVED EDIT CSS: Emotion Select Buttons in Edit Modal deleted */

/* REMOVED EDIT CSS: Score Slider deleted */

/* Danger Button */
.btn-danger {
  background: linear-gradient(135deg, #f44336, #c62828);
  color: white;
  box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
  border: none;
  border-radius: 12px;
  padding: 14px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-danger:hover {
  box-shadow: 0 6px 20px rgba(244, 67, 54, 0.5);
  transform: translateY(-2px);
}

/* Empty State */
.empty-keywords-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.empty-keywords-state .icon {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

/* Responsive Design */
@media (max-width: 768px) {
  .keywords-container {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
  }
  
  .keyword-tabs-nav {
    padding: 0 15px;
  }
  
  .keyword-tab-btn {
    padding: 12px 15px;
    font-size: 13px;
  }
}
/* Navigation with Scrollable Tabs */
.nav-bar-container {
    position: relative;
    margin-bottom: 25px;
    width: 100%;
    overflow: hidden;
}

.nav-bar { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: thin;
    scrollbar-color: #667eea transparent;
    padding: 10px 0;
    margin: 0 50px;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
}

.nav-bar::-webkit-scrollbar {
    height: 6px;
}

.nav-bar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.nav-bar::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 3px;
}

.nav-bar::-webkit-scrollbar-thumb:hover {
    background: #764ba2;
}

.nav-btn { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    padding: 11px 18px; 
    border-radius: 30px; 
    border: none; 
    background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
    cursor: pointer; 
    font-size: 13px; 
    font-weight: 600; 
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
    position: relative;
    flex-shrink: 0;
    white-space: nowrap;
}
.nav-btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
.nav-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
.nav-btn .icon { font-size: 16px; }

/* Add Tab Button */
.add-tab-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4caf50, #2e7d32);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 24px;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(76,175,80,0.4);
    margin-left: 5px;
    flex-shrink: 0;
}

.add-tab-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(76,175,80,0.5);
}

/* Remove button for custom tabs */
.nav-btn .remove-tab {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 18px;
    height: 18px;
    background: #e53935;
    color: white;
    border-radius: 50%;
    border: none;
    font-size: 10px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0;
    z-index: 2;
}

.nav-btn.custom-tab:hover .remove-tab {
    display: flex;
}

/* Scroll arrows */
.scroll-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(102,126,234,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.scroll-arrow:hover {
    transform: translateY(-50%) scale(1.1);
}

.scroll-arrow-left {
    left: 0;
}

.scroll-arrow-right {
    right: 0;
}

.scroll-arrow.hidden {
    display: none;
}

/* MyList Container Header Styles */
.mylist-header { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    margin-bottom: 15px; 
    padding: 14px 20px; 
    background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
    border-radius: 14px; 
    flex-wrap: wrap;
}
.mylist-title { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    flex: 1;
}

.mylist-title span:first-child { 
    font-size: 22px; 
}
.mylist-name-edit { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
}
.mylist-name-display { 
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600; 
    color: #1565c0; 
    font-size: 15px; 
    cursor: pointer; 
    padding: 4px 8px; 
    border-radius: 6px; 
    transition: all 0.2s; 
}
.mylist-name-display:hover { 
    background: rgba(255,255,255,0.5); 
}
.mylist-name-display:hover .edit-icon-container {
    opacity: 1;
}
.edit-icon-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    opacity: 0.6;
    transition: opacity 0.2s;
}
.edit-icon {
    font-size: 14px;
}

.mylist-name-input { 
    background: white; 
    border: 1px solid #90caf9; 
    border-radius: 8px; 
    padding: 4px 8px; 
    color: #1565c0; 
    font-weight: 600; 
    width: 150px; 
    font-size: 15px; 
}
.mylist-name-input:focus { 
    outline: none; 
    border-color: #42a5f5; 
    box-shadow: 0 0 0 2px rgba(66,165,245,0.2); 
}

/* Action Buttons in MyList Container */
.mylist-actions { 
    display: flex; 
    gap: 8px; 
    flex-wrap: wrap;
}
.mylist-action-btn { 
    display: flex; 
    align-items: center; 
    gap: 6px; 
    padding: 8px 12px; 
    border-radius: 20px; 
    border: none; 
    background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
    cursor: pointer; 
    font-size: 12px; 
    font-weight: 600; 
    transition: all 0.3s; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
}
.mylist-action-btn:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
}
.mylist-action-btn.guide { 
    background: linear-gradient(135deg, #4fc3f7, #0288d1); 
    color: white; 
}
.mylist-action-btn.keyword { 
    background: linear-gradient(135deg, #81c784, #388e3c); 
    color: white; 
}
.mylist-action-btn.export { 
    background: linear-gradient(135deg, #ffb74d, #f57c00); 
    color: white; 
}
.mylist-action-btn.compare { 
    background: linear-gradient(135deg, #ba68c8, #7b1fa2); 
    color: white; 
}

/* Layout */
.main-content { display: flex; gap: 25px; flex-wrap: wrap; }
.sidebar { width: 230px; flex-shrink: 0; }
@media (max-width: 900px) { 
    .sidebar { width: 100%; } 
    .main-content { flex-direction: column; } 
    .mylist-header { flex-direction: column; align-items: flex-start; }
    .mylist-actions { justify-content: flex-start; width: 100%; }
}
.sidebar-box { background: linear-gradient(180deg, #f8f9fa, #fff); border-radius: 18px; padding: 22px; box-shadow: 0 10px 35px rgba(0,0,0,0.08); border: 1px solid rgba(102,126,234,0.15); }
.sidebar-title { font-weight: 700; margin-bottom: 18px; color: #1a1a2e; font-size: 15px; display: flex; align-items: center; gap: 8px; }

/* Analysis Section */
.analysis-section { margin-top: 20px; padding: 18px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 14px; }
.analysis-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; margin-top: 15px; }
.analysis-header:first-child { margin-top: 0; }
.analysis-icon { font-size: 22px; }
.analysis-label { font-weight: 600; color: #1565c0; font-size: 14px; }
.analysis-select { width: 100%; padding: 11px 14px; border-radius: 10px; border: 2px solid #90caf9; background: white; font-size: 13px; cursor: pointer; transition: all 0.3s; margin-bottom: 10px; }
.analysis-select:focus { outline: none; border-color: #42a5f5; box-shadow: 0 0 0 4px rgba(66,165,245,0.2); }
.analyze-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.4); display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
.analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.5); }
.analyze-btn:disabled { background: #bdbdbd; cursor: not-allowed; transform: none; box-shadow: none; }

/* Test Button */
.test-btn { 
    width: 100%; 
    padding: 12px; 
    border: none; 
    border-radius: 12px; 
    background: linear-gradient(135deg, #4caf50, #2e7d32); 
    color: white; 
    font-weight: 600; 
    font-size: 14px; 
    cursor: pointer; 
    transition: all 0.3s; 
    box-shadow: 0 4px 15px rgba(76,175,80,0.4); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 8px; 
    margin-top: 15px;
}
.test-btn:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 6px 20px rgba(76,175,80,0.5); 
}
.test-btn:disabled { 
    background: #bdbdbd; 
    cursor: not-allowed; 
    transform: none; 
    box-shadow: none; 
}

/* Status & Timer */
.timer-display { text-align: center; margin-top: 15px; font-size: 14px; font-weight: 600; color: #1565c0; }
.status-display { text-align: center; margin-top: 5px; font-size: 12px; color: #666; }

/* Line Timer Styles */
.timer-line-container {
    margin-top: 15px;
    display: none; /* Hidden by default */
}
.timer-text-small {
    font-size: 11px;
    color: #666;
    margin-bottom: 5px;
    display: flex;
    justify-content: space-between;
}
.timer-line-track {
    width: 100%;
    height: 6px;
    background: rgba(255,255,255,0.5);
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.8);
}
.timer-line-fill {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #43a047, #66bb6a);
    border-radius: 10px;
    transition: width 1s linear, background 0.3s;
}
.timer-line-fill.warning { background: linear-gradient(90deg, #fdd835, #ffee58); }
.timer-line-fill.danger { background: linear-gradient(90deg, #e53935, #ef5350); }

/* Table */
.table-container { flex: 1; min-width: 0; }
.table-wrapper { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th { background: linear-gradient(135deg, #00897b, #00796b); color: white; padding: 16px 12px; text-align: center; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
.data-table td { padding: 14px 10px; text-align: center; border-bottom: 1px solid #eee; font-size: 13px; transition: all 0.3s; }
.data-table tbody tr:hover { background: linear-gradient(135deg, #e0f7fa, #e8f5e9); }
.data-table tbody tr:nth-child(even) { background: #fafbfc; }
.emoji { font-size: 20px; display: block; margin-bottom: 4px; }
.score-cell { font-weight: 600; font-size: 13px; }
.score-sad { color: #e53935; }
.score-neutral { color: #f57c00; }
.score-happy { color: #43a047; }
.rag-cell { display: flex; justify-content: center; }
.rag-dot { 
    width: 26px; 
    height: 26px; 
    border-radius: 50%; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
    transition: all 0.3s; 
    cursor: pointer; 
    position: relative;
}
.rag-dot:hover { transform: scale(1.25); }
.rag-green { background: linear-gradient(135deg, #66bb6a, #43a047); }
.rag-yellow { background: linear-gradient(135deg, #ffee58, #fdd835); }
.rag-red { background: linear-gradient(135deg, #ef5350, #e53935); }
.rag-header { display: flex; gap: 4px; justify-content: center; margin-bottom: 4px; }
.rag-header span { width: 12px; height: 12px; border-radius: 50%; }
.company-name { font-weight: 600; color: #1a1a2e; }
.sector-badge { display: inline-block; padding: 5px 12px; background: linear-gradient(135deg, #ede7f6, #d1c4e9); color: #5e35b1; border-radius: 20px; font-size: 11px; font-weight: 600; }
.empty-cell { color: #bdbdbd; font-style: italic; }
.loading-cell { color: #667eea; font-weight: 600; animation: pulse 1.5s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* Enhanced Actions Cell */
.actions-cell { 
    display: flex; 
    gap: 6px; 
    justify-content: center; 
    flex-wrap: wrap;
    min-height: 40px;
    align-items: center;
}

.action-btn { 
    width: 32px; 
    height: 32px; 
    border-radius: 10px; 
    border: none; 
    cursor: pointer; 
    font-size: 14px; 
    transition: all 0.3s; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.action-btn:hover { 
    transform: translateY(-3px) scale(1.1); 
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

.btn-edit { 
    background: linear-gradient(135deg, #42a5f5, #1e88e5); 
    color: white;
}

.btn-delete { 
    background: linear-gradient(135deg, #ef5350, #e53935); 
    color: white;
}

.btn-up { 
    background: linear-gradient(135deg, #66bb6a, #43a047); 
    color: white;
}

.btn-down { 
    background: linear-gradient(135deg, #ffa726, #fb8c00); 
    color: white;
}

.add-row-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 16px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border: 2px dashed #81c784; cursor: pointer; transition: all 0.3s; color: #2e7d32; font-weight: 600; font-size: 14px; }
.add-row-btn:hover { background: linear-gradient(135deg, #c8e6c9, #a5d6a7); border-color: #66bb6a; }

/* Fixed Modal Overlay (removed backdrop-filter) */
.modal-overlay { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.6); 
    justify-content: center; 
    align-items: center; 
    z-index: 1000; 
    padding: 20px;
}

/* REMOVED: Edit Keyword Modal CSS deleted */

.modal { 
    background: white; 
    border-radius: 24px; 
    padding: 30px; 
    width: 95%; 
    max-width: 420px; 
    box-shadow: 0 25px 80px rgba(0,0,0,0.3); 
    animation: modalIn 0.4s ease; 
    max-height: 90vh;
    overflow-y: auto;
    margin: auto;
    position: relative;
}

@keyframes modalIn { 
    from { 
        opacity: 0; 
        transform: scale(0.9) translateY(20px); 
    } 
    to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
    } 
}

.modal h2 { margin-bottom: 25px; color: #1a1a2e; font-size: 22px; display: flex; align-items: center; gap: 10px; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; font-size: 13px; }
.form-group input, .form-group select { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px; transition: all 0.3s; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.15); }
.modal-actions { display: flex; gap: 12px; margin-top: 25px; }
.modal-btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
.modal-btn:hover { transform: translateY(-2px); }
.btn-cancel { background: #f5f5f5; color: #666; }
.btn-cancel:hover { background: #eeeeee; }
.btn-save { background: linear-gradient(135deg, #667eea, #764ba2); color: white; box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
.btn-save:hover { box-shadow: 0 6px 20px rgba(102,126,234,0.5); }
.toast { position: fixed; bottom: 30px; right: 30px; padding: 16px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 14px; font-weight: 500; box-shadow: 0 10px 40px rgba(0,0,0,0.3); transform: translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 2000; }
.toast.show { transform: translateY(0); opacity: 1; }
.loading-bar { height: 4px; background: linear-gradient(90deg, #667eea, #764ba2, #667eea); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 2px; margin-bottom: 15px; }
@keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

/* Tab-specific MyList header styles */
.mylist-header.semiconductor { background: linear-gradient(135deg, #e3f2fd, #bbdefb); }
.mylist-header.pharma { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); }
.mylist-header.electricity { background: linear-gradient(135deg, #fff3e0, #ffe0b2); }
.mylist-header.mining { background: linear-gradient(135deg, #fbe9e7, #ffccbc); }
.mylist-header.automobile { background: linear-gradient(135deg, #f3e5f5, #e1bee7); }
.mylist-header.quantum { background: linear-gradient(135deg, #e0f2f1, #b2dfdb); }
.mylist-header.finance { background: linear-gradient(135deg, #e8eaf6, #c5cae9); }
.mylist-header.retail { background: linear-gradient(135deg, #fff8e1, #ffecb3); }
.mylist-header.technology { background: linear-gradient(135deg, #f3e5f5, #e1bee7); }

/* Enhanced Modal Styles */
.guide-modal, .keyword-modal, .export-modal, .compare-modal, .test-modal, .edit-rag-modal, .add-tab-modal {
    max-width: 900px;
    width: 95%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    margin: auto;
}

.modal-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px 30px;
    border-radius: 20px 20px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.modal-header h2 {
    color: white;
    margin: 0;
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.3s;
}

.modal-close:hover {
    background: rgba(255,255,255,0.2);
}

.modal-body {
    padding: 30px;
    flex: 1;
    overflow-y: auto;
    max-height: calc(90vh - 140px);
}

/* Fixed Modal Actions Sticky Footer */
.modal-actions-sticky {
    padding: 20px 30px;
    background: rgba(248, 249, 250, 0.95);
    border-top: 1px solid #e9ecef;
    border-radius: 0 0 20px 20px;
    display: flex;
    gap: 12px;
    flex-shrink: 0;
    position: sticky;
    bottom: 0;
    z-index: 10;
}

.modal-actions-sticky .modal-btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-actions-sticky .modal-btn:hover {
    transform: translateY(-2px);
}

.modal-actions-sticky .btn-cancel {
    background: #f5f5f5;
    color: #666;
}

.modal-actions-sticky .btn-cancel:hover {
    background: #eeeeee;
}

.modal-actions-sticky .btn-save {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 4px 15px rgba(102,126,234,0.4);
}

.modal-actions-sticky .btn-save:hover {
    box-shadow: 0 6px 20px rgba(102,126,234,0.5);
}

/* Test Action Buttons */
.test-action-buttons {
    display: flex;
    gap: 12px;
    margin: 20px 0;
    padding: 15px 0;
    border-top: 1px solid #e9ecef;
    border-bottom: 1px solid #e9ecef;
}

.test-action-buttons .modal-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

/* Visual Charts Styles */
.chart-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    color: #1a1a2e;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.sentiment-chart {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.chart-bar {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    position: relative;
    overflow: hidden;
}

.chart-bar-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-weight: 600;
    color: #1a1a2e;
}

.chart-bar-track {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

.chart-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 1s ease-in-out;
    position: relative;
}

.chart-bar-fill.happy { background: linear-gradient(90deg, #4caf50, #66bb6a); }
.chart-bar-fill.neutral { background: linear-gradient(90deg, #ff9800, #ffb74d); }
.chart-bar-fill.sad { background: linear-gradient(90deg, #f44336, #ef5350); }

.chart-bar-value {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: 600;
    color: #1a1a2e;
    text-shadow: 0 0 2px white;
}

/* Pie Chart Styles */
.pie-chart-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 20px 0;
}

.pie-chart {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background: conic-gradient(
        #4caf50 0% var(--happy-percent, 0%),
        #ff9800 var(--happy-percent, 0%) calc(var(--happy-percent, 0%) + var(--neutral-percent, 0%)),
        #f44336 calc(var(--happy-percent, 0%) + var(--neutral-percent, 0%)) 100%
    );
    position: relative;
}

.pie-chart-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #1a1a2e;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.pie-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.legend-color.happy { background: #4caf50; }
.legend-color.neutral { background: #ff9800; }
.legend-color.sad { background: #f44336; }

/* Guide Modal Specific Styles */
.guide-section {
    margin-bottom: 30px;
}

.guide-section h3 {
    color: #1a1a2e;
    margin-bottom: 15px;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.guide-section p {
    color: #555;
    line-height: 1.6;
    margin-bottom: 15px;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.feature-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid #667eea;
}

.feature-card h4 {
    color: #1a1a2e;
    margin-bottom: 10px;
    font-size: 16px;
}

.feature-card ul {
    list-style: none;
    padding: 0;
}

.feature-card li {
    padding: 5px 0;
    color: #555;
    display: flex;
    align-items: center;
    gap: 8px;
}

.feature-card li:before {
    content: "âœ“";
    color: #4caf50;
    font-weight: bold;
}

/* FIXED: Keyword Modal Specific Styles */
.keyword-modal-body {
    padding: 30px;
    flex: 1;
    overflow-y: auto;
    max-height: calc(90vh - 140px);
}

.emotion-categories {
    display: flex;
    flex-direction: column;
    gap: 25px;
    margin: 20px 0;
}

.emotion-category {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.05);
}

.emotion-category-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(0,0,0,0.05);
}

.emotion-emoji {
    font-size: 36px;
}

.emotion-title {
    font-size: 22px;
    font-weight: 700;
    color: #1a1a2e;
    margin: 0;
    flex: 1;
}

.emotion-count {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
}

.keyword-list-container {
    max-height: 300px;
    overflow-y: auto;
    background: #f8f9fa;
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid #e9ecef;
}

.keyword-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
}

.keyword-tag {
    background: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    color: #333;
    border: 1px solid #dee2e6;
    transition: all 0.2s;
    text-align: center;
    word-break: break-word;
}

.keyword-tag.happy { 
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9); 
    color: #2e7d32;
    border-color: #a5d6a7;
}
.keyword-tag.neutral { 
    background: linear-gradient(135deg, #f5f5f5, #eeeeee); 
    color: #616161;
    border-color: #e0e0e0;
}
.keyword-tag.sad { 
    background: linear-gradient(135deg, #ffebee, #ffcdd2); 
    color: #c62828;
    border-color: #ef9a9a;
}

.keyword-tag:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Search bar for keywords */
.keyword-search {
    margin-bottom: 20px;
    position: relative;
}

.keyword-search input {
    width: 100%;
    padding: 14px 20px 14px 45px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 14px;
    transition: all 0.3s;
    background: white;
}

.keyword-search input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
}

.keyword-search .search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    color: #999;
}

/* Export Modal Specific Styles */
.export-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.export-option {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.export-option:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.export-option.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, #f0f4ff, #e3f2fd);
}

.export-option .icon {
    font-size: 32px;
    margin-bottom: 10px;
}

.export-option h4 {
    color: #1a1a2e;
    margin-bottom: 8px;
}

.export-option p {
    color: #666;
    font-size: 12px;
}

/* Compare Modal Specific Styles */
.comparison-results {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
}

.comparison-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.comparison-item:last-child {
    margin-bottom: 0;
}

.comparison-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #1a1a2e;
}

.comparison-value {
    font-weight: 600;
    color: #667eea;
}

/* Test Modal Specific Styles */
.test-results {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
}

.score-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.score-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.score-value {
    font-size: 24px;
    font-weight: bold;
    margin: 10px 0;
}

.score-label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.keyword-highlight {
    background: #fff9c4;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 500;
}

.keyword-highlight.positive {
    background: #c8e6c9;
    color: #2e7d32;
}

.keyword-highlight.negative {
    background: #ffcdd2;
    color: #c62828;
}

/* NEW: RAG Edit Modal Styles */
.rag-edit-options {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 30px 0;
    flex-wrap: wrap;
}

.rag-edit-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 20px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9fa;
    border: 2px solid transparent;
    width: 120px;
}

.rag-edit-option:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.rag-edit-option.selected {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}

.rag-edit-dot {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.rag-edit-dot.green { background: linear-gradient(135deg, #66bb6a, #43a047); }
.rag-edit-dot.yellow { background: linear-gradient(135deg, #ffee58, #fdd835); }
.rag-edit-dot.red { background: linear-gradient(135deg, #ef5350, #e53935); }

/* NEW: Test Company Input Section */
.test-company-input-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid #e9ecef;
}

.test-company-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.test-company-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 14px;
    transition: all 0.3s;
}

.test-company-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
}

.add-company-test-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, #42a5f5, #1e88e5);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
}

.add-company-test-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(66,165,245,0.4);
}

.test-companies-list {
    margin-top: 15px;
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.test-company-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 4px solid #42a5f5;
}

.test-company-item:last-child {
    margin-bottom: 0;
}

.test-company-name {
    font-weight: 600;
    color: #1a1a2e;
}

.test-company-keywords {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

.remove-test-company {
    background: #ef5350;
    color: white;
    border: none;
    border-radius: 6px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
}

.remove-test-company:hover {
    background: #e53935;
    transform: scale(1.1);
}

/* Enhanced responsive design for modals */
@media (max-width: 768px) {
    .modal {
        width: 98%;
        margin: 10px;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-header {
        padding: 15px 20px;
    }
    
    .modal-actions-sticky {
        padding: 15px 20px;
        flex-direction: column;
    }
    
    .sentiment-chart {
        grid-template-columns: 1fr;
    }
    
    .test-action-buttons {
        flex-direction: column;
    }
    
    .feature-grid,
    .keyword-categories,
    .export-options {
        grid-template-columns: 1fr;
    }
    
    .rag-edit-options {
        flex-direction: column;
        align-items: center;
    }
    
    .rag-edit-option {
        width: 100%;
        max-width: 200px;
    }
    
    .test-company-input-row {
        flex-direction: column;
    }
    
    .nav-bar {
        margin: 0 40px;
    }
    
    .scroll-arrow {
        width: 35px;
        height: 35px;
        font-size: 16px;
    }
    
    .keyword-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    
    .emotion-category-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .emotion-count {
        align-self: flex-start;
    }
}

/* Enhanced scrollbar for modal body */
.modal-body::-webkit-scrollbar {
    width: 6px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Scrollbar for keyword lists */
.keyword-list-container::-webkit-scrollbar {
    width: 6px;
}

.keyword-list-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.keyword-list-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.keyword-list-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* ENHANCED: Test Modal Additional Styles */
.sentiment-summary {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.chart-bar-details {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
    display: flex;
    justify-content: space-between;
}

.keyword-analysis-details {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.top-keyword-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    margin: 3px;
    transition: all 0.2s;
}

.top-keyword-tag.positive {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    color: #2e7d32;
    border: 1px solid #a5d6a7;
}

.top-keyword-tag.negative {
    background: linear-gradient(135deg, #ffebee, #ffcdd2);
    color: #c62828;
    border: 1px solid #ef9a9a;
}

.top-keyword-tag.neutral {
    background: linear-gradient(135deg, #f5f5f5, #eeeeee);
    color: #616161;
    border: 1px solid #e0e0e0;
}

.top-keyword-tag .score-badge {
    background: rgba(255,255,255,0.8);
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
}

/* ENHANCED: Import/Export Modal Styles */
.import-section {
    background: linear-gradient(135deg, #f0f4ff, #e3f2fd);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 2px solid #e0e0e0;
}

.import-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.import-option {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.import-option:hover {
    border-color: #42a5f5;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(66,165,245,0.2);
}

.import-option.selected {
    border-color: #42a5f5;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
}

.import-option .icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.import-option h4 {
    color: #1a1a2e;
    margin-bottom: 5px;
    font-size: 14px;
}

.import-option p {
    color: #666;
    font-size: 11px;
}

/* Enhanced keyword list styling */
.keyword-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.keyword-category {
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.keyword-category h4 {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    color: #1a1a2e;
    font-size: 16px;
}

/* Import/Export modal responsive design */
@media (max-width: 768px) {
    .import-options,
    .export-options {
        grid-template-columns: 1fr;
    }
    
    .sentiment-summary {
        padding: 15px;
    }
    
    .keyword-analysis-details > div {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
<div class="container">
  <div class="header"><h1>ğŸ“Š Sector Sentiment Analysis</h1></div>
  <div class="loading-bar"></div>
  
  <!-- Scrollable Navigation with Arrows -->
  <div class="nav-bar-container">
    <button class="scroll-arrow scroll-arrow-left" id="scrollLeft">â€¹</button>
    <div class="nav-bar" id="navBar">
      <button class="nav-btn active" data-sector="mylist"><span class="icon">ğŸ“‹</span><span class="tab-name">My List</span></button>
      <button class="nav-btn" data-sector="Semiconductor"><span class="icon">ğŸ’¾</span><span class="tab-name">Semiconductors</span></button>
      <button class="nav-btn" data-sector="Pharma"><span class="icon">ğŸ’Š</span><span class="tab-name">Pharma</span></button>
      <button class="nav-btn" data-sector="Electricity"><span class="icon">âš¡</span><span class="tab-name">Electricity</span></button>
      <button class="nav-btn" data-sector="Mining"><span class="icon">â›ï¸</span><span class="tab-name">Mining</span></button>
      <button class="nav-btn" data-sector="Automobile"><span class="icon">ğŸš—</span><span class="tab-name">Automobile</span></button>
      <button class="nav-btn" data-sector="Quantum"><span class="icon">âš›ï¸</span><span class="tab-name">Quantum</span></button>
      <button class="nav-btn" data-sector="Finance"><span class="icon">ğŸ’°</span><span class="tab-name">Finance</span></button>
      <button class="nav-btn" data-sector="Retail"><span class="icon">ğŸ›ï¸</span><span class="tab-name">Retail</span></button>
      <button class="nav-btn" data-sector="Technology"><span class="icon">ğŸ’»</span><span class="tab-name">Technology</span></button>
      <button class="add-tab-btn" id="addTabBtn">+</button>
    </div>
    <button class="scroll-arrow scroll-arrow-right" id="scrollRight">â€º</button>
  </div>

  <div class="main-content">
    <div class="sidebar">
      <div class="sidebar-box">
        <div class="sidebar-title">âš™ï¸ Analysis Parameters</div>
        
        <div class="analysis-section">
          <div class="analysis-header">
            <span class="analysis-icon">ğŸ”</span>
            <span class="analysis-label">Analysis Depth</span>
          </div>
          <select class="analysis-select" id="analysisDepth">
            <option value="basic">Basic Analysis</option>
            <option value="standard" selected>Standard Analysis</option>
            <option value="comprehensive">Comprehensive Analysis</option>
            <option value="advanced">Advanced Analysis</option>
          </select>
          
          <div class="analysis-header">
            <span class="analysis-icon">â±ï¸</span>
            <span class="analysis-label">Refresh Timer</span>
          </div>
          <select class="analysis-select" id="timerSelect">
            <option value="0">Off (Manual)</option>
            <option value="15">15 Minutes</option>
            <option value="30">30 Minutes</option>
            <option value="45">45 Minutes</option>
            <option value="60">60 Minutes</option>
          </select>
          
          <div style="position: relative; display: inline-block; width: 100%;">
            <button class="analyze-btn" id="analyzeBtn">
              <span class="icon">ğŸš€</span>
              <span>Analyze All</span>
            </button>
          </div>
          
          <div class="timer-display" id="timerDisplay">Ready</div>
          <div class="status-display" id="statusDisplay">Click analyze to start</div>
          
          <div class="timer-line-container" id="timerLineContainer">
            <div class="timer-text-small">
              <span>Auto-refresh</span>
              <span id="timerTextTime">00:00</span>
            </div>
            <div class="timer-line-track">
              <div class="timer-line-fill" id="timerLineFill"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Test Button -->
      <button class="test-btn" id="testBtn">
        <span class="icon">ğŸ§ª</span>
        <span>Calibrate</span>
      </button>
    </div>
    
    <div class="table-container">
      <!-- MyList Container Header with Edit Name and Action Buttons -->
      <div class="mylist-header" id="mylistHeader">
        <div class="mylist-title">
          <span>ğŸ”‘</span>
          <div class="mylist-name-edit">
            <span class="mylist-name-display" id="mylistNameDisplay">
              <span id="mylistNameText">My List</span>
              <div class="edit-icon-container">
                <span class="edit-icon">âœï¸</span>
              </div>
            </span>
            <input type="text" class="mylist-name-input" id="mylistNameInput" value="My List" style="display: none">
          </div>
        </div>
        <div class="mylist-actions">
          <button class="mylist-action-btn guide" id="guideBtn">
            <span class="icon">ğŸ“–</span>
            <span>Guide</span>
          </button>
          <button class="mylist-action-btn keyword" id="keywordRefBtn">
            <span class="icon">ğŸ”‘</span>
            <span>Keyword Reference</span>
          </button>
          <button class="mylist-action-btn export" id="exportBtn">
            <span class="icon">ğŸ“¤</span>
            <span>Export</span>
          </button>
          <button class="mylist-action-btn compare" id="compareBtn">
            <span class="icon">ğŸ“Š</span>
            <span>Compare</span>
          </button>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>No</th>
              <th>Companies</th>
              <th>Sector</th>
              <th><span class="emoji">ğŸ˜¢</span>Sad %</th>
              <th><span class="emoji">ğŸ˜</span>Neutral %</th>
              <th><span class="emoji">ğŸ˜Š</span>Happy %</th>
              <th><div class="rag-header"><span style="background:#e53935"></span><span style="background:#fdd835"></span><span style="background:#43a047"></span></div>RAG</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div class="add-row-btn" onclick="openModal()">
          <span style="font-size:20px">â•</span>
          <span>Add New Company</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2 id="modalTitle">âœ¨ Add Company</h2>
    <div class="form-group">
      <label>Company Name</label>
      <input type="text" id="companyName" placeholder="Enter company name...">
    </div>
    <div class="form-group">
      <label>Sector</label>
      <select id="sectorSelect">
        <option value="Semiconductor">ğŸ’¾ Semiconductor</option>
        <option value="Pharma">ğŸ’Š Pharma</option>
        <option value="Electricity">âš¡ Electricity</option>
        <option value="Mining">â›ï¸ Mining</option>
        <option value="Automobile">ğŸš— Automobile</option>
        <option value="Quantum">âš›ï¸ Quantum</option>
        <option value="Finance">ğŸ’° Finance</option>
        <option value="Retail">ğŸ›ï¸ Retail</option>
        <option value="Technology">ğŸ’» Technology</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-btn btn-save" onclick="saveCompany()">ğŸ’¾ Save</button>
    </div>
  </div>
</div>

<!-- Edit RAG Modal -->
<div class="modal-overlay" id="editRagModal" style="display: none;">
  <div class="modal edit-rag-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ¨</span> Edit RAG Status</h2>
      <button class="modal-close" onclick="closeEditRagModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Company</label>
        <input type="text" id="ragCompanyName" readonly style="background:#f5f5f5;">
      </div>
      
      <div class="form-group">
        <label>Select RAG Status</label>
        <div class="rag-edit-options">
          <div class="rag-edit-option" data-rag="red">
            <div class="rag-edit-dot red"></div>
            <span>Red</span>
          </div>
          <div class="rag-edit-option" data-rag="yellow">
            <div class="rag-edit-dot yellow"></div>
            <span>Yellow</span>
          </div>
          <div class="rag-edit-option" data-rag="green">
            <div class="rag-edit-dot green"></div>
            <span>Green</span>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label>Manual Sentiment Override (Optional)</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
          <div>
            <label style="font-size: 12px;">Sad %</label>
            <input type="number" id="manualSad" min="0" max="100" placeholder="0-100" style="text-align: center;">
          </div>
          <div>
            <label style="font-size: 12px;">Neutral %</label>
            <input type="number" id="manualNeutral" min="0" max="100" placeholder="0-100" style="text-align: center;">
          </div>
          <div>
            <label style="font-size: 12px;">Happy %</label>
            <input type="number" id="manualHappy" min="0" max="100" placeholder="0-100" style="text-align: center;">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeEditRagModal()">Cancel</button>
      <button class="modal-btn btn-save" onclick="saveRagEdit()">ğŸ’¾ Save Changes</button>
    </div>
  </div>
</div>

<!-- Add Tab Modal -->
<div class="modal-overlay" id="addTabModal" style="display: none;">
  <div class="modal add-tab-modal">
    <div class="modal-header">
      <h2><span class="icon">â•</span> Add New Tab</h2>
      <button class="modal-close" onclick="closeAddTabModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Tab Name</label>
        <input type="text" id="newTabName" placeholder="Enter tab name...">
      </div>
      
      <div class="form-group">
        <label>Tab Icon</label>
        <select id="newTabIcon" style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px;">
          <option value="ğŸ¢">ğŸ¢ Building</option>
          <option value="ğŸ­">ğŸ­ Factory</option>
          <option value="ğŸš€">ğŸš€ Rocket</option>
          <option value="ğŸ“±">ğŸ“± Mobile</option>
          <option value="ğŸ’">ğŸ’ Diamond</option>
          <option value="ğŸ”¬">ğŸ”¬ Science</option>
          <option value="ğŸŒ±">ğŸŒ± Plant</option>
          <option value="ğŸ›’">ğŸ›’ Shopping</option>
          <option value="ğŸ“ˆ">ğŸ“ˆ Chart</option>
          <option value="ğŸ¯">ğŸ¯ Target</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Background Color</label>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
          <div class="color-option" data-color="linear-gradient(135deg, #e3f2fd, #bbdefb)" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #e8f5e9, #c8e6c9)" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #fff3e0, #ffe0b2)" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #fbe9e7, #ffccbc)" style="background: linear-gradient(135deg, #fbe9e9, #ffccbc); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #f3e5f5, #e1bee7)" style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #e0f2f1, #b2dfdb)" style="background: linear-gradient(135deg, #e0f2f1, #b2dfdb); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #e8eaf6, #c5cae9)" style="background: linear-gradient(135deg, #e8eaf6, #c5cae9); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #fff8e1, #ffecb3)" style="background: linear-gradient(135deg, #fff8e1, #ffecb3); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeAddTabModal()">Cancel</button>
      <button class="modal-btn btn-save" onclick="createNewTab()">â• Create Tab</button>
    </div>
  </div>
</div>

<!-- ENHANCED: Test Analysis Modal with More Accurate Details -->
<div class="modal-overlay" id="testModal" style="display: none;">
  <div class="modal test-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ§ª</span> Text Sentiment Analysis Test</h2>
      <button class="modal-close" onclick="closeTestModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="guide-section">
        <h3><span class="icon">ğŸ“„</span> Editable Test Page</h3>
        <p>Type or paste text below to analyze its sentiment using keyword-based scoring:</p>
        
        <!-- Enhanced Company Input Section -->
        <div class="test-company-input-section">
          <h4><span class="icon">ğŸ¢</span> Add Company for Analysis</h4>
          <div class="test-company-input-row">
            <input type="text" 
                   class="test-company-input" 
                   id="testCompanyName" 
                   placeholder="Enter company name (e.g., Apple)">
            <button class="add-company-test-btn" onclick="addTestCompany()">
              <span class="icon">â•</span>
              <span>Add Company</span>
            </button>
          </div>
          
          <div class="test-companies-list" id="testCompaniesList">
            <!-- Test companies will be added here -->
            <div class="empty-state" style="text-align: center; color: #999; padding: 20px;">
              No companies added yet. Add a company to test sentiment analysis.
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Test Text Content</label>
          <textarea 
            id="testTextInput" 
            placeholder="Enter or paste text here for sentiment analysis..."
            rows="8"
            style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px; font-family: inherit; resize: vertical;"
          >NVIDIA continues to demonstrate strong innovation in AI and graphics technology. The company shows robust growth with high performance across multiple sectors. However, there are some concerns about market volatility and competition in certain areas. Overall, the benefits of their technology advancements outweigh the risks.</textarea>
        </div>
        
        <div class="test-action-buttons">
          <button class="modal-btn btn-cancel" onclick="closeTestModal()">Close</button>
          <button class="modal-btn btn-save" onclick="runSentimentTest()">
            <span class="icon">ğŸ§ª</span>
            Calibrate
          </button>
        </div>

        <!-- Enhanced Test Results Section -->
        <div id="testResultsSection" style="display: none;">
          <div class="chart-container">
            <div class="chart-title">ğŸ“Š Sentiment Analysis Results</div>
            
            <!-- Overall Sentiment Summary -->
            <div class="sentiment-summary">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                  <h4 style="margin: 0; color: #1a1a2e;">Overall Analysis</h4>
                  <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    <span id="analysisDetails">Analyzed <span id="wordCount">0</span> words with <span id="keywordCount">0</span> keywords detected</span>
                  </div>
                </div>
                <div id="overallSentimentBadge" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 14px;">
                  Loading...
                </div>
              </div>
              
              <!-- Confidence Score -->
              <div style="margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                  <span style="font-size: 12px; font-weight: 600; color: #555;">Confidence Score</span>
                  <span style="font-size: 12px; font-weight: 600; color: #667eea;" id="confidenceScore">0%</span>
                </div>
                <div style="width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
                  <div id="confidenceBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 3px; transition: width 0.5s;"></div>
                </div>
              </div>
            </div>
            
            <!-- Enhanced Sentiment Charts -->
            <div class="sentiment-chart">
              <div class="chart-bar">
                <div class="chart-bar-label">
                  <span>ğŸ˜Š Positive</span>
                  <span class="chart-bar-value" id="happyScoreValue">0%</span>
                </div>
                <div class="chart-bar-track">
                  <div class="chart-bar-fill happy" id="happyBar" style="width: 0%"></div>
                </div>
                <div class="chart-bar-details">
                  <span id="positiveKeywordCount">0 keywords</span>
                </div>
              </div>
              <div class="chart-bar">
                <div class="chart-bar-label">
                  <span>ğŸ˜¢ Negative</span>
                  <span class="chart-bar-value" id="sadScoreValue">0%</span>
                </div>
                <div class="chart-bar-track">
                  <div class="chart-bar-fill sad" id="sadBar" style="width: 0%"></div>
                </div>
                <div class="chart-bar-details">
                  <span id="negativeKeywordCount">0 keywords</span>
                </div>
              </div>
              <div class="chart-bar">
                <div class="chart-bar-label">
                  <span>ğŸ˜ Neutral</span>
                  <span class="chart-bar-value" id="neutralScoreValue">0%</span>
                </div>
                <div class="chart-bar-track">
                  <div class="chart-bar-fill neutral" id="neutralBar" style="width: 0%"></div>
                </div>
                <div class="chart-bar-details">
                  <span id="neutralKeywordCount">0 keywords</span>
                </div>
              </div>
            </div>
            
            <!-- Enhanced Pie Chart -->
            <div class="pie-chart-container">
              <div class="pie-chart" id="sentimentPieChart">
                <div class="pie-chart-center" id="pieChartCenter">0%</div>
              </div>
            </div>
            <div class="pie-legend" id="sentimentLegend">
              <div class="legend-item">
                <div class="legend-color happy"></div>
                <span>Positive (<span id="legendHappy">0%</span>)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color neutral"></div>
                <span>Neutral (<span id="legendNeutral">0%</span>)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color sad"></div>
                <span>Negative (<span id="legendSad">0%</span>)</span>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Company Test Results -->
          <div id="companyTestResults" style="margin-top: 20px;">
            <!-- Test results for each company will be added here -->
          </div>
          
          <!-- Keyword Analysis Details -->
          <div class="keyword-analysis-details">
            <div class="chart-container">
              <div class="chart-title">ğŸ” Keyword Analysis Details</div>
              
              <!-- Top Keywords -->
              <div style="margin-top: 15px;">
                <h4 style="margin-bottom: 10px; font-size: 16px; color: #1a1a2e;">Top Detected Keywords</h4>
                <div id="topKeywordsContainer" style="display: flex; flex-wrap: wrap; gap: 8px;">
                  <!-- Top keywords will be dynamically added -->
                </div>
              </div>
              
              <!-- Keyword Statistics -->
              <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                  <div style="font-size: 24px; font-weight: bold; color: #43a047;" id="totalPositiveKeywords">0</div>
                  <div style="font-size: 12px; color: #666;">Positive Keywords</div>
                </div>
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                  <div style="font-size: 24px; font-weight: bold; color: #ff9800;" id="totalNeutralKeywords">0</div>
                  <div style="font-size: 12px; color: #666;">Neutral Keywords</div>
                </div>
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                  <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="totalNegativeKeywords">0</div>
                  <div style="font-size: 12px; color: #666;">Negative Keywords</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Keyword Categories with Search -->
        <div class="keyword-categories" style="margin-top: 20px;">
          <div class="keyword-search" style="margin-bottom: 15px;">
            <input type="text" id="keywordSearchTest" placeholder="Search keywords in text..." style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px;">
          </div>
          
          <div class="keyword-category">
            <h4><span class="icon">ğŸ˜Š</span> Positive Keywords</h4>
            <div class="keyword-list" id="positiveKeywordsList">
              <!-- Positive keywords will be populated dynamically -->
            </div>
          </div>
          
          <div class="keyword-category">
            <h4><span class="icon">ğŸ˜¢</span> Negative Keywords</h4>
            <div class="keyword-list" id="negativeKeywordsList">
              <!-- Negative keywords will be populated dynamically -->
            </div>
          </div>
          
          <div class="keyword-category">
            <h4><span class="icon">ğŸ˜</span> Neutral Keywords</h4>
            <div class="keyword-list" id="neutralKeywordsList">
              <!-- Neutral keywords will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="clearTestResults()">Clear Results</button>
      <button class="modal-btn btn-save" onclick="saveTestToCompany()">
        <span class="icon">ğŸ’¾</span>
        <span>Save to Main List</span>
      </button>
    </div>
  </div>
</div>

<!-- Edit Keyword Modal -->
<!-- Edit Keyword Modal - Fixed Structure -->
<!-- Edit Keyword Modal - FIXED STRUCTURE -->
<div class="modal-overlay" id="editKeywordModalOverlay" style="display: none;">
  <div class="modal edit-keyword-modal">
    <div class="modal-header">
      <h2><span class="icon">âœï¸</span> Edit Keyword</h2>
      <button class="modal-close" onclick="closeEditKeywordModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="edit-keyword-header">
        <span class="emoji" id="currentEmotionEmoji">ğŸ˜Š</span>
        <span class="title" id="editModalTitle">Edit Keyword</span>
      </div>
      
      <div class="keyword-to-edit" id="keywordToEdit">
        <!-- Keyword will be populated here -->
      </div>
      
      <div class="form-group">
        <label>Emotion Category</label>
        <div class="emotion-select-buttons">
          <button class="emotion-select-btn happy" data-emotion="happy" onclick="selectEmotion('happy')">
            <span class="icon">ğŸ˜Š</span>
            <span>Happy</span>
          </button>
          <button class="emotion-select-btn neutral" data-emotion="neutral" onclick="selectEmotion('neutral')">
            <span class="icon">ğŸ˜</span>
            <span>Neutral</span>
          </button>
          <button class="emotion-select-btn sad" data-emotion="sad" onclick="selectEmotion('sad')">
            <span class="icon">ğŸ˜¢</span>
            <span>Sad</span>
          </button>
        </div>
      </div>
      
      <div class="score-weight-container">
        <div class="score-weight-label">
          <span>Score Weight</span>
          <span class="score-weight-value" id="scoreWeightValue">5</span>
        </div>
        <input type="range" 
               min="1" 
               max="10" 
               value="5" 
               class="score-slider" 
               id="scoreWeightSlider"
               oninput="updateScoreWeightValue(this.value)">
        <div class="score-ticks">
          <span>1 (Low)</span>
          <span>5 (Medium)</span>
          <span>10 (High)</span>
        </div>
      </div>
      
      <div class="danger-zone">
        <h4><span class="icon">âš ï¸</span> Danger Zone</h4>
        <p>Deleting this keyword will remove it from all analyses. This action cannot be undone.</p>
        <button class="modal-btn btn-danger" onclick="confirmDeleteKeyword()" style="width: 100%;">
          <span class="icon">ğŸ—‘ï¸</span>
          <span>Delete Keyword</span>
        </button>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeEditKeywordModal()">Cancel</button>
      <button class="modal-btn btn-save" onclick="saveKeywordEdit()">
        <span class="icon">ğŸ’¾</span>
        <span>Save Changes</span>
      </button>
    </div>
  </div>
</div>

<!-- Enhanced Keyword Reference Modal - EDIT FUNCTIONALITY REMOVED -->
<div class="modal-overlay" id="keywordModal" style="display: none;">
  <div class="modal keyword-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ”‘</span> Keyword Reference Guide</h2>
      <button class="modal-close" onclick="closeKeywordModal()">Ã—</button>
    </div>
    
    <!-- Emotion Tabs Navigation -->
    <div class="keyword-tabs-nav">
      <button class="keyword-tab-btn active" data-emotion="all" onclick="filterKeywordsByEmotion('all')">
        <span class="icon">ğŸ“Š</span>
        <span>All Keywords</span>
        <span class="keyword-count-badge" id="allKeywordCount">0</span>
      </button>
      <button class="keyword-tab-btn" data-emotion="happy" onclick="filterKeywordsByEmotion('happy')">
        <span class="icon">ğŸ˜Š</span>
        <span>Happy</span>
        <span class="keyword-count-badge" id="happyKeywordCount">0</span>
      </button>
      <button class="keyword-tab-btn" data-emotion="neutral" onclick="filterKeywordsByEmotion('neutral')">
        <span class="icon">ğŸ˜</span>
        <span>Neutral</span>
        <span class="keyword-count-badge" id="neutralKeywordCount">0</span>
      </button>
      <button class="keyword-tab-btn" data-emotion="sad" onclick="filterKeywordsByEmotion('sad')">
        <span class="icon">ğŸ˜¢</span>
        <span>Sad</span>
        <span class="keyword-count-badge" id="sadKeywordCount">0</span>
      </button>
    </div>
    
    <div class="keyword-modal-body">
      <div class="keyword-search">
        <input type="text" id="keywordSearch" placeholder="Search keywords...">
        <span class="search-icon">ğŸ”</span>
      </div>
      
      <!-- Keywords Container with Individual Boxes -->
      <div class="keywords-container" id="keywordsContainer">
        <!-- Keywords will be populated by JavaScript -->
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeKeywordModal()">Close</button>
      <button class="modal-btn btn-save" onclick="copyAllKeywords()">
        <span class="icon">ğŸ“‹</span>
        <span>Copy All Keywords</span>
      </button>
    </div>
  </div>
</div>

<!-- REMOVED: Edit Keyword Dialog deleted -->

<!-- Guide Modal -->
<div class="modal-overlay" id="guideModal" style="display: none;">
  <div class="modal guide-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ“–</span> User Guide</h2>
      <button class="modal-close" onclick="closeGuideModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="guide-section">
        <h3><span class="icon">ğŸ¯</span> How to Use This Tool</h3>
        <p>This Sector Sentiment Analysis tool helps you analyze company sentiment based on keywords found in news, reports, and other text sources.</p>
        
        <div class="feature-grid">
          <div class="feature-card">
            <h4>ğŸ“Š Add Companies</h4>
            <ul>
              <li>Click "Add New Company" at the bottom of the table</li>
              <li>Enter company name and select sector</li>
              <li>Companies will appear in your list</li>
            </ul>
          </div>
          
          <div class="feature-card">
            <h4>ğŸš€ Analyze Sentiment</h4>
            <ul>
              <li>Click "Analyze All" to process all companies</li>
              <li>Each analysis takes about 12 seconds</li>
              <li>Results show Sad, Neutral, and Happy percentages</li>
            </ul>
          </div>
          
          <div class="feature-card">
            <h4>ğŸ¨ RAG Status</h4>
            <ul>
              <li>Green: Positive sentiment (â‰¥70% Happy)</li>
              <li>Yellow: Mixed sentiment</li>
              <li>Red: Negative sentiment (â‰¥70% Sad)</li>
              <li>Click RAG dots to manually edit</li>
            </ul>
          </div>
          
          <div class="feature-card">
            <h4>ğŸ”§ Advanced Features</h4>
            <ul>
              <li>Create custom tabs for different sectors</li>
              <li>Test text sentiment in the Test modal</li>
              <li>Export data to CSV format</li>
              <li>Compare company performances</li>
            </ul>
          </div>
        </div>
        
        <h3><span class="icon">ğŸ“ˆ</span> Understanding the Analysis</h3>
        <p>The tool uses a keyword-based scoring system to determine sentiment. Keywords are categorized as Happy, Neutral, or Sad based on their emotional tone.</p>
        <p>RAG (Red-Amber-Green) status provides a quick visual indicator of overall sentiment. You can override the automatic RAG assessment by clicking on the RAG dot and manually setting the status.</p>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeGuideModal()">Close</button>
      <button class="modal-btn btn-save" onclick="showQuickStart()">
        <span class="icon">ğŸš€</span>
        <span>Quick Start Demo</span>
      </button>
    </div>
  </div>
</div>


<!-- ENHANCED: Export Modal with Import and Update Options -->
<div class="modal-overlay" id="exportModal" style="display: none;">
  <div class="modal export-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ“¤</span> Export & Import Data</h2>
      <button class="modal-close" onclick="closeExportModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="guide-section">
        <!-- Import Section -->
        <div style="margin-bottom: 30px;">
          <h3><span class="icon">ğŸ“¥</span> Import Data</h3>
          <p>Import company data from CSV or JSON files:</p>
          
          <div class="import-section">
            <div class="import-options">
  <div class="import-option" data-format="csv" onclick="selectImportOption('csv')">
    <div class="icon">ğŸ“„</div>
    <h4>CSV File</h4>
    <p>Import data from CSV format</p>
  </div>
  
  <div class="import-option" data-format="json" onclick="selectImportOption('json')">
    <div class="icon">ğŸ”§</div>
    <h4>JSON Format</h4>
    <p>Import structured JSON data</p>
  </div>
</div>
            
            <div style="margin-top: 20px;">
              <input type="file" id="importFile" accept=".csv,.json,.txt" style="display: none;" onchange="handleFileImport()">
              <button class="modal-btn" onclick="document.getElementById('importFile').click()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #42a5f5, #1e88e5); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                <span class="icon">ğŸ“</span>
                <span>Choose File to Import</span>
              </button>
              <div id="selectedFileName" style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;"></div>
            </div>
            
            <!-- Import Options -->
            <div style="margin-top: 20px;">
              <h4 style="font-size: 14px; margin-bottom: 10px;">Import Options</h4>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                  <input type="radio" name="importMode" value="add" checked> Add New Only
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                  <input type="radio" name="importMode" value="update"> Update Existing
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                  <input type="radio" name="importMode" value="replace"> Replace All
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                  <input type="checkbox" id="importWithScores" checked> Keep Sentiment Scores
                </label>
              </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
              <button class="modal-btn btn-cancel" onclick="clearImport()" style="flex: 1;">
                Clear
              </button>
              <button class="modal-btn btn-save" onclick="performImport()" style="flex: 1;">
                <span class="icon">ğŸ“¥</span>
                Import Data
              </button>
            </div>
          </div>
        </div>
        
        <!-- Export Section -->
        <div style="border-top: 1px solid #e9ecef; padding-top: 20px;">
          <h3><span class="icon">ğŸ“¤</span> Export Data</h3>
          <p>Choose how you want to export your sentiment analysis data:</p>
          
          <div class="export-options">
  <div class="export-option" data-format="csv" onclick="selectExportOption('csv')">
    <div class="icon">ğŸ“„</div>
    <h4>CSV File</h4>
    <p>Comma-separated values, compatible with Excel and data analysis tools</p>
  </div>
  
  <div class="export-option" data-format="json" onclick="selectExportOption('json')">
    <div class="icon">ğŸ”§</div>
    <h4>JSON Format</h4>
    <p>Structured data format for developers and API integration</p>
  </div>
  
  <div class="export-option" data-format="pdf" onclick="selectExportOption('pdf')">
    <div class="icon">ğŸ“Š</div>
    <h4>PDF Report</h4>
    <p>Formatted report with charts and analysis summary</p>
  </div>
  
  <div class="export-option" data-format="excel" onclick="selectExportOption('excel')">
    <div class="icon">ğŸ“ˆ</div>
    <h4>Excel File</h4>
    <p>Formatted Excel spreadsheet with styling and charts</p>
  </div>
</div>
          
          <div class="form-group" style="margin-top: 20px;">
            <label>Export Scope</label>
            <select id="exportScope" style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px;">
              <option value="current">Current Tab Only</option>
              <option value="all">All Companies</option>
              <option value="analyzed">Only Analyzed Companies</option>
              <option value="custom">Custom Selection</option>
            </select>
          </div>
          
          <!-- Export Options -->
          <div style="margin-top: 20px;">
            <h4 style="font-size: 14px; margin-bottom: 10px;">Export Options</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <input type="checkbox" id="includeRAG" checked> Include RAG Status
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <input type="checkbox" id="includeTimestamps" checked> Include Timestamps
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <input type="checkbox" id="includeMetadata" checked> Include Metadata
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <input type="checkbox" id="formatNumbers"> Format Numbers
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeExportModal()">Cancel</button>
      <button class="modal-btn btn-save" onclick="performExport()">
        <span class="icon">ğŸ“¥</span>
        <span>Export Now</span>
      </button>
    </div>
  </div>
</div>

<!-- Compare Modal -->
<div class="modal-overlay" id="compareModal" style="display: none;">
  <div class="modal compare-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ“Š</span> Compare Companies</h2>
      <button class="modal-close" onclick="closeCompareModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="guide-section">
        <h3><span class="icon">âš–ï¸</span> Performance Comparison</h3>
        <p>Analysis of your company list based on sentiment scores:</p>
        
        <div class="comparison-results">
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">ğŸ“Š</span>
              <span>Total Companies</span>
            </div>
            <div class="comparison-value" id="totalCompanies">0</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">âœ…</span>
              <span>Analyzed Companies</span>
            </div>
            <div class="comparison-value" id="analyzedCompanies">0</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">ğŸ˜Š</span>
              <span>Average Happy Score</span>
            </div>
            <div class="comparison-value" id="avgSentiment">0%</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">ğŸ†</span>
              <span>Most Positive Company</span>
            </div>
            <div class="comparison-value" id="happiestCompany">None</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">âš ï¸</span>
              <span>Most Negative Company</span>
            </div>
            <div class="comparison-value" id="saddestCompany">None</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">âš–ï¸</span>
              <span>Most Balanced Company</span>
            </div>
            <div class="comparison-value" id="mostBalancedCompany">None</div>
          </div>
        </div>
        
        <div style="margin-top: 30px;">
          <h4><span class="icon">ğŸ“ˆ</span> Sector Distribution</h4>
          <div id="sectorDistribution" style="background: #f8f9fa; border-radius: 12px; padding: 15px; margin-top: 10px;">
            <!-- Sector distribution will be populated dynamically -->
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeCompareModal()">Close</button>
      <button class="modal-btn btn-save" onclick="exportComparison()">
        <span class="icon">ğŸ“¤</span>
        <span>Export Comparison</span>
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast">âœ… Action completed successfully!</div>
<script>
const API_URL = window.location.origin;
let currentEditKeyword = null;
let currentEditEmotion = null;
let selectedEditEmotion = null;
let currentKeywordFilter = 'all';

// Emotions data - this is your provided keyword data
const emotions = {
    'happy': {
        'keywords': [
            'ability to attract', 'abundant', 'absolutely', 'accessible', 'acclaimed', 
            'accommodative', 'achievement', 'admire', 'adore', 'adulation', 'advance', 
            'advanced', 'advancing', 'amazing', 'approve', 'arousing', 'assure', 
            'attentive', 'attractive', 'awe-inspiring', 'awesome', 'beaming', 
            'beloved', 'beneficial', 'best', 'bold', 'booming', 'brainy', 'breakthrough', 
            'breath-taking', 'bright', 'bright future', 'brilliant', 'buoyant', 
            'celebration', 'centered', 'champion', 'charming', 'cheerful', 'clever', 
            'confidence', 'confident', 'constant', 'courage', 'courageous', 
            'delectable', 'definite', 'delightful', 'dependable', 'developing', 
            'dignified', 'divine', 'doing well', 'dynamite', 'eager', 'earnings growth', 
            'ecstatic', 'efficient', 'efficient use of assets', 'electrifying', 
            'employable', 'empowered', 'endearing', 'enjoyable', 'enriching', 
            'enthusiastic', 'enticing', 'especial', 'exceptional', 'exciting', 
            'exhilarating', 'exponential', 'exquisite', 'extraordinary', 
            'extraordinary good', 'exultant', 'fabulous', 'fascinating', 'favorite', 
            'fearless', 'fetching', 'financial stability', 'finest', 'flourishing', 
            'gallant', 'generous', 'generously', 'genuine', 'gleaming', 'goal-oriented', 
            'godawful', 'good future', 'good judgment', 'good perception', 'good quarter', 
            'good report', 'great', 'greatest', 'growing', 'growing revenue', 'growth', 
            'growth potential', 'gumptious', 'happiness', 'happy', 'healthy cash balance', 
            'high achievement', 'high investment motivation', 'high market share', 
            'high outcomes', 'high potential', 'high profit margin', 'high reward', 
            'highest', 'highest quality', 'highly recommend', 'highly recommended', 
            'ideal', 'imaginative', 'impressively', 'impressive', 'increased', 
            'increased net income', 'increase in value', 'increase share value', 
            'increase stock value', 'increasing', 'incredible', 'innovative', 
            'insightful', 'inspiring', 'instinctive', 'intellectual', 'irreplaceable', 
            'irresistible', 'jolly', 'jovial', 'joyful', 'joysome', 'judicious', 
            'just', 'keen', 'knowledgeable', 'lambent', 'laudable', 'leading', 
            'leading ahead', 'legendary', 'likable', 'lively', 'low debt-to-equity', 
            'luminous', 'magical', 'magnetic', 'magnificent', 'majestic', 'making headway', 
            'making progress', 'marvelous', 'masterful', 'meagre', 'miraculous', 
            'mindful', 'motivated', 'moving up', 'new products', 'numinous', 'on the increase', 
            'on the rise', 'on-target', 'optimistic', 'orderly', 'organized', 
            'out-of-this-world', 'outstanding', 'overjoyed', 'paramount', 'perceptive', 
            'persistent', 'persuasive', 'phenomenal', 'piquant', 'pleasurable', 
            'poise', 'polished', 'positive', 'positive achievement', 'positive future', 
            'positive outcomes', 'positive quarter', 'positive return', 'powerful', 
            'praiseworthy', 'praise', 'proactive', 'productive', 'profit', 
            'profitable', 'projected price increase', 'prominent', 'promising', 
            'prompt', 'prospering', 'proud', 'punctual', 'quick-witted', 'radiant', 
            'rallying', 'rapturous', 'rational', 'razor-sharp', 'reassuring', 
            'recherche', 'record high', 'refulgent', 'rejoicing', 'reliable', 
            'remarkable', 'remarkably', 'resilient', 'resourceful', 'respectable', 
            'return on assets', 'revolutionary', 'rewarding', 'righteous', 'rising', 
            'rising return on equity', 'sagacious', 'savvy', 'sensational', 
            'sensationally', 'shrewd', 'sincere', 'skilled', 'smart', 'sound judgment', 
            'spellbinding', 'spirited', 'spunky', 'steadfast', 'stellar', 'stimulating', 
            'strong bottom-line', 'strong growth', 'strong profitability', 'struggling', 
            'struggles', 'succeeding', 'success', 'successful', 'supreme', 'surge', 
            'surprising', 'surprisingly', 'systematic', 'teeming', 'tenacious', 
            'thriving', 'trailblazing', 'transcendental', 'triumph', 'tubular', 
            'upbeat', 'uplifting', 'upstanding', 'valiant', 'very clever', 
            'very profitable', 'very successful', 'vibrant', 'victorious', 'victory', 
            'vigor', 'vigorous', 'visionary', 'vivacious', 'well-informed', 'win', 
            'winner', 'winners', 'wins', 'wise', 'worthy', 'worthy of praise'
        ].sort(),
        'emoji': 'ğŸ˜Š'
    },
    'neutral': {
        'keywords': [
            'according', 'analyst call', 'annual general meeting', 'annual report', 
            'announced', 'announcement', 'anticipated data', 'audit report', 
            'balance sheet', 'board meeting', 'business', 'business update', 
            'cautionary statement', 'company update', 'compliance report', 
            'conference', 'conference call', 'cookie policy', 'corporate announcement', 
            'data', 'disclaimer', 'downtime notification', 'earnings', 'earnings call', 
            'economic data', 'emergency maintenance', 'estimated figures', 
            'expected report', 'extraordinary meeting', 'final results', 
            'financial', 'financial results', 'financial statement', 'financial update', 
            'formal announcement', 'forward looking statement', 'government data', 
            'industry news', 'industry report', 'information', 'interim report', 
            'investor presentation', 'launch', 'legal notice', 'management discussion', 
            'market analysis', 'market announcement', 'market update', 'material information', 
            'media release', 'meeting', 'meeting minutes', 'non-material information', 
            'official communication', 'official statement', 'operational update', 
            'outlook statement', 'performance review', 'planned outage', 'planned release', 
            'preliminary results', 'press conference', 'press release', 'price sensitive information', 
            'privacy policy', 'product update', 'projected results', 'proxy statement', 
            'public statement', 'quarterly', 'quarterly report', 'regulatory filing', 
            'regulatory news', 'regulatory update', 'release', 'reported', 'reports', 
            'revised figures', 'risk factors', 'routine maintenance', 'routine update', 
            'scheduled announcement', 'scheduled downtime', 'sector update', 
            'service announcement', 'service interruption', 'shareholder meeting', 
            'shareholder vote', 'special meeting', 'statement', 'statistical release', 
            'strategic update', 'system maintenance', 'technical update', 'terms and conditions', 
            'trading update', 'unplanned outage', 'unscheduled downtime', 'update', 
            'updated guidance', 'updates', 'website update'
        ].sort(),
        'emoji': 'ğŸ˜'
    },
    'sad': {
        'keywords': [
            'abate', 'abysmal', 'accounting discrepancies', 'administration', 
            'adverse', 'alarming', 'annoy', 'anxious', 'apathy', 'appalling', 
            'atrocious', 'awful', 'bad', 'bad assets', 'bankrupt', 'battle', 
            'belligerent', 'below', 'below expectation', 'bemoan', 'beneath', 
            'blame', 'boring', 'broken', 'cash-strapped', 'cheap', 'chronic', 
            'closed', 'collapse', 'conflict', 'confront', 'contrary', 'contradictory', 
            'corrosive', 'corrupt', 'criminal', 'crummy', 'curtail', 'curtailment', 
            'cut', 'cutback', 'cutting', 'damage', 'damaging', 'dangerous', 
            'dead', 'death', 'deaths', 'debts', 'decaying', 'decrease', 'decreased', 
            'decreasing', 'defective', 'deficient', 'deficiency', 'deformed', 
            'dejected', 'deleterious', 'deny', 'depressed', 'deprived', 'destroy', 
            'destructive', 'detrimental', 'diabolical', 'difficult', 'diminish', 
            'diminished', 'dirty', 'disadvantageous', 'disagreeable', 'disappointed', 
            'disastrous', 'disgusting', 'disheveled', 'dishonest', 'dishonorable', 
            'dismal', 'disobedient', "don't", 'downside', 'dreary', 'dreadful', 
            'drop', 'dwindle', 'dwindling', 'ebb', 'egregious', 'enraged', 'eroding', 
            'evil', 'execrable', 'fail', 'failing', 'fall', 'falling', 'falling market share', 
            'falling off', 'faulty', 'fear', 'feeble', 'fight', 'filthy', 'financial distress', 
            'financial trouble', 'fired', 'flop', 'foul', 'frighten', 'frightful', 
            'gawky', 'ghastly', 'going concern warning', 'grave', 'greed', 'grim', 
            'grimace', 'gross', 'grotesque', 'gruesome', 'guilty', 'haggard', 
            'harmful', 'hate', 'headwinds', 'hideous', 'high debt', 'high debt levels', 
            'high overheads', 'hopeless', 'horrendous', 'horrible', 'hostile', 
            'hurt', 'hurtful', 'ignorant', 'ignore', 'ill', 'immature', 'imminent failure', 
            'immoral', 'imperfect', 'impossible', 'inability', 'inadequate', 
            'inane', 'inappropriate', 'inauspicious', 'incompetent', 'ineffectual', 
            'inefficient', 'inelegant', 'inept', 'inexpert', 'inferior', 'infernal', 
            'injure', 'injurious', 'inimical', 'insane', 'insipid', 'insidious', 
            'insolvency', 'insolvent', 'interest payments', 'jealous', 'junk', 
            'junky', 'lack of innovation', 'lamentable', 'laughable', 'layoffs', 
            'legal dispute', 'legal disputes', 'legal issues', 'legal issues', 
            'lessen', 'lessening', 'liabilities', 'life-threatening', 'lose', 
            'losing', 'losing money', 'loss', 'lousy', 'low', 'low growth', 
            'low margin', 'low order book', 'low revenue', 'low sales', 'low turnover', 
            'lower', 'lowering', 'lumpy', 'malicious', 'market value decline', 
            'menacing', 'messy', 'mischievous', 'miserable', 'misshapen', 'missing', 
            'misunderstood', 'monstrous', 'naÃ¯ve', 'nasty', 'naughty', 'negative', 
            'negative cash flow', 'negative financial state', 'negative order book', 
            'negate', 'neglect', 'never', 'nondescript', 'nonsense', 'not to par', 
            'not up to scratch', 'noxious', 'objectionable', 'obliterate', 
            'obliterated', 'odious', 'offensive', 'oppressive', 'outstanding debts', 
            'pain', 'parlous', 'pathetic', 'pessimistic', 'perturb', 'petty', 
            'pitiful', 'poisonous', 'poor', 'poor credit control', 'poor credit ratings', 
            'poor report', 'poor reports', 'prejudice', 'product call back', 
            'product call backs', 'questionable', 'quit', 'reduce', 'reducing', 
            'reducing orders', 'reduction', 'redundancies', 'regrettable', 'reject', 
            'renege', 'repellant', 'repugnant', 'repulsive', 'revenge', 'revolting', 
            'rocky', 'rotten', 'rubbish', 'rude', 'ruinous', 'sacking', 'sad', 
            'scanty', 'second-class', 'second-rate', 'severe', 'severe financial trouble', 
            'serious decline', 'shoddy', 'shocking', 'shrink', 'shrinking', 'shutdown', 
            'significant drop', 'slow economic growth', 'stagflation', 'struggling', 
            'struggles', 'subdued', 'subside', 'substandard', 'suffering', 'substandard', 
            'terrible', 'terrifying', 'third-rate', 'threatening', 'tragedy', 
            'troubled', 'unacceptable', 'unfavourable', 'unfavorable', 'unfortunate', 
            'unhealthy', 'unlucky', 'unpleasant', 'unprofitable', 'unsatisfactory', 
            'unsuitable', 'unskilled', 'unwelcome', 'unpropitious', 'untoward', 
            'useless', 'vulnerable', 'wane', 'weak leadership', 'weak management', 
            'worthless', 'wretched', 'wrong', 'wipe out'
        ].sort(),
        'emoji': 'ğŸ˜¢'
    }
};

// Expanded Dummy Data with new sectors
let companies = [
  {name:"Nvidia",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"Pfizer",sector:"Pharma",sad:null,neutral:null,happy:null},
  {name:"Broadcom",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"NextEra Energy",sector:"Electricity",sad:null,neutral:null,happy:null},
  {name:"TSMC",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"Tesla",sector:"Automobile",sad:null,neutral:null,happy:null},
  {name:"Samsung",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"Rio Tinto",sector:"Mining",sad:null,neutral:null,happy:null},
  {name:"IonQ",sector:"Quantum",sad:null,neutral:null,happy:null},
  {name:"AMD",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"JPMorgan Chase",sector:"Finance",sad:null,neutral:null,happy:null},
  {name:"Walmart",sector:"Retail",sad:null,neutral:null,happy:null},
  {name:"Microsoft",sector:"Technology",sad:null,neutral:null,happy:null},
  {name:"Goldman Sachs",sector:"Finance",sad:null,neutral:null,happy:null},
  {name:"Amazon",sector:"Retail",sad:null,neutral:null,happy:null},
  {name:"Apple",sector:"Technology",sad:null,neutral:null,happy:null}
];

// Test companies storage
let testCompanies = [];
let testResults = {};

let editIndex = -1;
let analysisInProgress = false;
let refreshInterval = null;
let currentSector = 'mylist'; // Default tab
let currentRagEditIndex = -1; // Track which company's RAG we're editing
let selectedExportFormat = 'csv'; // Default export format
let selectedFile = null;
let selectedImportFormat = 'csv';

// Enhanced tab names with new sectors and custom tabs
let tabNames = {
  'mylist': 'My List',
  'Semiconductor': 'Semiconductors',
  'Pharma': 'Pharma',
  'Electricity': 'Electricity',
  'Mining': 'Mining',
  'Automobile': 'Automobile',
  'Quantum': 'Quantum',
  'Finance': 'Finance',
  'Retail': 'Retail',
  'Technology': 'Technology'
};

// Custom tabs storage
let customTabs = [];

// Countdown timer variables
let countdownInterval = null;
let estimatedTimeRemaining = 0;
const TIME_PER_COMPANY = 11.69; // seconds per company

function getRAG(sad, happy, company = null) {
  // Check for manual RAG override
  if (company && company.ragOverride) {
    return company.ragOverride;
  }
  
  if (sad === null || happy === null) return '';
  if (happy >= 70) return 'green';
  if (sad >= 70) return 'red';
  return 'yellow';
}
// Add this debug function to check if modal elements exist
function debugModalIssues() {
  console.log("Checking modal elements...");
  console.log("editKeywordModalOverlay exists:", document.getElementById('editKeywordModalOverlay') ? "YES" : "NO");
  console.log("editKeywordModal exists:", document.getElementById('editKeywordModal') ? "YES" : "NO");
  
  // Check if there are multiple elements with similar IDs
  const allElements = document.querySelectorAll('[id*="editKeyword"]');
  console.log("All elements with 'editKeyword' in ID:", allElements.length);
  allElements.forEach(el => console.log("  -", el.id));
}

// Call this in your DOMContentLoaded or when testing
// debugModalIssues();

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// Function to calculate total analysis time
// Function to calculate total analysis time for current tab
function calculateTotalAnalysisTime() {
  let companiesToAnalyze = [];
  
  if (currentSector === 'mylist') {
    companiesToAnalyze = companies;
  } else {
    companiesToAnalyze = companies.filter(c => c.sector === currentSector);
  }
  
  const totalCompanies = companiesToAnalyze.length;
  return Math.round(totalCompanies * TIME_PER_COMPANY); // Total seconds
}

// Open edit keyword modal - FIXED
// Open edit keyword modal - UPDATED VERSION
function editKeyword(keyword, emotion) {
    console.log("editKeyword called with:", keyword, emotion); // Debug
    
    // Unescape the keyword
    const unescapedKeyword = keyword.replace(/\\'/g, "'").replace(/\\"/g, '"');
    
    currentEditKeyword = unescapedKeyword;
    currentEditEmotion = emotion;
    selectedEditEmotion = emotion;
    
    // Update modal content
    document.getElementById('keywordToEdit').textContent = unescapedKeyword;
    document.getElementById('editModalTitle').textContent = `Edit "${unescapedKeyword}"`;
    
    // Set current emotion
    const emoji = emotions[emotion].emoji;
    document.getElementById('currentEmotionEmoji').textContent = emoji;
    
    // Update emotion selection
    document.querySelectorAll('.emotion-select-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.getAttribute('data-emotion') === emotion) {
            btn.classList.add('selected');
        }
    });
    
    // Reset score weight to default 5
    document.getElementById('scoreWeightSlider').value = 5;
    document.getElementById('scoreWeightValue').textContent = '5';
    
    // Show modal - IMPORTANT: Use correct ID
    const modal = document.getElementById('editKeywordModalOverlay');
    if (modal) {
        modal.style.display = 'flex';
        console.log("Modal displayed successfully");
    } else {
        console.error("Modal not found! ID: editKeywordModalOverlay");
        // Fallback: try to find any edit modal
        const fallbackModal = document.querySelector('.modal-overlay[id*="edit"]');
        if (fallbackModal) {
            fallbackModal.style.display = 'flex';
            console.log("Used fallback modal:", fallbackModal.id);
        }
    }
}

// Close edit keyword modal - UPDATED VERSION
function closeEditKeywordModal() {
    const modal = document.getElementById('editKeywordModalOverlay');
    if (modal) {
        modal.style.display = 'none';
    }
    currentEditKeyword = null;
    currentEditEmotion = null;
    selectedEditEmotion = null;
}

// Select emotion in edit modal
function selectEmotion(emotion) {
    selectedEditEmotion = emotion;
    
    // Update UI
    document.querySelectorAll('.emotion-select-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.getAttribute('data-emotion') === emotion) {
            btn.classList.add('selected');
        }
    });
    
    // Update emoji
    const emoji = emotions[emotion].emoji;
    document.getElementById('currentEmotionEmoji').textContent = emoji;
}

// Update score weight display
function updateScoreWeightValue(value) {
    document.getElementById('scoreWeightValue').textContent = value;
}

// Save keyword edit
function saveKeywordEdit() {
    if (!currentEditKeyword || !selectedEditEmotion) return;
    
    // Check if emotion changed
    if (currentEditEmotion !== selectedEditEmotion) {
        // Remove from old emotion category
        const oldIndex = emotions[currentEditEmotion].keywords.indexOf(currentEditKeyword);
        if (oldIndex !== -1) {
            emotions[currentEditEmotion].keywords.splice(oldIndex, 1);
        }
        
        // Add to new emotion category
        if (!emotions[selectedEditEmotion].keywords.includes(currentEditKeyword)) {
            emotions[selectedEditEmotion].keywords.push(currentEditKeyword);
            emotions[selectedEditEmotion].keywords.sort();
        }
        
        // Update currentEditEmotion
        currentEditEmotion = selectedEditEmotion;
    }
    
    // Get score weight (for future use if you want to implement weighted scoring)
    const scoreWeight = parseInt(document.getElementById('scoreWeightSlider').value);
    
    // Save to localStorage for persistence (optional)
    saveEmotionsToLocalStorage();
    
    // Refresh the keyword modal
    populateKeywordModal();
    
    // Close modal
    closeEditKeywordModal();
    
    showToast('âœ… Keyword updated successfully!');
}

// Delete keyword with confirmation
function deleteKeyword(keyword, emotion) {
    // Unescape the keyword for display
    const displayKeyword = keyword.replace(/\\'/g, "'").replace(/\\"/g, '"');
    
    if (confirm(`Are you sure you want to delete the keyword "${displayKeyword}"? This action cannot be undone.`)) {
        // Use the original keyword (unescaped) for searching
        const originalKeyword = keyword.replace(/\\'/g, "'").replace(/\\"/g, '"');
        const emotionIndex = emotions[emotion].keywords.indexOf(originalKeyword);
        if (emotionIndex !== -1) {
            emotions[emotion].keywords.splice(emotionIndex, 1);
            
            // Save to localStorage for persistence
            saveEmotionsToLocalStorage();
            
            // Refresh the keyword modal
            populateKeywordModal();
            
            showToast('ğŸ—‘ï¸ Keyword deleted successfully!');
        }
    }
}

// Confirm delete from edit modal
function confirmDeleteKeyword() {
    if (confirm(`Are you absolutely sure you want to delete "${currentEditKeyword}"? This will affect all future analyses.`)) {
        const emotionIndex = emotions[currentEditEmotion].keywords.indexOf(currentEditKeyword);
        if (emotionIndex !== -1) {
            emotions[currentEditEmotion].keywords.splice(emotionIndex, 1);
            
            // Save to localStorage for persistence (optional)
            saveEmotionsToLocalStorage();
            
            // Refresh the keyword modal
            populateKeywordModal();
            
            // Close edit modal
            closeEditKeywordModal();
            
            showToast('ğŸ—‘ï¸ Keyword deleted successfully!');
        }
    }
}

// Optional: Save emotions to localStorage for persistence
function saveEmotionsToLocalStorage() {
    try {
        localStorage.setItem('sentimentKeywords', JSON.stringify(emotions));
    } catch (e) {
        console.error('Error saving to localStorage:', e);
    }
}

// Optional: Load emotions from localStorage on startup
function loadEmotionsFromLocalStorage() {
    try {
        const saved = localStorage.getItem('sentimentKeywords');
        if (saved) {
            const parsed = JSON.parse(saved);
            // Merge with default emotions
            Object.keys(parsed).forEach(emotion => {
                if (emotions[emotion]) {
                    emotions[emotion].keywords = parsed[emotion].keywords;
                }
            });
        }
    } catch (e) {
        console.error('Error loading from localStorage:', e);
    }
}

// Function to start countdown timer
function startCountdownTimer() {
  // Clear any existing timer
  if (countdownInterval) clearInterval(countdownInterval);
  
  // Calculate estimated time
  estimatedTimeRemaining = calculateTotalAnalysisTime();
  
  const analyzeBtn = document.getElementById('analyzeBtn');
  
  // Create countdown overlay if it doesn't exist
  let countdownOverlay = document.getElementById('countdownOverlay');
  if (!countdownOverlay) {
    const btnContainer = analyzeBtn.parentNode;
    countdownOverlay = document.createElement('div');
    countdownOverlay.id = 'countdownOverlay';
    countdownOverlay.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      color: white;
      font-weight: bold;
      font-size: 24px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    `;
    btnContainer.style.position = 'relative';
    btnContainer.appendChild(countdownOverlay);
  }
  
  // Show countdown
  countdownOverlay.style.opacity = '1';
  
  // Update countdown every second
  countdownInterval = setInterval(() => {
    estimatedTimeRemaining--;
    
    if (estimatedTimeRemaining <= 0) {
      clearInterval(countdownInterval);
      countdownOverlay.style.opacity = '0';
      return;
    }
    
    // Format time as MM:SS
    const minutes = Math.floor(estimatedTimeRemaining / 60);
    const seconds = estimatedTimeRemaining % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Update timer display
    countdownOverlay.textContent = timeString;
    
  }, 1000);
}

// Function to stop countdown timer
function stopCountdownTimer() {
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
  
  const countdownOverlay = document.getElementById('countdownOverlay');
  if (countdownOverlay) {
    countdownOverlay.style.opacity = '0';
  }
}

// Existing MyList name editing functions
function enableMyListNameEdit() {
  const display = document.getElementById('mylistNameDisplay');
  const input = document.getElementById('mylistNameInput');
  const text = document.getElementById('mylistNameText');
  
  // Hide display, show input
  display.style.display = 'none';
  input.style.display = 'block';
  input.focus();
  input.select();
  
  // Handle input events
  input.onkeydown = function(e) {
    if (e.key === 'Enter') {
      saveMyListName();
    } else if (e.key === 'Escape') {
      cancelMyListNameEdit();
    }
  };
  
  input.onblur = function() {
    saveMyListName();
  };
}

function saveMyListName() {
  const display = document.getElementById('mylistNameDisplay');
  const input = document.getElementById('mylistNameInput');
  const text = document.getElementById('mylistNameText');
  const newName = input.value.trim();
  
  if (newName) {
    // Update the tab name in our object
    tabNames[currentSector] = newName;
    
    // Update the display
    text.textContent = newName;
    
    // Update the tab name in navigation
    updateTabNameInNavigation(currentSector, newName);
    
    showToast('âœ… List name updated!');
  }
  
  // Reset UI
  display.style.display = 'flex';
  input.style.display = 'none';
}

function updateTabNameInNavigation(sector, newName) {
  const navButtons = document.querySelectorAll('.nav-btn');
  navButtons.forEach(btn => {
    if (btn.getAttribute('data-sector') === sector) {
      const tabNameSpan = btn.querySelector('.tab-name');
      if (tabNameSpan) {
        tabNameSpan.textContent = newName;
      }
    }
  });
}

function cancelMyListNameEdit() {
  const display = document.getElementById('mylistNameDisplay');
  const input = document.getElementById('mylistNameInput');
  
  // Reset input value to current name
  input.value = tabNames[currentSector];
  
  // Reset UI
  display.style.display = 'flex';
  input.style.display = 'none';
}

// Existing MyList action buttons
function handleMyListAction(action) {
  switch(action) {
    case 'guide':
      openGuideModal();
      break;
    case 'keyword':
      openKeywordModal();
      break;
    case 'export':
      openExportModal();
      break;
    case 'compare':
      openCompareModal();
      break;
  }
}

// Enhanced populate keyword modal with individual containers
function populateKeywordModal() {
    const container = document.getElementById('keywordsContainer');
    let html = '';
    
    // Update keyword counts
    const allCount = emotions.happy.keywords.length + emotions.neutral.keywords.length + emotions.sad.keywords.length;
    document.getElementById('allKeywordCount').textContent = allCount;
    document.getElementById('happyKeywordCount').textContent = emotions.happy.keywords.length;
    document.getElementById('neutralKeywordCount').textContent = emotions.neutral.keywords.length;
    document.getElementById('sadKeywordCount').textContent = emotions.sad.keywords.length;
    
    // Create keyword items for all emotions
    for (const [emotion, data] of Object.entries(emotions)) {
        const keywords = data.keywords;
        
        keywords.forEach((keyword, index) => {
            // Properly escape the keyword for JavaScript
            const escapedKeyword = keyword.replace(/'/g, "\\'").replace(/"/g, '\\"');
            
            html += `
    <div class="keyword-item ${emotion}" data-emotion="${emotion}" data-index="${index}" data-keyword="${keyword}">
        <div class="keyword-header">
            <div class="keyword-text">${keyword}</div>
            <div class="keyword-actions">
                <button class="keyword-action-btn edit" data-keyword="${keyword}" data-emotion="${emotion}" title="Edit">
                    <span class="icon">âœï¸</span>
                </button>
                <button class="keyword-action-btn delete" data-keyword="${keyword}" data-emotion="${emotion}" title="Delete">
                    <span class="icon">ğŸ—‘ï¸</span>
                </button>
            </div>
        </div>
        <div class="keyword-emotion">
            <span class="icon">${data.emoji}</span>
            <span>${emotion.charAt(0).toUpperCase() + emotion.slice(1)}</span>
        </div>
        <button class="keyword-action-btn copy" data-keyword="${keyword}" style="margin-top: 12px; padding: 6px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; width: 100%; background: rgba(102, 126, 234, 0.1); color: #667eea;">
            <span class="icon">ğŸ“‹</span>
            <span>Copy Keyword</span>
        </button>
    </div>
`;
        });
    }
    
    container.innerHTML = html;
    container.addEventListener('click', function(e) {
    const editBtn = e.target.closest('.keyword-action-btn.edit');
    const deleteBtn = e.target.closest('.keyword-action-btn.delete');
    const copyBtn = e.target.closest('.keyword-action-btn.copy');
    
    if (editBtn) {
        const keyword = editBtn.getAttribute('data-keyword');
        const emotion = editBtn.getAttribute('data-emotion');
        editKeyword(keyword, emotion);
    }
    
    if (deleteBtn) {
        const keyword = deleteBtn.getAttribute('data-keyword');
        const emotion = deleteBtn.getAttribute('data-emotion');
        deleteKeyword(keyword, emotion);
    }
    
    if (copyBtn) {
        const keyword = copyBtn.getAttribute('data-keyword');
        copyKeyword(keyword);
    }
});

    
    // Add search functionality
    const searchInput = document.getElementById('keywordSearch');
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        filterKeywords(searchTerm);
    });
    
    // Apply current filter
    filterKeywordsByEmotion(currentKeywordFilter);
}

// Filter keywords by emotion
function filterKeywordsByEmotion(emotion) {
    currentKeywordFilter = emotion;
    
    // Update active tab
    document.querySelectorAll('.keyword-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-emotion') === emotion) {
            btn.classList.add('active');
        }
    });
    
    // Show/hide keyword items
    const keywordItems = document.querySelectorAll('.keyword-item');
    
    keywordItems.forEach(item => {
        const itemEmotion = item.getAttribute('data-emotion');
        
        if (emotion === 'all' || itemEmotion === emotion) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
    
    // Handle empty state
    const container = document.getElementById('keywordsContainer');
    const visibleItems = container.querySelectorAll('.keyword-item[style*="display: block"]');
    
    if (visibleItems.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-keywords-state';
        emptyState.innerHTML = `
            <div class="icon">ğŸ”</div>
            <div>No keywords found</div>
        `;
        
        // Remove existing empty state if any
        const existingEmptyState = container.querySelector('.empty-keywords-state');
        if (existingEmptyState) existingEmptyState.remove();
        
        container.appendChild(emptyState);
    } else {
        // Remove empty state if it exists
        const emptyState = container.querySelector('.empty-keywords-state');
        if (emptyState) emptyState.remove();
    }
}

// Enhanced filter keywords with emotion filtering
function filterKeywords(searchTerm) {
    const keywordItems = document.querySelectorAll('.keyword-item');
    
    keywordItems.forEach(item => {
        const keywordText = item.querySelector('.keyword-text').textContent.toLowerCase();
        const itemEmotion = item.getAttribute('data-emotion');
        
        // Check if item matches current emotion filter
        const emotionMatch = currentKeywordFilter === 'all' || itemEmotion === currentKeywordFilter;
        
        if (searchTerm === '') {
            item.style.display = emotionMatch ? 'block' : 'none';
        } else {
            if (keywordText.includes(searchTerm) && emotionMatch) {
                item.style.display = 'block';
                // Highlight the search term in the keyword text
                const keywordElement = item.querySelector('.keyword-text');
                const originalText = keywordElement.textContent;
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                keywordElement.innerHTML = originalText.replace(regex, '<span class="highlight">$1</span>');
            } else {
                item.style.display = 'none';
            }
        }
    });
    
    // Handle empty state
    const container = document.getElementById('keywordsContainer');
    const visibleItems = container.querySelectorAll('.keyword-item[style*="display: block"]');
    
    if (visibleItems.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-keywords-state';
        emptyState.innerHTML = `
            <div class="icon">ğŸ”</div>
            <div>No keywords found for "${searchTerm}"</div>
        `;
        
        // Remove existing empty state if any
        const existingEmptyState = container.querySelector('.empty-keywords-state');
        if (existingEmptyState) existingEmptyState.remove();
        
        container.appendChild(emptyState);
    } else {
        // Remove empty state if it exists
        const emptyState = container.querySelector('.empty-keywords-state');
        if (emptyState) emptyState.remove();
    }
}

// Copy keyword to clipboard
function copyKeyword(keyword) {
    navigator.clipboard.writeText(keyword)
        .then(() => {
            showToast('ğŸ“‹ Keyword copied to clipboard!');
        })
        .catch(err => {
            console.error('Failed to copy keyword:', err);
            showToast('âŒ Failed to copy keyword');
        });
}

// Copy all keywords to clipboard
function copyAllKeywords() {
    let allKeywords = '';
    
    for (const [emotion, data] of Object.entries(emotions)) {
        const emotionName = emotion.charAt(0).toUpperCase() + emotion.slice(1);
        allKeywords += `${emotionName} Keywords:\n`;
        data.keywords.forEach(keyword => {
            allKeywords += `${keyword}\n`;
        });
        allKeywords += '\n';
    }
    
    navigator.clipboard.writeText(allKeywords.trim())
        .then(() => {
            showToast('ğŸ“‹ All keywords copied to clipboard!');
        })
        .catch(err => {
            console.error('Failed to copy keywords:', err);
            showToast('âŒ Failed to copy keywords');
        });
}

// Existing modal functions
function openGuideModal() {
  document.getElementById('guideModal').style.display = 'flex';
}

function closeGuideModal() {
  document.getElementById('guideModal').style.display = 'none';
}

// Open keyword modal
function openKeywordModal() {
    document.getElementById('keywordModal').style.display = 'flex';
    
    // Populate the modal with enhanced keyword data
    populateKeywordModal();
    
    // Reset search
    document.getElementById('keywordSearch').value = '';
    
    // Reset to all filter
    currentKeywordFilter = 'all';
    document.querySelectorAll('.keyword-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.keyword-tab-btn[data-emotion="all"]').classList.add('active');
}

function closeKeywordModal() {
    document.getElementById('keywordModal').style.display = 'none';
}

// Open export modal
function openExportModal() {
  document.getElementById('exportModal').style.display = 'flex';
  // Reset selection
  document.querySelectorAll('.export-option').forEach(opt => {
    opt.classList.remove('selected');
    if (opt.getAttribute('data-format') === selectedExportFormat) {
      opt.classList.add('selected');
    }
  });
  
  // Reset import selection
  document.querySelectorAll('.import-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  document.querySelector('.import-option[onclick*="csv"]').classList.add('selected');
  
  // Clear file input
  clearImport();
}

function closeExportModal() {
  document.getElementById('exportModal').style.display = 'none';
}

// Select export option
function selectExportOption(format) {
  selectedExportFormat = format;
  document.querySelectorAll('.export-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  document.querySelector(`.export-option[data-format="${format}"]`).classList.add('selected');
}

// Select import option
function selectImportOption(format) {
  selectedImportFormat = format;
  document.querySelectorAll('.import-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  // Find the clicked option
  const clickedOption = event.target.closest('.import-option');
  if (clickedOption) {
    clickedOption.classList.add('selected');
  }
  
  // Update file input accept attribute
  const fileInput = document.getElementById('importFile');
  if (format === 'json') {
    fileInput.accept = '.json';
  } else {
    fileInput.accept = '.csv,.txt';
  }
}

// Handle file import
function handleFileImport() {
  const fileInput = document.getElementById('importFile');
  const fileNameDisplay = document.getElementById('selectedFileName');
  
  if (fileInput.files.length > 0) {
    selectedFile = fileInput.files[0];
    fileNameDisplay.textContent = `Selected: ${selectedFile.name} (${(selectedFile.size / 1024).toFixed(2)} KB)`;
    fileNameDisplay.style.color = '#667eea';
  } else {
    selectedFile = null;
    fileNameDisplay.textContent = 'No file selected';
    fileNameDisplay.style.color = '#666';
  }
}

// Clear import
function clearImport() {
  document.getElementById('importFile').value = '';
  document.getElementById('selectedFileName').textContent = 'No file selected';
  document.getElementById('selectedFileName').style.color = '#666';
  selectedFile = null;
}

// Enhanced CSV export
function exportToCSVEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata, formatNumbers) {
  // Create CSV headers
  let headers = ['Company', 'Sector', 'Sad %', 'Neutral %', 'Happy %'];
  if (includeRAG) headers.push('RAG Status');
  if (includeTimestamps) headers.push('Last Analyzed');
  
  let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
  
  companiesToExport.forEach(company => {
    const sad = company.sad !== null ? (formatNumbers ? `${company.sad}%` : company.sad) : "N/A";
    const neutral = company.neutral !== null ? (formatNumbers ? `${company.neutral}%` : company.neutral) : "N/A";
    const happy = company.happy !== null ? (formatNumbers ? `${company.happy}%` : company.happy) : "N/A";
    const rag = company.sad !== null && company.happy !== null ? getRAG(company.sad, company.happy) : "N/A";
    
    let row = [
      `"${company.name}"`,
      `"${company.sector}"`,
      `"${sad}"`,
      `"${neutral}"`,
      `"${happy}"`
    ];
    
    if (includeRAG) row.push(`"${rag}"`);
    if (includeTimestamps) row.push(`"${new Date().toISOString()}"`);
    
    csvContent += row.join(',') + '\n';
  });
  
  if (includeMetadata) {
    csvContent += '\n' + `"Metadata","Value"` + '\n';
    csvContent += `"Export Date","${new Date().toISOString()}"` + '\n';
    csvContent += `"Total Companies","${companiesToExport.length}"` + '\n';
    csvContent += `"Analyzed Companies","${companiesToExport.filter(c => c.sad !== null).length}"` + '\n';
    csvContent += `"Export Scope","${document.getElementById('exportScope').value}"` + '\n';
    csvContent += `"Export Format","${selectedExportFormat}"` + '\n';
  }
  
  // Create download link
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sentiment_analysis_${new Date().toISOString().split('T')[0]}_${companiesToExport.length}_companies.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  showToast('ğŸ“¤ CSV data exported successfully!');
}

// Enhanced JSON export
function exportToJSONEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata) {
  const exportData = {
    exportDate: new Date().toISOString(),
    totalCompanies: companiesToExport.length,
    analyzedCompanies: companiesToExport.filter(c => c.sad !== null).length,
    companies: companiesToExport.map(company => {
      const data = {
        name: company.name,
        sector: company.sector,
        sentiment: {
          sad: company.sad,
          neutral: company.neutral,
          happy: company.happy
        }
      };
      
      if (includeRAG && company.sad !== null && company.happy !== null) {
        data.rag = getRAG(company.sad, company.happy);
      }
      
      if (includeTimestamps) {
        data.lastAnalyzed = new Date().toISOString();
        data.analysisDate = new Date().toISOString();
      }
      
      return data;
    })
  };
  
  if (includeMetadata) {
    exportData.metadata = {
      totalCompanies: companiesToExport.length,
      analyzedCompanies: companiesToExport.filter(c => c.sad !== null).length,
      exportScope: document.getElementById('exportScope').value,
      exportFormat: selectedExportFormat,
      version: '1.0.0',
      emotionKeywords: {
        happy: emotions.happy.keywords.length,
        neutral: emotions.neutral.keywords.length,
        sad: emotions.sad.keywords.length
      }
    };
  }
  
  const jsonString = JSON.stringify(exportData, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sentiment_analysis_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  showToast('ğŸ“¤ JSON data exported successfully!');
}

// PDF export
function exportToPDF(companiesToExport, includeRAG, includeTimestamps, includeMetadata) {
  // Create a simple PDF using jsPDF (you'll need to include jsPDF library)
  showToast('ğŸ“Š PDF export requires jsPDF library. For now, exporting as CSV...');
  
  // Fallback to CSV export
  exportToCSVEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata, true);
}

// Excel export
function exportToExcel(companiesToExport, includeRAG, includeTimestamps, includeMetadata) {
  // For Excel export, we can create an enhanced CSV that Excel can open nicely
  let headers = ['Company', 'Sector', 'Sad %', 'Neutral %', 'Happy %', 'RAG Status'];
  
  let csvContent = 'sep=,\n'; // Excel separator
  csvContent += headers.map(h => `"${h}"`).join(',') + '\n';
  
  companiesToExport.forEach(company => {
    const sad = company.sad !== null ? `${company.sad}%` : "N/A";
    const neutral = company.neutral !== null ? `${company.neutral}%` : "N/A";
    const happy = company.happy !== null ? `${company.happy}%` : "N/A";
    const rag = company.sad !== null && company.happy !== null ? getRAG(company.sad, company.happy) : "N/A";
    
    let row = [
      `"${company.name}"`,
      `"${company.sector}"`,
      `"${sad}"`,
      `"${neutral}"`,
      `"${happy}"`,
      `"${rag}"`
    ];
    
    csvContent += row.join(',') + '\n';
  });
  
  // Create download link
  const blob = new Blob([csvContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sentiment_analysis_${new Date().toISOString().split('T')[0]}.xls`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  showToast('ğŸ“ˆ Excel file exported successfully!');
}

// Perform export
function performExport() {
  const scope = document.getElementById('exportScope').value;
  const includeRAG = document.getElementById('includeRAG').checked;
  const includeTimestamps = document.getElementById('includeTimestamps').checked;
  const includeMetadata = document.getElementById('includeMetadata').checked;
  const formatNumbers = document.getElementById('formatNumbers').checked;
  
  let companiesToExport = [];
  
  // Filter companies based on scope
  switch(scope) {
    case 'current':
      if (currentSector === 'mylist') {
        companiesToExport = companies;
      } else {
        companiesToExport = companies.filter(c => c.sector === currentSector);
      }
      break;
    case 'all':
      companiesToExport = companies;
      break;
    case 'analyzed':
      companiesToExport = companies.filter(c => c.sad !== null && c.neutral !== null && c.happy !== null);
      break;
    case 'custom':
      // For custom selection, show a prompt for now
      const selectedNames = prompt('Enter company names to export (comma-separated):');
      if (selectedNames) {
        const names = selectedNames.split(',').map(name => name.trim());
        companiesToExport = companies.filter(c => names.includes(c.name));
      } else {
        companiesToExport = companies; // Fallback to all
      }
      break;
  }
  
  if (companiesToExport.length === 0) {
    showToast('âš ï¸ No companies to export');
    return;
  }
  
  // Create export data based on format
  switch(selectedExportFormat) {
    case 'csv':
      exportToCSVEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata, formatNumbers);
      break;
    case 'json':
      exportToJSONEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata);
      break;
    case 'pdf':
      exportToPDF(companiesToExport, includeRAG, includeTimestamps, includeMetadata);
      break;
    case 'excel':
      exportToExcel(companiesToExport, includeRAG, includeTimestamps, includeMetadata);
      break;
    default:
      exportToCSVEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata, formatNumbers);
  }
  
  closeExportModal();
}

// Perform import
async function performImport() {
  if (!selectedFile) {
    showToast('âš ï¸ Please select a file to import');
    return;
  }
  
  const importMode = document.querySelector('input[name="importMode"]:checked').value;
  const keepScores = document.getElementById('importWithScores').checked;
  
  try {
    const text = await selectedFile.text();
    let importedData;
    let importCount = 0;
    let updateCount = 0;
    
    if (selectedFile.name.toLowerCase().endsWith('.json')) {
      importedData = JSON.parse(text);
      
      // Check if this is our export format
      if (importedData.companies && Array.isArray(importedData.companies)) {
        if (importMode === 'replace') {
          // Replace all companies
          companies = importedData.companies.map(company => ({
            name: company.name,
            sector: company.sector || 'Technology',
            sad: keepScores ? (company.sentiment?.sad || null) : null,
            neutral: keepScores ? (company.sentiment?.neutral || null) : null,
            happy: keepScores ? (company.sentiment?.happy || null) : null
          }));
          importCount = companies.length;
        } else {
          // Import each company
          importedData.companies.forEach(company => {
            const existingIndex = companies.findIndex(c => 
              c.name.toLowerCase() === company.name.toLowerCase()
            );
            
            if (existingIndex !== -1) {
              if (importMode === 'update') {
                // Update existing company
                if (keepScores && company.sentiment) {
                  companies[existingIndex].sad = company.sentiment.sad;
                  companies[existingIndex].neutral = company.sentiment.neutral;
                  companies[existingIndex].happy = company.sentiment.happy;
                }
                companies[existingIndex].sector = company.sector || companies[existingIndex].sector;
                updateCount++;
              }
            } else {
              // Add new company
              companies.push({
                name: company.name,
                sector: company.sector || 'Technology',
                sad: keepScores ? (company.sentiment?.sad || null) : null,
                neutral: keepScores ? (company.sentiment?.neutral || null) : null,
                happy: keepScores ? (company.sentiment?.happy || null) : null
              });
              importCount++;
            }
          });
        }
      } else if (Array.isArray(importedData)) {
        // Handle array format
        importedData.forEach(company => {
          const existingIndex = companies.findIndex(c => 
            c.name.toLowerCase() === company.name.toLowerCase()
          );
          
          if (existingIndex === -1 || importMode === 'replace') {
            companies.push({
              name: company.name,
              sector: company.sector || 'Technology',
              sad: company.sad || null,
              neutral: company.neutral || null,
              happy: company.happy || null
            });
            importCount++;
          }
        });
      }
    } else if (selectedFile.name.toLowerCase().endsWith('.csv')) {
      // Handle CSV import
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length === 0) {
        showToast('âš ï¸ CSV file is empty');
        return;
      }
      
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        
        // Handle quoted CSV values
        const values = [];
        let inQuotes = false;
        let currentValue = '';
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(currentValue.trim().replace(/"/g, ''));
            currentValue = '';
          } else {
            currentValue += char;
          }
        }
        values.push(currentValue.trim().replace(/"/g, ''));
        
        const companyData = {};
        headers.forEach((header, index) => {
          if (index < values.length) {
            companyData[header] = values[index];
          }
        });
        
        if (!companyData.company && !companyData.name) {
          continue; // Skip if no company name
        }
        
        const companyName = companyData.company || companyData.name || companyData['company name'];
        const sector = companyData.sector || companyData.industry || 'Technology';
        
        const existingIndex = companies.findIndex(c => 
          c.name.toLowerCase() === companyName.toLowerCase()
        );
        
        if (existingIndex !== -1) {
          if (importMode === 'update' || importMode === 'replace') {
            // Update existing company
            if (keepScores) {
              companies[existingIndex].sad = parseInt(companyData['sad %'] || companyData.sad) || companies[existingIndex].sad;
              companies[existingIndex].neutral = parseInt(companyData['neutral %'] || companyData.neutral) || companies[existingIndex].neutral;
              companies[existingIndex].happy = parseInt(companyData['happy %'] || companyData.happy) || companies[existingIndex].happy;
            }
            companies[existingIndex].sector = sector || companies[existingIndex].sector;
            updateCount++;
          }
        } else if (importMode !== 'update') {
          // Add new company
          companies.push({
            name: companyName,
            sector: sector,
            sad: keepScores ? (parseInt(companyData['sad %'] || companyData.sad) || null) : null,
            neutral: keepScores ? (parseInt(companyData['neutral %'] || companyData.neutral) || null) : null,
            happy: keepScores ? (parseInt(companyData['happy %'] || companyData.happy) || null) : null
          });
          importCount++;
        }
      }
    }
    
    if (importMode === 'replace') {
      // Already handled in JSON section
    }
    
    renderTable();
    showToast(`âœ… Imported ${importCount} new companies, updated ${updateCount} existing companies`);
    closeExportModal();
    
  } catch (error) {
    console.error('Import error:', error);
    showToast('âŒ Error importing file. Please check the format and try again.');
  }
}

// Open compare modal
function openCompareModal() {
  // Calculate comparison data
  const companiesWithData = companies.filter(c => c.sad !== null && c.neutral !== null && c.happy !== null);
  
  if (companiesWithData.length > 0) {
    // Find company with highest happy percentage
    const happiest = companiesWithData.reduce((prev, current) => 
      (prev.happy > current.happy) ? prev : current
    );
    
    // Find company with highest sad percentage
    const saddest = companiesWithData.reduce((prev, current) => 
      (prev.sad > current.sad) ? prev : current
    );
    
    // Find company with most balanced sentiment
    const mostBalanced = companiesWithData.reduce((prev, current) => {
      const prevDiff = Math.abs(prev.happy - prev.sad);
      const currentDiff = Math.abs(current.happy - current.sad);
      return (prevDiff < currentDiff) ? prev : current;
    });
    
    // Update UI
    document.getElementById('happiestCompany').textContent = `${happiest.name} (${happiest.happy}%)`;
    document.getElementById('saddestCompany').textContent = `${saddest.name} (${saddest.sad}%)`;
    document.getElementById('mostBalancedCompany').textContent = `${mostBalanced.name} (${mostBalanced.happy}% happy, ${mostBalanced.sad}% sad)`;
    
    // Update metrics
    document.getElementById('totalCompanies').textContent = companies.length;
    document.getElementById('analyzedCompanies').textContent = companiesWithData.length;
    
    // Calculate average sentiment
    const avgSentiment = companiesWithData.length > 0 
      ? Math.round(companiesWithData.reduce((sum, c) => sum + c.happy, 0) / companiesWithData.length)
      : 0;
    document.getElementById('avgSentiment').textContent = `${avgSentiment}%`;
    
    // Calculate sector distribution
    const sectorDistribution = document.getElementById('sectorDistribution');
    const sectors = {};
    
    companies.forEach(company => {
      sectors[company.sector] = (sectors[company.sector] || 0) + 1;
    });
    
    let sectorHTML = '';
    for (const [sector, count] of Object.entries(sectors)) {
      sectorHTML += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 500;">${sector}</span>
          <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${count}</span>
        </div>
      `;
    }
    
    sectorDistribution.innerHTML = sectorHTML;
  }
  
  document.getElementById('compareModal').style.display = 'flex';
}

function closeCompareModal() {
  document.getElementById('compareModal').style.display = 'none';
}

function exportComparison() {
  showToast('ğŸ“Š Comparison exported!');
  closeCompareModal();
}

// RAG Editing Functions
function editRagStatus(companyIndex) {
  const company = companies[companyIndex];
  currentRagEditIndex = companyIndex;
  
  // Set modal values
  document.getElementById('ragCompanyName').value = company.name;
  
  // Determine current RAG - check for override first
  const currentRag = company.ragOverride || getRAG(company.sad, company.happy, company);
  
  // Set selected RAG option
  document.querySelectorAll('.rag-edit-option').forEach(option => {
    option.classList.remove('selected');
    if (option.getAttribute('data-rag') === currentRag) {
      option.classList.add('selected');
    }
  });
  
  // Set manual sentiment values if they exist
  document.getElementById('manualSad').value = company.sad || '';
  document.getElementById('manualNeutral').value = company.neutral || '';
  document.getElementById('manualHappy').value = company.happy || '';
  
  // Show modal
  document.getElementById('editRagModal').style.display = 'flex';
}





function closeEditRagModal() {
  document.getElementById('editRagModal').style.display = 'none';
  currentRagEditIndex = -1;
}

function saveRagEdit() {
  if (currentRagEditIndex === -1) return;
  
  const selectedRag = document.querySelector('.rag-edit-option.selected').getAttribute('data-rag');
  const manualSad = document.getElementById('manualSad').value;
  const manualNeutral = document.getElementById('manualNeutral').value;
  const manualHappy = document.getElementById('manualHappy').value;
  
  // Store the selected RAG color
  companies[currentRagEditIndex].ragOverride = selectedRag;
  
  // If manual values are provided, update sentiment percentages
  if (manualSad || manualNeutral || manualHappy) {
    companies[currentRagEditIndex].sad = manualSad ? parseInt(manualSad) : companies[currentRagEditIndex].sad;
    companies[currentRagEditIndex].neutral = manualNeutral ? parseInt(manualNeutral) : companies[currentRagEditIndex].neutral;
    companies[currentRagEditIndex].happy = manualHappy ? parseInt(manualHappy) : companies[currentRagEditIndex].happy;
  }
  
  // Clear any calculated RAG since we have an override
  delete companies[currentRagEditIndex].calculatedRAG;
  
  renderTable();
  closeEditRagModal();
  showToast('âœ… RAG status updated successfully!');
}

// Add Tab Functions
function openAddTabModal() {
  document.getElementById('addTabModal').style.display = 'flex';
  document.getElementById('newTabName').value = '';
  document.getElementById('newTabIcon').value = 'ğŸ¢';
  
  // Reset color selection
  document.querySelectorAll('.color-option').forEach(option => {
    option.style.border = '2px solid transparent';
  });
  // Select first color by default
  document.querySelector('.color-option').style.border = '2px solid #667eea';
}

function closeAddTabModal() {
  document.getElementById('addTabModal').style.display = 'none';
}

function createNewTab() {
  const tabName = document.getElementById('newTabName').value.trim();
  const tabIcon = document.getElementById('newTabIcon').value;
  const selectedColor = document.querySelector('.color-option[style*="border: 2px solid rgb(102, 126, 234)"]');
  
  if (!tabName) {
    showToast('âš ï¸ Please enter a tab name');
    return;
  }
  
  if (!selectedColor) {
    showToast('âš ï¸ Please select a color');
    return;
  }
  
  const tabId = tabName.toLowerCase().replace(/\s+/g, '_');
  const tabColor = selectedColor.getAttribute('data-color');
  
  // Add to custom tabs
  customTabs.push({
    id: tabId,
    name: tabName,
    icon: tabIcon,
    color: tabColor
  });
  
  // Add to tabNames for rendering
  tabNames[tabId] = tabName;
  
  // Create new tab button
  const navBar = document.getElementById('navBar');
  const addTabBtn = document.getElementById('addTabBtn');
  const newTabBtn = document.createElement('button');
  newTabBtn.className = 'nav-btn custom-tab';
  newTabBtn.setAttribute('data-sector', tabId);
  newTabBtn.innerHTML = `
    <span class="icon">${tabIcon}</span>
    <span class="tab-name">${tabName}</span>
    <button class="remove-tab" onclick="removeCustomTab('${tabId}', event)">Ã—</button>
  `;
  
  // Insert before add button
  navBar.insertBefore(newTabBtn, addTabBtn);
  
  // Add event listener
  newTabBtn.addEventListener('click', function() {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentSector = tabId;
    renderTable();
  });
  
  // Add CSS for this tab's mylist-header style
  const style = document.createElement('style');
  style.textContent = `
    .mylist-header.${tabId} { 
      background: ${tabColor}; 
    }
  `;
  document.head.appendChild(style);
  
  closeAddTabModal();
  showToast(`âœ… Tab "${tabName}" created successfully!`);
}

function removeCustomTab(tabId, event) {
  event.stopPropagation();
  
  if (confirm(`Remove tab "${tabNames[tabId]}"?`)) {
    // Remove from customTabs array
    customTabs = customTabs.filter(tab => tab.id !== tabId);
    
    // Remove from tabNames
    delete tabNames[tabId];
    
    // Remove button from DOM
    const tabBtn = document.querySelector(`.nav-btn[data-sector="${tabId}"]`);
    if (tabBtn) tabBtn.remove();
    
    // If this was the active tab, switch to My List
    if (currentSector === tabId) {
      currentSector = 'mylist';
      document.querySelector('.nav-btn[data-sector="mylist"]').classList.add('active');
      renderTable();
    }
    
    showToast(`ğŸ—‘ï¸ Tab removed successfully!`);
  }
}
function clearRagOverride() {
  if (currentRagEditIndex === -1) return;
  
  delete companies[currentRagEditIndex].ragOverride;
  renderTable();
  closeEditRagModal();
  showToast('ğŸ”„ RAG reset to automatic calculation');
}
// Enhanced Test Modal Functions
function openTestModal() {
  document.getElementById('testModal').style.display = 'flex';
  
  // Clear previous results
  clearTestResults();
  
  // Reset companies list
  testCompanies = [];
  testResults = {};
  renderTestCompaniesList();
  
  // Populate keyword lists with all keywords
  const positiveList = document.getElementById('positiveKeywordsList');
  const negativeList = document.getElementById('negativeKeywordsList');
  const neutralList = document.getElementById('neutralKeywordsList');
  
  positiveList.innerHTML = emotions.happy.keywords.slice(0, 30).map(keyword => 
    `<span class="keyword-tag happy">${keyword}</span>`
  ).join('');
  
  negativeList.innerHTML = emotions.sad.keywords.slice(0, 30).map(keyword => 
    `<span class="keyword-tag sad">${keyword}</span>`
  ).join('');
  
  neutralList.innerHTML = emotions.neutral.keywords.slice(0, 30).map(keyword => 
    `<span class="keyword-tag neutral">${keyword}</span>`
  ).join('');
  
  // Hide results section initially
  document.getElementById('testResultsSection').style.display = 'none';
}

function closeTestModal() {
  document.getElementById('testModal').style.display = 'none';
}

// Add company to test modal
function addTestCompany() {
  const companyName = document.getElementById('testCompanyName').value.trim();
  
  if (!companyName) {
    showToast('âš ï¸ Please enter a company name');
    return;
  }
  
  // Check if company already exists in test
  if (testCompanies.some(c => c.name.toLowerCase() === companyName.toLowerCase())) {
    showToast('âš ï¸ Company already added to test');
    return;
  }
  
  // Add to test companies
  testCompanies.push({
    name: companyName,
    keywords: {
      positive: [],
      negative: [],
      neutral: []
    },
    sentences: []
  });
  
  // Clear input
  document.getElementById('testCompanyName').value = '';
  
  // Update display
  renderTestCompaniesList();
  
  showToast(`âœ… "${companyName}" added to test`);
}

// Render test companies list
function renderTestCompaniesList() {
  const container = document.getElementById('testCompaniesList');
  
  if (testCompanies.length === 0) {
    container.innerHTML = '<div class="empty-state" style="text-align: center; color: #999; padding: 20px;">No companies added yet. Add a company to test sentiment analysis.</div>';
    return;
  }
  
  container.innerHTML = testCompanies.map((company, index) => `
    <div class="test-company-item">
      <div>
        <div class="test-company-name">${company.name}</div>
        <div class="test-company-keywords">
          ${company.keywords.positive.length > 0 ? `ğŸ‘ ${company.keywords.positive.length} positive` : ''}
          ${company.keywords.positive.length > 0 && company.keywords.negative.length > 0 ? ' â€¢ ' : ''}
          ${company.keywords.negative.length > 0 ? `ğŸ‘ ${company.keywords.negative.length} negative` : ''}
          ${(company.keywords.positive.length > 0 || company.keywords.negative.length > 0) && company.keywords.neutral.length > 0 ? ' â€¢ ' : ''}
          ${company.keywords.neutral.length > 0 ? `ğŸ˜ ${company.keywords.neutral.length} neutral` : ''}
        </div>
      </div>
      <button class="remove-test-company" onclick="removeTestCompany(${index})">Ã—</button>
    </div>
  `).join('');
}

// Remove test company
function removeTestCompany(index) {
  testCompanies.splice(index, 1);
  renderTestCompaniesList();
  showToast('ğŸ—‘ï¸ Company removed from test');
}

// Enhanced sentiment analysis test with detailed results
function runSentimentTest() {
  const textInput = document.getElementById('testTextInput').value;
  
  if (!textInput.trim()) {
    showToast('âš ï¸ Please enter some text to analyze');
    return;
  }
  
  // Show loading state
  document.getElementById('happyScoreValue').textContent = '...';
  document.getElementById('sadScoreValue').textContent = '...';
  document.getElementById('neutralScoreValue').textContent = '...';
  document.getElementById('pieChartCenter').textContent = '...';
  document.getElementById('confidenceScore').textContent = '...';
  
  // Analyze text sentiment with enhanced details
  const analysis = analyzeTextSentimentEnhanced(textInput);
  
  // Update word count and keyword count
  const wordCount = textInput.trim().split(/\s+/).length;
  const totalKeywords = analysis.detectedKeywords.length;
  
  document.getElementById('wordCount').textContent = wordCount;
  document.getElementById('keywordCount').textContent = totalKeywords;
  document.getElementById('analysisDetails').textContent = 
    `Analyzed ${wordCount} words with ${totalKeywords} keywords detected`;
  
  // Calculate percentages for visualization
  const totalScore = analysis.happy + analysis.sad + analysis.neutral;
  const happyPercent = totalScore > 0 ? Math.round((analysis.happy / totalScore) * 100) : 0;
  const sadPercent = totalScore > 0 ? Math.round((analysis.sad / totalScore) * 100) : 0;
  const neutralPercent = totalScore > 0 ? Math.round((analysis.neutral / totalScore) * 100) : 0;
  
  // Update text displays
  document.getElementById('happyScoreValue').textContent = `${happyPercent}%`;
  document.getElementById('sadScoreValue').textContent = `${sadPercent}%`;
  document.getElementById('neutralScoreValue').textContent = `${neutralPercent}%`;
  document.getElementById('legendHappy').textContent = `${happyPercent}%`;
  document.getElementById('legendSad').textContent = `${sadPercent}%`;
  document.getElementById('legendNeutral').textContent = `${neutralPercent}%`;
  document.getElementById('pieChartCenter').textContent = `${happyPercent}% Pos`;
  
  // Update keyword counts
  document.getElementById('positiveKeywordCount').textContent = `${analysis.positiveKeywords.length} keywords`;
  document.getElementById('negativeKeywordCount').textContent = `${analysis.negativeKeywords.length} keywords`;
  document.getElementById('neutralKeywordCount').textContent = `${analysis.neutralKeywords.length} keywords`;
  
  // Update overall sentiment badge
  const overallSentimentBadge = document.getElementById('overallSentimentBadge');
  if (happyPercent >= 60) {
    overallSentimentBadge.textContent = 'Mostly Positive';
    overallSentimentBadge.style.background = 'linear-gradient(135deg, #4caf50, #2e7d32)';
  } else if (sadPercent >= 60) {
    overallSentimentBadge.textContent = 'Mostly Negative';
    overallSentimentBadge.style.background = 'linear-gradient(135deg, #f44336, #c62828)';
  } else {
    overallSentimentBadge.textContent = 'Mixed/Neutral';
    overallSentimentBadge.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
  }
  
  // Calculate and display confidence score
  const confidenceScore = Math.min(100, Math.round((totalKeywords / Math.max(wordCount, 1)) * 100 * 3));
  document.getElementById('confidenceScore').textContent = `${confidenceScore}%`;
  document.getElementById('confidenceBar').style.width = `${confidenceScore}%`;
  
  // Update total keyword statistics
  document.getElementById('totalPositiveKeywords').textContent = analysis.positiveKeywords.length;
  document.getElementById('totalNegativeKeywords').textContent = analysis.negativeKeywords.length;
  document.getElementById('totalNeutralKeywords').textContent = analysis.neutralKeywords.length;
  
  // Show top keywords
  displayTopKeywords(analysis);
  
  // Animate chart bars
  animateChartBars(happyPercent, sadPercent, neutralPercent);
  
  // Update pie chart
  updatePieChart(happyPercent, sadPercent, neutralPercent);
  
  // Show results section
  document.getElementById('testResultsSection').style.display = 'block';
  
  // Update test companies with analysis results
  updateTestCompaniesWithAnalysis(analysis);
  
  // Show company-specific results
  displayCompanyTestResults(analysis);
  
  // Populate keyword lists
  populateEnhancedKeywordLists(analysis);
  
  // Setup keyword search
  setupKeywordSearch(analysis);
  
  showToast('âœ… Sentiment analysis complete!');
}

// Enhanced sentiment analysis with neutral detection
function analyzeTextSentimentEnhanced(text) {
  const lowerText = text.toLowerCase();
  
  let happyScore = 0;
  let sadScore = 0;
  let neutralScore = 0;
  const detectedPositive = [];
  const detectedNegative = [];
  const detectedNeutral = [];
  const detectedKeywords = [];
  
  // Check for happy keywords
  emotions.happy.keywords.forEach(keyword => {
    const regex = new RegExp(`\\b${keyword.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
    const matches = lowerText.match(regex);
    if (matches) {
      happyScore += matches.length;
      if (!detectedPositive.includes(keyword)) {
        detectedPositive.push(keyword);
        detectedKeywords.push({ keyword, score: matches.length, type: 'positive' });
      }
    }
  });
  
  // Check for sad keywords
  emotions.sad.keywords.forEach(keyword => {
    const regex = new RegExp(`\\b${keyword.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
    const matches = lowerText.match(regex);
    if (matches) {
      sadScore += matches.length;
      if (!detectedNegative.includes(keyword)) {
        detectedNegative.push(keyword);
        detectedKeywords.push({ keyword, score: matches.length, type: 'negative' });
      }
    }
  });
  
  // Check for neutral keywords
  emotions.neutral.keywords.forEach(keyword => {
    const regex = new RegExp(`\\b${keyword.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
    const matches = lowerText.match(regex);
    if (matches) {
      neutralScore += matches.length;
      if (!detectedNeutral.includes(keyword)) {
        detectedNeutral.push(keyword);
        detectedKeywords.push({ keyword, score: matches.length, type: 'neutral' });
      }
    }
  });
  
  const totalScore = happyScore + sadScore + neutralScore;
  const happyPercent = totalScore > 0 ? Math.round((happyScore / totalScore) * 100) : 0;
  const sadPercent = totalScore > 0 ? Math.round((sadScore / totalScore) * 100) : 0;
  const neutralPercent = totalScore > 0 ? Math.round((neutralScore / totalScore) * 100) : 0;
  
  return {
    happy: happyScore,
    sad: sadScore,
    neutral: neutralScore,
    happyPercent,
    sadPercent,
    neutralPercent,
    positiveKeywords: detectedPositive,
    negativeKeywords: detectedNegative,
    neutralKeywords: detectedNeutral,
    detectedKeywords,
    text: text
  };
}

// Display top keywords
function displayTopKeywords(analysis) {
  const container = document.getElementById('topKeywordsContainer');
  
  // Sort keywords by score (frequency)
  const sortedKeywords = analysis.detectedKeywords
    .sort((a, b) => b.score - a.score)
    .slice(0, 15); // Show top 15 keywords
  
  container.innerHTML = sortedKeywords.map(kw => `
    <div class="top-keyword-tag ${kw.type}" title="Found ${kw.score} time${kw.score > 1 ? 's' : ''}">
      ${kw.keyword}
      <span class="score-badge">${kw.score}</span>
    </div>
  `).join('');
}

// Enhanced chart animation
function animateChartBars(happyPercent, sadPercent, neutralPercent) {
  const happyBar = document.getElementById('happyBar');
  const sadBar = document.getElementById('sadBar');
  const neutralBar = document.getElementById('neutralBar');
  
  // Reset widths first
  happyBar.style.width = '0%';
  sadBar.style.width = '0%';
  neutralBar.style.width = '0%';
  
  // Animate to target widths with delays
  setTimeout(() => happyBar.style.width = `${happyPercent}%`, 100);
  setTimeout(() => sadBar.style.width = `${sadPercent}%`, 300);
  setTimeout(() => neutralBar.style.width = `${neutralPercent}%`, 500);
}

// Enhanced pie chart update
function updatePieChart(happyPercent, sadPercent, neutralPercent) {
  const pieChart = document.getElementById('sentimentPieChart');
  
  pieChart.style.setProperty('--happy-percent', `${happyPercent}%`);
  pieChart.style.setProperty('--neutral-percent', `${neutralPercent}%`);
  pieChart.style.setProperty('--sad-percent', `${sadPercent}%`);
  
  pieChart.style.background = `conic-gradient(
    #4caf50 0% ${happyPercent}%,
    #ff9800 ${happyPercent}% ${happyPercent + neutralPercent}%,
    #f44336 ${happyPercent + neutralPercent}% ${happyPercent + neutralPercent + sadPercent}%
  )`;
}

// Enhanced keyword list population
function populateEnhancedKeywordLists(analysis) {
  // Populate positive keywords
  const positiveList = document.getElementById('positiveKeywordsList');
  positiveList.innerHTML = analysis.positiveKeywords.slice(0, 30).map(keyword => 
    `<span class="keyword-tag happy">${keyword}</span>`
  ).join('');
  
  // Populate negative keywords
  const negativeList = document.getElementById('negativeKeywordsList');
  negativeList.innerHTML = analysis.negativeKeywords.slice(0, 30).map(keyword => 
    `<span class="keyword-tag sad">${keyword}</span>`
  ).join('');
  
  // Populate neutral keywords
  const neutralList = document.getElementById('neutralKeywordsList');
  neutralList.innerHTML = analysis.neutralKeywords.slice(0, 30).map(keyword => 
    `<span class="keyword-tag neutral">${keyword}</span>`
  ).join('');
}

// Setup keyword search in test modal
function setupKeywordSearch(analysis) {
  const searchInput = document.getElementById('keywordSearchTest');
  
  searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    
    // Filter all keyword lists
    ['positiveKeywordsList', 'negativeKeywordsList', 'neutralKeywordsList'].forEach(listId => {
      const container = document.getElementById(listId);
      const keywordTags = container.querySelectorAll('.keyword-tag');
      
      keywordTags.forEach(tag => {
        const keyword = tag.textContent.toLowerCase();
        if (searchTerm === '' || keyword.includes(searchTerm)) {
          tag.style.display = 'inline-block';
        } else {
          tag.style.display = 'none';
        }
      });
    });
  });
}

// Update test companies with analysis
function updateTestCompaniesWithAnalysis(analysis) {
  testCompanies.forEach(company => {
    // Add detected keywords to each company
    company.keywords.positive = analysis.positiveKeywords.filter(kw => 
      company.name.toLowerCase().includes(kw) || 
      analysis.text.toLowerCase().includes(company.name.toLowerCase())
    );
    
    company.keywords.negative = analysis.negativeKeywords.filter(kw => 
      company.name.toLowerCase().includes(kw) || 
      analysis.text.toLowerCase().includes(company.name.toLowerCase())
    );
    
    company.keywords.neutral = analysis.neutralKeywords.filter(kw => 
      company.name.toLowerCase().includes(kw) || 
      analysis.text.toLowerCase().includes(company.name.toLowerCase())
    );
    
    // Add sentences containing company name
    const sentences = analysis.text.split(/[.!?]+/);
    company.sentences = sentences.filter(sentence => 
      sentence.toLowerCase().includes(company.name.toLowerCase())
    );
    
    // Store analysis results
    testResults[company.name] = {
      happy: analysis.happyPercent,
      sad: analysis.sadPercent,
      neutral: analysis.neutralPercent,
      positiveKeywords: company.keywords.positive,
      negativeKeywords: company.keywords.negative,
      neutralKeywords: company.keywords.neutral,
      sentences: company.sentences
    };
  });
  
  // Update companies list display
  renderTestCompaniesList();
}

// Display company test results
function displayCompanyTestResults(analysis) {
  const container = document.getElementById('companyTestResults');
  
  if (testCompanies.length === 0) {
    container.innerHTML = `
      <div class="chart-container">
        <div class="chart-title">ğŸ¢ No Companies to Analyze</div>
        <p style="color: #666; text-align: center;">Add companies above to see their specific analysis results.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = testCompanies.map(company => {
    const result = testResults[company.name];
    const happyPercent = result ? result.happy : 0;
    const sadPercent = result ? result.sad : 0;
    const neutralPercent = result ? result.neutral : 0;
    
    return `
      <div class="chart-container">
        <div class="chart-title">ğŸ¢ ${company.name}</div>
        <div class="sentiment-chart">
          <div class="chart-bar">
            <div class="chart-bar-label">
              <span>ğŸ˜Š Positive</span>
              <span class="chart-bar-value">${happyPercent}%</span>
            </div>
            <div class="chart-bar-track">
              <div class="chart-bar-fill happy" style="width: ${happyPercent}%"></div>
            </div>
          </div>
          <div class="chart-bar">
            <div class="chart-bar-label">
              <span>ğŸ˜¢ Negative</span>
              <span class="chart-bar-value">${sadPercent}%</span>
            </div>
            <div class="chart-bar-track">
              <div class="chart-bar-fill sad" style="width: ${sadPercent}%</div>
            </div>
          </div>
          <div class="chart-bar">
            <div class="chart-bar-label">
              <span>ğŸ˜ Neutral</span>
              <span class="chart-bar-value">${neutralPercent}%</span>
            </div>
            <div class="chart-bar-track">
              <div class="chart-bar-fill neutral" style="width: ${neutralPercent}%"></div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 15px;">
          <div style="font-size: 14px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Detected Keywords:</div>
          <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
            ${result.positiveKeywords.map(keyword => 
              `<span class="keyword-tag happy" style="font-size: 11px;">${keyword}</span>`
            ).join('')}
            ${result.negativeKeywords.map(keyword => 
              `<span class="keyword-tag sad" style="font-size: 11px;">${keyword}</span>`
            ).join('')}
            ${result.neutralKeywords.map(keyword => 
              `<span class="keyword-tag neutral" style="font-size: 11px;">${keyword}</span>`
            ).join('')}
          </div>
          
          ${result.sentences.length > 0 ? `
            <div style="font-size: 14px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Relevant Sentences:</div>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 13px; color: #555;">
              ${result.sentences.slice(0, 3).map(sentence => 
                `<p style="margin: 5px 0;">â€¢ ${sentence.trim()}.</p>`
              ).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

// Save test results to main companies list
function saveTestToCompany() {
  if (testCompanies.length === 0) {
    showToast('âš ï¸ No test companies to save');
    return;
  }
  
  testCompanies.forEach(company => {
    const result = testResults[company.name];
    if (!result) return;
    
    // Check if company already exists
    const existingIndex = companies.findIndex(c => 
      c.name.toLowerCase() === company.name.toLowerCase()
    );
    
    if (existingIndex !== -1) {
      // Update existing company
      companies[existingIndex].sad = result.sad;
      companies[existingIndex].happy = result.happy;
      companies[existingIndex].neutral = result.neutral || (100 - result.sad - result.happy);
    } else {
      // Add new company
      companies.push({
        name: company.name,
        sector: 'Technology', // Default sector
        sad: result.sad,
        happy: result.happy,
        neutral: result.neutral || (100 - result.sad - result.happy)
      });
    }
  });
  
  renderTable();
  showToast(`âœ… ${testCompanies.length} companies saved to main list!`);
  
  // Close test modal
  closeTestModal();
}

// Enhanced clear test results
function clearTestResults() {
  document.getElementById('testTextInput').value = '';
  document.getElementById('happyScoreValue').textContent = '0%';
  document.getElementById('sadScoreValue').textContent = '0%';
  document.getElementById('neutralScoreValue').textContent = '0%';
  document.getElementById('legendHappy').textContent = '0%';
  document.getElementById('legendSad').textContent = '0%';
  document.getElementById('legendNeutral').textContent = '0%';
  document.getElementById('pieChartCenter').textContent = '0%';
  document.getElementById('confidenceScore').textContent = '0%';
  document.getElementById('confidenceBar').style.width = '0%';
  
  // Reset charts
  animateChartBars(0, 0, 0);
  updatePieChart(0, 0, 0);
  
  // Clear keyword lists
  document.getElementById('topKeywordsContainer').innerHTML = '';
  document.getElementById('positiveKeywordsList').innerHTML = '';
  document.getElementById('negativeKeywordsList').innerHTML = '';
  document.getElementById('neutralKeywordsList').innerHTML = '';
  
  // Hide results section
  document.getElementById('testResultsSection').style.display = 'none';
  document.getElementById('companyTestResults').innerHTML = '';
  
  // Clear test companies
  testCompanies = [];
  testResults = {};
  renderTestCompaniesList();
  
  // Reset search
  document.getElementById('keywordSearchTest').value = '';
  
  showToast('ğŸ§¹ Test results cleared!');
}

// Tab Navigation Scroll Functions
function setupTabScroll() {
  const navBar = document.getElementById('navBar');
  const scrollLeftBtn = document.getElementById('scrollLeft');
  const scrollRightBtn = document.getElementById('scrollRight');
  
  function updateScrollButtons() {
    const scrollLeft = navBar.scrollLeft;
    const maxScroll = navBar.scrollWidth - navBar.clientWidth;
    
    scrollLeftBtn.classList.toggle('hidden', scrollLeft <= 0);
    scrollRightBtn.classList.toggle('hidden', scrollLeft >= maxScroll - 5);
  }
  
  scrollLeftBtn.addEventListener('click', () => {
    navBar.scrollBy({ left: -200, behavior: 'smooth' });
  });
  
  scrollRightBtn.addEventListener('click', () => {
    navBar.scrollBy({ left: 200, behavior: 'smooth' });
  });
  
  navBar.addEventListener('scroll', updateScrollButtons);
  window.addEventListener('resize', updateScrollButtons);
  
  // Initial update
  updateScrollButtons();
}

// Updated renderTable to include RAG editing and new tabs
function renderTable() {
  const tbody = document.getElementById('tableBody');
  const mylistHeader = document.getElementById('mylistHeader');
  const text = document.getElementById('mylistNameText');
  
  // Update MyList header with current tab name
  text.textContent = tabNames[currentSector];
  const input = document.getElementById('mylistNameInput');
  input.value = tabNames[currentSector];
  
  // Apply tab-specific styling
  mylistHeader.className = 'mylist-header';
  if (currentSector !== 'mylist') {
    mylistHeader.classList.add(currentSector.toLowerCase());
  }
  
  // Filter data
  let displayCompanies = [];
  if (currentSector === 'mylist') {
    displayCompanies = companies; // Show all for My List
  } else {
    displayCompanies = companies.filter(c => c.sector === currentSector);
  }

  if (displayCompanies.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#999;">No companies found in this sector.</td></tr>';
      return;
  }

  tbody.innerHTML = displayCompanies.map((c, i) => {
    // Find original index for actions to work correctly on the main array
    const originalIndex = companies.indexOf(c);
    
    let sadDisplay, neutralDisplay, happyDisplay, ragDisplay;
    
    if (c.sad === null || c.neutral === null || c.happy === null) {
      sadDisplay = '<span class="empty-cell">â€”</span>';
      neutralDisplay = '<span class="empty-cell">â€”</span>';
      happyDisplay = '<span class="empty-cell">â€”</span>';
      ragDisplay = '<span class="empty-cell">â€”</span>';
    } else if (c.sad === 'loading') {
      sadDisplay = '<span class="loading-cell">â³</span>';
      neutralDisplay = '<span class="loading-cell">â³</span>';
      happyDisplay = '<span class="loading-cell">â³</span>';
      ragDisplay = '<span class="loading-cell">â³</span>';
    } else {
      sadDisplay = `${c.sad}%`;
      neutralDisplay = `${c.neutral}%`;
      happyDisplay = `${c.happy}%`;
      const ragStatus = getRAG(c.sad, c.happy, c);
      ragDisplay = `<div class="rag-dot rag-${ragStatus}" onclick="editRagStatus(${originalIndex})" title="Click to edit RAG status"></div>`;
    }
    
    return `
    <tr>
      <td><strong>${i + 1}</strong></td>
      <td class="company-name">${c.name}</td>
      <td><span class="sector-badge">${c.sector}</span></td>
      <td class="score-cell score-sad">${sadDisplay}</td>
      <td class="score-cell score-neutral">${neutralDisplay}</td>
      <td class="score-cell score-happy">${happyDisplay}</td>
      <td><div class="rag-cell">${ragDisplay}</div></td>
      <td>
        <div class="actions-cell">
          <button class="action-btn btn-edit" onclick="editCompany(${originalIndex})" title="Edit">âœï¸</button>
          <button class="action-btn btn-delete" onclick="deleteCompany(${originalIndex})" title="Delete">ğŸ—‘ï¸</button>
          <button class="action-btn btn-up" onclick="moveUp(${originalIndex})" title="Move Up">â†‘</button>
          <button class="action-btn btn-down" onclick="moveDown(${originalIndex})" title="Move Down">â†“</button>
        </div>
      </td>
    </tr>
  `}).join('');
}

// Enhanced analyzeAllCompanies function with countdown
// Enhanced analyzeAllCompanies function with countdown - MODIFIED TO ANALYZE ONLY CURRENT TAB
async function analyzeAllCompanies() {
  if (analysisInProgress) {
    showToast('âš ï¸ Analysis already in progress');
    return;
  }
  
  analysisInProgress = true;
  const analyzeBtn = document.getElementById('analyzeBtn');
  const timerDisplay = document.getElementById('timerDisplay');
  const statusDisplay = document.getElementById('statusDisplay');
  
  // Check Timer
  const timerMinutes = parseInt(document.getElementById('timerSelect').value);
  if (timerMinutes > 0) {
      startRefreshTimer(timerMinutes);
  } else {
      if(refreshInterval) clearInterval(refreshInterval);
      document.getElementById('timerLineContainer').style.display = 'none';
  }
  
  analyzeBtn.disabled = true;
  analyzeBtn.innerHTML = '<span class="icon">â³</span><span>Analyzing...</span>';
  
  // Get companies to analyze based on current tab
  let companiesToAnalyze = [];
  if (currentSector === 'mylist') {
    companiesToAnalyze = companies; // Analyze all for My List
  } else {
    companiesToAnalyze = companies.filter(c => c.sector === currentSector);
  }
  
  if (companiesToAnalyze.length === 0) {
    showToast('âš ï¸ No companies to analyze in this tab');
    analysisInProgress = false;
    analyzeBtn.disabled = false;
    analyzeBtn.innerHTML = '<span class="icon">ğŸš€</span><span>Analyze All</span>';
    return;
  }
  
  // Calculate estimated time based on companies in current tab
  estimatedTimeRemaining = Math.round(companiesToAnalyze.length * TIME_PER_COMPANY);
  
  // Start countdown timer
  startCountdownTimer();
  
  let completed = 0;
  const total = companiesToAnalyze.length;
  
  // Use fixed delay of 11.69 seconds per company
  const delay = 11690; // 11.69 seconds in milliseconds
  
  for (let i = 0; i < companiesToAnalyze.length; i++) {
    const company = companiesToAnalyze[i];
    
    // Find the index of this company in the main companies array
    const companyIndex = companies.findIndex(c => c === company);
    
    if (companyIndex === -1) continue; // Skip if not found
    
    // Update status in data
    companies[companyIndex].sad = 'loading';
    companies[companyIndex].neutral = 'loading';
    companies[companyIndex].happy = 'loading';
    renderTable();
    
    timerDisplay.textContent = `Analyzing ${company.name}...`;
    statusDisplay.textContent = `Processing ${completed + 1} of ${total} (${currentSector === 'mylist' ? 'My List' : currentSector})`;
    
    try {
      const response = await fetch(`${API_URL}/api/analyze-single`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ company_name: company.name })
      });
      
      const data = await response.json();
      
      if (data.result) {
        companies[companyIndex].sad = data.result.sad;
        companies[companyIndex].neutral = data.result.neutral;
        companies[companyIndex].happy = data.result.happy;
      } else {
        companies[companyIndex].sad = null; 
        companies[companyIndex].neutral = null; 
        companies[companyIndex].happy = null;
      }
    } catch (error) {
      console.error(`Error analyzing ${company.name}:`, error);
      companies[companyIndex].sad = null; 
      companies[companyIndex].neutral = null; 
      companies[companyIndex].happy = null;
    }
    
    renderTable();
    completed++;
    
    if (i < companiesToAnalyze.length - 1) {
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  
  analysisInProgress = false;
  analyzeBtn.disabled = false;
  analyzeBtn.innerHTML = '<span class="icon">ğŸš€</span><span>Analyze All</span>';
  timerDisplay.textContent = 'Complete!';
  statusDisplay.textContent = `Analyzed ${total} companies in ${currentSector === 'mylist' ? 'My List' : currentSector}`;
  
  // Stop countdown timer
  stopCountdownTimer();
  
  showToast(`âœ… Analysis completed for ${total} companies in ${currentSector === 'mylist' ? 'My List' : currentSector}!`);
}

function startRefreshTimer(minutes) {
    if (refreshInterval) clearInterval(refreshInterval);
    
    const container = document.getElementById('timerLineContainer');
    const fill = document.getElementById('timerLineFill');
    const timeText = document.getElementById('timerTextTime');
    
    container.style.display = 'block';
    
    const duration = minutes * 60 * 1000;
    const endTime = Date.now() + duration;
    
    refreshInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now;
        
        if (remaining <= 0) {
            clearInterval(refreshInterval);
            fill.style.width = '0%';
            timeText.textContent = 'Refreshing...';
            location.reload();
            return;
        }
        
        // Calculate percentage
        const percent = (remaining / duration) * 100;
        fill.style.width = percent + '%';
        
        // Format time mm:ss
        const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((remaining % (1000 * 60)) / 1000);
        timeText.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        
        // Change colors based on remaining percentage
        fill.className = 'timer-line-fill'; // reset
        if (percent < 20) fill.classList.add('danger');
        else if (percent < 50) fill.classList.add('warning');
        
    }, 1000);
}

function openModal(index = -1) {
  editIndex = index;
  document.getElementById('modalTitle').textContent = index === -1 ? 'âœ¨ Add Company' : 'âœï¸ Edit Company';
  if (index >= 0) {
    const c = companies[index];
    document.getElementById('companyName').value = c.name;
    document.getElementById('sectorSelect').value = c.sector;
  } else {
    document.getElementById('companyName').value = '';
    document.getElementById('sectorSelect').value = 'Semiconductor';
  }
  document.getElementById('modalOverlay').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  editIndex = -1;
}

function saveCompany() {
  const name = document.getElementById('companyName').value.trim();
  if (!name) { showToast('âš ï¸ Please enter company name'); return; }
  const sector = document.getElementById('sectorSelect').value;
  
  const company = {name, sector, sad: null, neutral: null, happy: null};
  if (editIndex >= 0) {
    companies[editIndex].name = name;
    companies[editIndex].sector = sector;
    showToast('âœ… Company updated successfully!');
  } else {
    companies.push(company);
    showToast('âœ… Company added successfully!');
  }
  renderTable();
  closeModal();
}

function editCompany(i) { openModal(i); }

function deleteCompany(i) {
  if (confirm(`Delete "${companies[i].name}"?`)) {
    companies.splice(i, 1);
    renderTable();
    showToast('ğŸ—‘ï¸ Company deleted!');
  }
}

function moveUp(i) {
  if (i > 0) {
    [companies[i], companies[i-1]] = [companies[i-1], companies[i]];
    renderTable();
    showToast('â¬†ï¸ Moved up!');
  }
}

function moveDown(i) {
  if (i < companies.length - 1) {
    [companies[i], companies[i+1]] = [companies[i+1], companies[i]];
    renderTable();
    showToast('â¬‡ï¸ Moved down!');
  }
}

function addNewKeyword() {
    const keyword = prompt('Enter a new keyword:');
    if (keyword && keyword.trim()) {
        const trimmedKeyword = keyword.trim();
        const emotion = prompt('Select emotion (happy/neutral/sad):');
        if (emotion && ['happy', 'neutral', 'sad'].includes(emotion.toLowerCase())) {
            const emotionKey = emotion.toLowerCase();
            if (!emotions[emotionKey].keywords.includes(trimmedKeyword)) {
                emotions[emotionKey].keywords.push(trimmedKeyword);
                emotions[emotionKey].keywords.sort();
                
                // Save to localStorage
                saveEmotionsToLocalStorage();
                
                // Refresh modal
                populateKeywordModal();
                
                showToast('âœ… New keyword added successfully!');
            } else {
                showToast('âš ï¸ Keyword already exists!');
            }
        } else {
            showToast('âš ï¸ Please enter a valid emotion (happy, neutral, or sad)');
        }
    }
}

function showQuickStart() {
  showToast('ğŸš€ Starting quick demo...');
  // Add demo companies
  companies.push(
    {name: "Demo Corp", sector: "Technology", sad: null, neutral: null, happy: null},
    {name: "Test Inc", sector: "Finance", sad: null, neutral: null, happy: null}
  );
  renderTable();
  closeGuideModal();
}

// Initialize on DOM loaded
document.addEventListener('DOMContentLoaded', function() {
  // Event listeners
  document.getElementById('analyzeBtn').addEventListener('click', analyzeAllCompanies);
  document.getElementById('testBtn').addEventListener('click', openTestModal);
  document.getElementById('mylistNameDisplay').addEventListener('click', enableMyListNameEdit);
  document.getElementById('guideBtn').addEventListener('click', () => handleMyListAction('guide'));
  document.getElementById('keywordRefBtn').addEventListener('click', () => handleMyListAction('keyword'));
  document.getElementById('exportBtn').addEventListener('click', () => handleMyListAction('export'));
  document.getElementById('compareBtn').addEventListener('click', () => handleMyListAction('compare'));
  
  // Add edit keyword modal click handler
  document.getElementById('editKeywordModalOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
      closeEditKeywordModal();
    }
  });

  loadEmotionsFromLocalStorage();
  
  // Add tab button
  document.getElementById('addTabBtn').addEventListener('click', openAddTabModal);
  
  // RAG edit options selection
  document.querySelectorAll('.rag-edit-option').forEach(option => {
    option.addEventListener('click', function() {
      document.querySelectorAll('.rag-edit-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
    });
  });
  
  // Color selection for new tab
  document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', function() {
      document.querySelectorAll('.color-option').forEach(opt => opt.style.border = '2px solid transparent');
      this.style.border = '2px solid #667eea';
    });
  });
  
  // Tab switching
// Update the tab switching event listener
document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentSector = this.getAttribute('data-sector');
    renderTable();
    
    // Update estimated analysis time for this tab
    if (!analysisInProgress) {
      const totalSeconds = calculateTotalAnalysisTime();
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = Math.round(totalSeconds % 60);
      const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
      document.getElementById('timerDisplay').textContent = `Est: ${timeStr}`;
    }
  });
});
  
  // Setup tab scrolling
  setupTabScroll();
  
  // Import file change handler
  document.getElementById('importFile').addEventListener('change', function(e) {
    if (this.files.length > 0) {
      selectedFile = this.files[0];
      const fileNameDisplay = document.getElementById('selectedFileName');
      fileNameDisplay.textContent = `Selected: ${selectedFile.name} (${(selectedFile.size / 1024).toFixed(1)} KB)`;
      fileNameDisplay.style.color = '#667eea';
    }
  });
  
  // Export option click handlers
  document.querySelectorAll('.export-option').forEach(option => {
    option.addEventListener('click', function() {
      const format = this.getAttribute('data-format');
      selectExportOption(format);
    });
  });
  
  // Import option click handlers
  document.querySelectorAll('.import-option').forEach(option => {
    option.addEventListener('click', function() {
      const format = this.getAttribute('onclick').includes('csv') ? 'csv' : 'json';
      selectImportOption(format);
    });
  });
  
  // Modal close on outside click - UPDATED WITH FIXED MODAL ID
  const modals = ['guideModal', 'keywordModal', 'exportModal', 'compareModal', 
                  'testModal', 'editRagModal', 'addTabModal', 'modalOverlay', 
                  'editKeywordModalOverlay']; // UPDATED ID
  
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          const closeFunc = {
            'guideModal': closeGuideModal,
            'keywordModal': closeKeywordModal,
            'exportModal': closeExportModal,
            'compareModal': closeCompareModal,
            'testModal': closeTestModal,
            'editRagModal': closeEditRagModal,
            'addTabModal': closeAddTabModal,
            'modalOverlay': closeModal,
            'editKeywordModalOverlay': closeEditKeywordModal // UPDATED
          }[modalId];
          closeFunc();
        }
      });
    }
  });
  
  // Calculate and show initial estimated time
const totalSeconds = calculateTotalAnalysisTime();
const minutes = Math.floor(totalSeconds / 60);
const seconds = Math.round(totalSeconds % 60);
const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
document.getElementById('timerDisplay').textContent = `Est: ${timeStr}`;
setTimeout(() => {
  if (!analysisInProgress) {
    document.getElementById('timerDisplay').textContent = 'Ready';
  }
}, 3000);
  
  // Initial render
  renderTable();
});
</script>
</body>

{% endblock %}