{% extends "base.html" %}
{% block title %}Sector Emotion{% endblock %}
{% block content %}

<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }

.header { background: linear-gradient(135deg, #ff6b9d, #c44569, #ff6b9d); padding: 22px; text-align: center; border-radius: 16px; margin-bottom: 20px; position: relative; overflow: hidden; }
.header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.15), transparent); animation: shimmer 3s infinite; }
@keyframes shimmer { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }
.header h1 { font-size: 26px; color: white; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); position: relative; z-index: 1; }
/* Highlight for search terms */
.highlight {
    background: #fff9c4;
    padding: 1px 3px;
    border-radius: 3px;
    font-weight: 600;
    color: #333;
}

/* Keyword weight badge */
.keyword-weight {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    font-size: 10px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 8px;
    margin-left: 6px;
}

/* REMOVED: Edit Keyword Modal CSS completely */

/* Enhanced Keyword Modal Styles */
.keyword-tabs-nav {
  display: flex;
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border-bottom: 1px solid #e9ecef;
  padding: 0 30px;
  overflow-x: auto;
}

.keyword-tab-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 15px 20px;
  border: none;
  background: none;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  white-space: nowrap;
  position: relative;
}

.keyword-tab-btn:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.keyword-tab-btn.active {
  color: #667eea;
  border-bottom: 3px solid #667eea;
  background: rgba(102, 126, 234, 0.1);
}

.keyword-count-badge {
  background: #e9ecef;
  color: #666;
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 10px;
  min-width: 24px;
  text-align: center;
}

.keyword-tab-btn.active .keyword-count-badge {
  background: #667eea;
  color: white;
}

/* Keywords Container */
.keywords-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  max-height: 500px;
  overflow-y: auto;
  padding: 20px 0;
}

.keyword-item {
  background: white;
  border-radius: 12px;
  padding: 15px;
  border: 2px solid #e9ecef;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.keyword-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  border-color: #667eea;
}

.keyword-item.happy {
  border-left: 4px solid #4caf50;
  background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
}

.keyword-item.neutral {
  border-left: 4px solid #ff9800;
  background: linear-gradient(135deg, #fff3e0, #fff8e1);
}

.keyword-item.sad {
  border-left: 4px solid #f44336;
  background: linear-gradient(135deg, #ffebee, #fce4ec);
}

.keyword-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.keyword-text {
  font-weight: 600;
  font-size: 14px;
  color: #1a1a2e;
  word-break: break-word;
  flex: 1;
}

.keyword-score-weight {
  display: flex;
  align-items: center;
  gap: 6px;
}

.keyword-score {
  background: rgba(255,255,255,0.8);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  min-width: 24px;
  text-align: center;
}

.keyword-weight-badge {
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
  font-size: 10px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 8px;
  min-width: 20px;
  text-align: center;
}

.keyword-item.happy .keyword-score {
  background: rgba(76, 175, 80, 0.1);
  color: #2e7d32;
}

.keyword-item.neutral .keyword-score {
  background: rgba(255, 152, 0, 0.1);
  color: #f57c00;
}

.keyword-item.sad .keyword-score {
  background: rgba(244, 67, 54, 0.1);
  color: #c62828;
}

.keyword-emotion {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-top: 8px;
}

.keyword-item.happy .keyword-emotion {
  background: rgba(76, 175, 80, 0.15);
  color: #2e7d32;
}

.keyword-item.neutral .keyword-emotion {
  background: rgba(255, 152, 0, 0.15);
  color: #f57c00;
}

.keyword-item.sad .keyword-emotion {
  background: rgba(244, 67, 54, 0.15);
  color: #c62828;
}

/* Danger Button */
.btn-danger {
  background: linear-gradient(135deg, #f44336, #c62828);
  color: white;
  box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
  border: none;
  border-radius: 12px;
  padding: 14px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-danger:hover {
  box-shadow: 0 6px 20px rgba(244, 67, 54, 0.5);
  transform: translateY(-2px);
}

/* Empty State */
.empty-keywords-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.empty-keywords-state .icon {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

/* Responsive Design */
@media (max-width: 768px) {
  .keywords-container {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
  }
  
  .keyword-tabs-nav {
    padding: 0 15px;
  }
  
  .keyword-tab-btn {
    padding: 12px 15px;
    font-size: 13px;
  }
}

/* Navigation with Scrollable Tabs */
.nav-bar-container {
    position: relative;
    margin-bottom: 25px;
    width: 100%;
    overflow: hidden;
}

.nav-bar { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: thin;
    scrollbar-color: #667eea transparent;
    padding: 10px 0;
    margin: 0 50px;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
}

.nav-bar::-webkit-scrollbar {
    height: 6px;
}

.nav-bar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.nav-bar::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 3px;
}

.nav-bar::-webkit-scrollbar-thumb:hover {
    background: #764ba2;
}

.nav-btn { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    padding: 11px 18px; 
    border-radius: 30px; 
    border: none; 
    background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
    cursor: pointer; 
    font-size: 13px; 
    font-weight: 600; 
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
    position: relative;
    flex-shrink: 0;
    white-space: nowrap;
}
.nav-btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
.nav-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
.nav-btn .icon { font-size: 16px; }

/* Add Tab Button */
.add-tab-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4caf50, #2e7d32);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 24px;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(76,175,80,0.4);
    margin-left: 5px;
    flex-shrink: 0;
}

.add-tab-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(76,175,80,0.5);
}

/* Remove button for custom tabs */
.nav-btn .remove-tab {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 18px;
    height: 18px;
    background: #e53935;
    color: white;
    border-radius: 50%;
    border: none;
    font-size: 10px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0;
    z-index: 2;
}

.nav-btn.custom-tab:hover .remove-tab {
    display: flex;
}

/* Scroll arrows */
.scroll-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(102,126,234,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.scroll-arrow:hover {
    transform: translateY(-50%) scale(1.1);
}

.scroll-arrow-left {
    left: 0;
}

.scroll-arrow-right {
    right: 0;
}

.scroll-arrow.hidden {
    display: none;
}

/* MyList Container Header Styles */
.mylist-header { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    margin-bottom: 15px; 
    padding: 14px 20px; 
    background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
    border-radius: 14px; 
    flex-wrap: wrap;
}
.mylist-title { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    flex: 1;
}

.mylist-title span:first-child { 
    font-size: 22px; 
}
.mylist-name-edit { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
}
.mylist-name-display { 
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600; 
    color: #1565c0; 
    font-size: 15px; 
    cursor: pointer; 
    padding: 4px 8px; 
    border-radius: 6px; 
    transition: all 0.2s; 
}
.mylist-name-display:hover { 
    background: rgba(255,255,255,0.5); 
}
.mylist-name-display:hover .edit-icon-container {
    opacity: 1;
}
.edit-icon-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    opacity: 0.6;
    transition: opacity 0.2s;
}
.edit-icon {
    font-size: 14px;
}

.mylist-name-input { 
    background: white; 
    border: 1px solid #90caf9; 
    border-radius: 8px; 
    padding: 4px 8px; 
    color: #1565c0; 
    font-weight: 600; 
    width: 150px; 
    font-size: 15px; 
}
.mylist-name-input:focus { 
    outline: none; 
    border-color: #42a5f5; 
    box-shadow: 0 0 0 2px rgba(66,165,245,0.2); 
}

/* Action Buttons in MyList Container */
.mylist-actions { 
    display: flex; 
    gap: 8px; 
    flex-wrap: wrap;
}
.mylist-action-btn { 
    display: flex; 
    align-items: center; 
    gap: 6px; 
    padding: 8px 12px; 
    border-radius: 20px; 
    border: none; 
    background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
    cursor: pointer; 
    font-size: 12px; 
    font-weight: 600; 
    transition: all 0.3s; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
}
.mylist-action-btn:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
}
.mylist-action-btn.guide { 
    background: linear-gradient(135deg, #4fc3f7, #0288d1); 
    color: white; 
}
.mylist-action-btn.keyword { 
    background: linear-gradient(135deg, #81c784, #388e3c); 
    color: white; 
}
.mylist-action-btn.export { 
    background: linear-gradient(135deg, #ffb74d, #f57c00); 
    color: white; 
}
.mylist-action-btn.compare { 
    background: linear-gradient(135deg, #ba68c8, #7b1fa2); 
    color: white; 
}

/* Layout */
.main-content { display: flex; gap: 25px; flex-wrap: wrap; }
.sidebar { width: 230px; flex-shrink: 0; }
@media (max-width: 900px) { 
    .sidebar { width: 100%; } 
    .main-content { flex-direction: column; } 
    .mylist-header { flex-direction: column; align-items: flex-start; }
    .mylist-actions { justify-content: flex-start; width: 100%; }
}
.sidebar-box { background: linear-gradient(180deg, #f8f9fa, #fff); border-radius: 18px; padding: 22px; box-shadow: 0 10px 35px rgba(0,0,0,0.08); border: 1px solid rgba(102,126,234,0.15); }
.sidebar-title { font-weight: 700; margin-bottom: 18px; color: #1a1a2e; font-size: 15px; display: flex; align-items: center; gap: 8px; }

/* Analysis Section */
.analysis-section { margin-top: 20px; padding: 18px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 14px; }
.analysis-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; margin-top: 15px; }
.analysis-header:first-child { margin-top: 0; }
.analysis-icon { font-size: 22px; }
.analysis-label { font-weight: 600; color: #1565c0; font-size: 14px; }
.analysis-select { width: 100%; padding: 11px 14px; border-radius: 10px; border: 2px solid #90caf9; background: white; font-size: 13px; cursor: pointer; transition: all 0.3s; margin-bottom: 10px; }
.analysis-select:focus { outline: none; border-color: #42a5f5; box-shadow: 0 0 0 4px rgba(66,165,245,0.2); }
.analyze-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.4); display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
.analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.5); }
.analyze-btn:disabled { background: #bdbdbd; cursor: not-allowed; transform: none; box-shadow: none; }

/* Test Button */
.test-btn { 
    width: 100%; 
    padding: 12px; 
    border: none; 
    border-radius: 12px; 
    background: linear-gradient(135deg, #4caf50, #2e7d32); 
    color: white; 
    font-weight: 600; 
    font-size: 14px; 
    cursor: pointer; 
    transition: all 0.3s; 
    box-shadow: 0 4px 15px rgba(76,175,80,0.4); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 8px; 
    margin-top: 15px;
}
.test-btn:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 6px 20px rgba(76,175,80,0.5); 
}
.test-btn:disabled { 
    background: #bdbdbd; 
    cursor: not-allowed; 
    transform: none; 
    box-shadow: none; 
}

/* Status & Timer */
.timer-display { text-align: center; margin-top: 15px; font-size: 14px; font-weight: 600; color: #1565c0; }
.status-display { text-align: center; margin-top: 5px; font-size: 12px; color: #666; }

/* Line Timer Styles */
.timer-line-container {
    margin-top: 15px;
    display: none; /* Hidden by default */
}
.timer-text-small {
    font-size: 11px;
    color: #666;
    margin-bottom: 5px;
    display: flex;
    justify-content: space-between;
}
.timer-line-track {
    width: 100%;
    height: 6px;
    background: rgba(255,255,255,0.5);
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.8);
}
.timer-line-fill {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #43a047, #66bb6a);
    border-radius: 10px;
    transition: width 1s linear, background 0.3s;
}
.timer-line-fill.warning { background: linear-gradient(90deg, #fdd835, #ffee58); }
.timer-line-fill.danger { background: linear-gradient(90deg, #e53935, #ef5350); }

/* Table */
.table-container { flex: 1; min-width: 0; }
.table-wrapper { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th { background: linear-gradient(135deg, #00897b, #00796b); color: white; padding: 16px 12px; text-align: center; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
.data-table td { padding: 14px 10px; text-align: center; border-bottom: 1px solid #eee; font-size: 13px; transition: all 0.3s; }
.data-table tbody tr:hover { background: linear-gradient(135deg, #e0f7fa, #e8f5e9); }
.data-table tbody tr:nth-child(even) { background: #fafbfc; }
.emoji { font-size: 20px; display: block; margin-bottom: 4px; }
.score-cell { font-weight: 600; font-size: 13px; }
.score-sad { color: #e53935; }
.score-neutral { color: #f57c00; }
.score-happy { color: #43a047; }
.rag-cell { display: flex; justify-content: center; }
.rag-dot { 
    width: 26px; 
    height: 26px; 
    border-radius: 50%; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
    transition: all 0.3s; 
    cursor: pointer; 
    position: relative;
}
.rag-dot:hover { transform: scale(1.25); }
.rag-green { background: linear-gradient(135deg, #66bb6a, #43a047); }
.rag-yellow { background: linear-gradient(135deg, #ffee58, #fdd835); }
.rag-red { background: linear-gradient(135deg, #ef5350, #e53935); }
.rag-header { display: flex; gap: 4px; justify-content: center; margin-bottom: 4px; }
.rag-header span { width: 12px; height: 12px; border-radius: 50%; }
.company-name { font-weight: 600; color: #1a1a2e; }
.sector-badge { display: inline-block; padding: 5px 12px; background: linear-gradient(135deg, #ede7f6, #d1c4e9); color: #5e35b1; border-radius: 20px; font-size: 11px; font-weight: 600; }
.empty-cell { color: #bdbdbd; font-style: italic; }
.loading-cell { color: #667eea; font-weight: 600; animation: pulse 1.5s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* Enhanced Actions Cell */
.actions-cell { 
    display: flex; 
    gap: 6px; 
    justify-content: center; 
    flex-wrap: wrap;
    min-height: 40px;
    align-items: center;
}

.action-btn { 
    width: 32px; 
    height: 32px; 
    border-radius: 10px; 
    border: none; 
    cursor: pointer; 
    font-size: 14px; 
    transition: all 0.3s; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.action-btn:hover { 
    transform: translateY(-3px) scale(1.1); 
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

.btn-edit { 
    background: linear-gradient(135deg, #42a5f5, #1e88e5); 
    color: white;
}

.btn-delete { 
    background: linear-gradient(135deg, #ef5350, #e53935); 
    color: white;
}

.btn-up { 
    background: linear-gradient(135deg, #66bb6a, #43a047); 
    color: white;
}

.btn-down { 
    background: linear-gradient(135deg, #ffa726, #fb8c00); 
    color: white;
}

.add-row-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 16px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border: 2px dashed #81c784; cursor: pointer; transition: all 0.3s; color: #2e7d32; font-weight: 600; font-size: 14px; }
.add-row-btn:hover { background: linear-gradient(135deg, #c8e6c9, #a5d6a7); border-color: #66bb6a; }

/* Fixed Modal Overlay (removed backdrop-filter) */
.modal-overlay { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.6); 
    justify-content: center; 
    align-items: center; 
    z-index: 1000; 
    padding: 20px;
}

.modal { 
    background: white; 
    border-radius: 24px; 
    padding: 30px; 
    width: 95%; 
    max-width: 420px; 
    box-shadow: 0 25px 80px rgba(0,0,0,0.3); 
    animation: modalIn 0.4s ease; 
    max-height: 90vh;
    overflow-y: auto;
    margin: auto;
    position: relative;
    display: flex;
    flex-direction: column;
}

@keyframes modalIn { 
    from { 
        opacity: 0; 
        transform: scale(0.9) translateY(20px); 
    } 
    to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
    } 
}

.modal h2 { margin-bottom: 25px; color: #1a1a2e; font-size: 22px; display: flex; align-items: center; gap: 10px; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; font-size: 13px; }
.form-group input, .form-group select { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px; transition: all 0.3s; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.15); }
.modal-actions { display: flex; gap: 12px; margin-top: 25px; }
.modal-btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
.modal-btn:hover { transform: translateY(-2px); }
.btn-cancel { background: #f5f5f5; color: #666; }
.btn-cancel:hover { background: #eeeeee; }
.btn-save { background: linear-gradient(135deg, #667eea, #764ba2); color: white; box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
.btn-save:hover { box-shadow: 0 6px 20px rgba(102,126,234,0.5); }
.toast { position: fixed; bottom: 30px; right: 30px; padding: 16px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 14px; font-weight: 500; box-shadow: 0 10px 40px rgba(0,0,0,0.3); transform: translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 2000; }
.toast.show { transform: translateY(0); opacity: 1; }
.loading-bar { height: 4px; background: linear-gradient(90deg, #667eea, #764ba2, #667eea); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 2px; margin-bottom: 15px; }
@keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

/* Tab-specific MyList header styles */
.mylist-header.semiconductor { background: linear-gradient(135deg, #e3f2fd, #bbdefb); }
.mylist-header.pharma { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); }
.mylist-header.electricity { background: linear-gradient(135deg, #fff3e0, #ffe0b2); }
.mylist-header.mining { background: linear-gradient(135deg, #fbe9e7, #ffccbc); }
.mylist-header.automobile { background: linear-gradient(135deg, #f3e5f5, #e1bee7); }
.mylist-header.quantum { background: linear-gradient(135deg, #e0f2f1, #b2dfdb); }
.mylist-header.finance { background: linear-gradient(135deg, #e8eaf6, #c5cae9); }
.mylist-header.retail { background: linear-gradient(135deg, #fff8e1, #ffecb3); }
.mylist-header.technology { background: linear-gradient(135deg, #f3e5f5, #e1bee7); }

/* Enhanced Modal Styles */
.guide-modal, .keyword-modal, .export-modal, .compare-modal, .test-modal, .edit-rag-modal, .add-tab-modal {
    max-width: 900px;
    width: 95%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    margin: auto;
}

.modal-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px 30px;
    border-radius: 20px 20px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.modal-header h2 {
    color: white;
    margin: 0;
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.3s;
}

.modal-close:hover {
    background: rgba(255,255,255,0.2);
}

.modal-body {
    padding: 30px;
    flex: 1;
    overflow-y: auto;
    max-height: calc(90vh - 140px);
}

/* Fixed Modal Actions Sticky Footer */
.modal-actions-sticky {
    padding: 20px 30px;
    background: rgba(248, 249, 250, 0.95);
    border-top: 1px solid #e9ecef;
    border-radius: 0 0 20px 20px;
    display: flex;
    gap: 12px;
    flex-shrink: 0;
    position: sticky;
    bottom: 0;
    z-index: 10;
}

.modal-actions-sticky .modal-btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-actions-sticky .modal-btn:hover {
    transform: translateY(-2px);
}

.modal-actions-sticky .btn-cancel {
    background: #f5f5f5;
    color: #666;
}

.modal-actions-sticky .btn-cancel:hover {
    background: #eeeeee;
}

.modal-actions-sticky .btn-save {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 4px 15px rgba(102,126,234,0.4);
}

.modal-actions-sticky .btn-save:hover {
    box-shadow: 0 6px 20px rgba(102,126,234,0.5);
}

/* Test Action Buttons */
.test-action-buttons {
    display: flex;
    gap: 12px;
    margin: 20px 0;
    padding: 15px 0;
    border-top: 1px solid #e9ecef;
    border-bottom: 1px solid #e9ecef;
}

.test-action-buttons .modal-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

/* Visual Charts Styles */
.chart-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    color: #1a1a2e;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.sentiment-chart {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.chart-bar {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    position: relative;
    overflow: hidden;
}

.chart-bar-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-weight: 600;
    color: #1a1a2e;
}

.chart-bar-track {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

.chart-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 1s ease-in-out;
    position: relative;
}

.chart-bar-fill.happy { background: linear-gradient(90deg, #4caf50, #66bb6a); }
.chart-bar-fill.neutral { background: linear-gradient(90deg, #ff9800, #ffb74d); }
.chart-bar-fill.sad { background: linear-gradient(90deg, #f44336, #ef5350); }

.chart-bar-value {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: 600;
    color: #1a1a2e;
    text-shadow: 0 0 2px white;
}

/* Pie Chart Styles */
.pie-chart-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 20px 0;
}

.pie-chart {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background: conic-gradient(
        #4caf50 0% var(--happy-percent, 0%),
        #ff9800 var(--happy-percent, 0%) calc(var(--happy-percent, 0%) + var(--neutral-percent, 0%)),
        #f44336 calc(var(--happy-percent, 0%) + var(--neutral-percent, 0%)) 100%
    );
    position: relative;
}

.pie-chart-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #1a1a2e;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.pie-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.legend-color.happy { background: #4caf50; }
.legend-color.neutral { background: #ff9800; }
.legend-color.sad { background: #f44336; }

/* Guide Modal Specific Styles */
.guide-section {
    margin-bottom: 30px;
}

.guide-section h3 {
    color: #1a1a2e;
    margin-bottom: 15px;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.guide-section p {
    color: #555;
    line-height: 1.6;
    margin-bottom: 15px;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.feature-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid #667eea;
}

.feature-card h4 {
    color: #1a1a2e;
    margin-bottom: 10px;
    font-size: 16px;
}

.feature-card ul {
    list-style: none;
    padding: 0;
}

.feature-card li {
    padding: 5px 0;
    color: #555;
    display: flex;
    align-items: center;
    gap: 8px;
}

.feature-card li:before {
    content: "âœ“";
    color: #4caf50;
    font-weight: bold;
}

/* FIXED: Keyword Modal Specific Styles */
.keyword-modal-body {
    padding: 30px;
    flex: 1;
    overflow-y: auto;
    max-height: calc(90vh - 140px);
}

/* Imported files info in keyword modal */
.imported-files-info {
    padding: 0 30px 15px 30px;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 15px;
    display: none;
}

.emotion-categories {
    display: flex;
    flex-direction: column;
    gap: 25px;
    margin: 20px 0;
}

.emotion-category {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.05);
}

.emotion-category-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(0,0,0,0.05);
}

.emotion-emoji {
    font-size: 36px;
}

.emotion-title {
    font-size: 22px;
    font-weight: 700;
    color: #1a1a2e;
    margin: 0;
    flex: 1;
}

.emotion-count {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
}

.keyword-list-container {
    max-height: 300px;
    overflow-y: auto;
    background: #f8f9fa;
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid #e9ecef;
}

.keyword-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
}

.keyword-tag {
    background: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    color: #333;
    border: 1px solid #dee2e6;
    transition: all 0.2s;
    text-align: center;
    word-break: break-word;
}

.keyword-tag.happy { 
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9); 
    color: #2e7d32;
    border-color: #a5d6a7;
}
.keyword-tag.neutral { 
    background: linear-gradient(135deg, #f5f5f5, #eeeeee); 
    color: #616161;
    border-color: #e0e0e0;
}
.keyword-tag.sad { 
    background: linear-gradient(135deg, #ffebee, #ffcdd2); 
    color: #c62828;
    border-color: #ef9a9a;
}

.keyword-tag:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Search bar for keywords */
.keyword-search {
    margin-bottom: 20px;
    position: relative;
}

.keyword-search input {
    width: 100%;
    padding: 14px 20px 14px 45px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 14px;
    transition: all 0.3s;
    background: white;
}

.keyword-search input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
}

.keyword-search .search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    color: #999;
}

/* Export Modal Specific Styles */
.export-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.export-option {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.export-option:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.export-option.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, #f0f4ff, #e3f2fd);
}

.export-option .icon {
    font-size: 32px;
    margin-bottom: 10px;
}

.export-option h4 {
    color: #1a1a2e;
    margin-bottom: 8px;
}

.export-option p {
    color: #666;
    font-size: 12px;
}

/* Compare Modal Specific Styles */
.comparison-results {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
}

.comparison-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.comparison-item:last-child {
    margin-bottom: 0;
}

.comparison-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #1a1a2e;
}

.comparison-value {
    font-weight: 600;
    color: #667eea;
}

/* Test Modal Specific Styles */
.test-results {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
}

.score-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.score-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.score-value {
    font-size: 24px;
    font-weight: bold;
    margin: 10px 0;
}

.score-label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.keyword-highlight {
    background: #fff9c4;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 500;
}

.keyword-highlight.positive {
    background: #c8e6c9;
    color: #2e7d32;
}

.keyword-highlight.negative {
    background: #ffcdd2;
    color: #c62828;
}

/* NEW: RAG Edit Modal Styles */
.rag-edit-options {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 30px 0;
    flex-wrap: wrap;
}

.rag-edit-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 20px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9fa;
    border: 2px solid transparent;
    width: 120px;
}

.rag-edit-option:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.rag-edit-option.selected {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}

.rag-edit-dot {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.rag-edit-dot.green { background: linear-gradient(135deg, #66bb6a, #43a047); }
.rag-edit-dot.yellow { background: linear-gradient(135deg, #ffee58, #fdd835); }
.rag-edit-dot.red { background: linear-gradient(135deg, #ef5350, #e53935); }

/* NEW: Test Company Input Section */
.test-company-input-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid #e9ecef;
}

.test-company-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.test-company-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 14px;
    transition: all 0.3s;
}

.test-company-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
}

.add-company-test-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, #42a5f5, #1e88e5);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
}

.add-company-test-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(66,165,245,0.4);
}

.test-companies-list {
    margin-top: 15px;
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.test-company-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 4px solid #42a5f5;
}

.test-company-item:last-child {
    margin-bottom: 0;
}

.test-company-name {
    font-weight: 600;
    color: #1a1a2e;
}

.test-company-keywords {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

.remove-test-company {
    background: #ef5350;
    color: white;
    border: none;
    border-radius: 6px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
}

.remove-test-company:hover {
    background: #e53935;
    transform: scale(1.1);
}

/* Enhanced responsive design for modals */
@media (max-width: 768px) {
    .modal {
        width: 98%;
        margin: 10px;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-header {
        padding: 15px 20px;
    }
    
    .modal-actions-sticky {
        padding: 15px 20px;
        flex-direction: column;
    }
    
    .sentiment-chart {
        grid-template-columns: 1fr;
    }
    
    .test-action-buttons {
        flex-direction: column;
    }
    
    .feature-grid,
    .keyword-categories,
    .export-options {
        grid-template-columns: 1fr;
    }
    
    .rag-edit-options {
        flex-direction: column;
        align-items: center;
    }
    
    .rag-edit-option {
        width: 100%;
        max-width: 200px;
    }
    
    .test-company-input-row {
        flex-direction: column;
    }
    
    .nav-bar {
        margin: 0 40px;
    }
    
    .scroll-arrow {
        width: 35px;
        height: 35px;
        font-size: 16px;
    }
    
    .keyword-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    
    .emotion-category-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .emotion-count {
        align-self: flex-start;
    }
}

/* Enhanced scrollbar for modal body */
.modal-body::-webkit-scrollbar {
    width: 6px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Scrollbar for keyword lists */
.keyword-list-container::-webkit-scrollbar {
    width: 6px;
}

.keyword-list-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.keyword-list-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.keyword-list-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* ENHANCED: Test Modal Additional Styles */
.sentiment-summary {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.chart-bar-details {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
    display: flex;
    justify-content: space-between;
}

.keyword-analysis-details {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.top-keyword-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    margin: 3px;
    transition: all 0.2s;
}

.top-keyword-tag.positive {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    color: #2e7d32;
    border: 1px solid #a5d6a7;
}

.top-keyword-tag.negative {
    background: linear-gradient(135deg, #ffebee, #ffcdd2);
    color: #c62828;
    border: 1px solid #ef9a9a;
}

.top-keyword-tag.neutral {
    background: linear-gradient(135deg, #f5f5f5, #eeeeee);
    color: #616161;
    border: 1px solid #e0e0e0;
}

.top-keyword-tag .score-badge {
    background: rgba(255,255,255,0.8);
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
}

/* ENHANCED: Import/Export Modal Styles */
.import-section {
    background: linear-gradient(135deg, #f0f4ff, #e3f2fd);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 2px solid #e0e0e0;
}

.import-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.import-option {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.import-option:hover {
    border-color: #42a5f5;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(66,165,245,0.2);
}

.import-option.selected {
    border-color: #42a5f5;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
}

.import-option .icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.import-option h4 {
    color: #1a1a2e;
    margin-bottom: 5px;
    font-size: 14px;
}

.import-option p {
    color: #666;
    font-size: 11px;
}

/* Enhanced keyword list styling */
.keyword-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.keyword-category {
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.keyword-category h4 {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    color: #1a1a2e;
    font-size: 16px;
}

/* Import/Export modal responsive design */
@media (max-width: 768px) {
    .import-options,
    .export-options {
        grid-template-columns: 1fr;
    }
    
    .sentiment-summary {
        padding: 15px;
    }
    
    .keyword-analysis-details > div {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
<div class="container">
  <div class="header"><h1>ğŸ“Š Sector Sentiment Analysis</h1></div>
  <div class="loading-bar"></div>
  
  <!-- Scrollable Navigation with Arrows -->
  <div class="nav-bar-container">
    <button class="scroll-arrow scroll-arrow-left" id="scrollLeft">â€¹</button>
    <div class="nav-bar" id="navBar">
      <button class="nav-btn active" data-sector="mylist"><span class="icon">ğŸ“‹</span><span class="tab-name">My List</span></button>
      <button class="nav-btn" data-sector="Semiconductor"><span class="icon">ğŸ’¾</span><span class="tab-name">Semiconductors</span></button>
      <button class="nav-btn" data-sector="Pharma"><span class="icon">ğŸ’Š</span><span class="tab-name">Pharma</span></button>
      <button class="nav-btn" data-sector="Electricity"><span class="icon">âš¡</span><span class="tab-name">Electricity</span></button>
      <button class="nav-btn" data-sector="Mining"><span class="icon">â›ï¸</span><span class="tab-name">Mining</span></button>
      <button class="nav-btn" data-sector="Automobile"><span class="icon">ğŸš—</span><span class="tab-name">Automobile</span></button>
      <button class="nav-btn" data-sector="Quantum"><span class="icon">âš›ï¸</span><span class="tab-name">Quantum</span></button>
      <button class="nav-btn" data-sector="Finance"><span class="icon">ğŸ’°</span><span class="tab-name">Finance</span></button>
      <button class="nav-btn" data-sector="Retail"><span class="icon">ğŸ›ï¸</span><span class="tab-name">Retail</span></button>
      <button class="nav-btn" data-sector="Technology"><span class="icon">ğŸ’»</span><span class="tab-name">Technology</span></button>
      <button class="add-tab-btn" id="addTabBtn">+</button>
    </div>
    <button class="scroll-arrow scroll-arrow-right" id="scrollRight">â€º</button>
  </div>

  <div class="main-content">
    <div class="sidebar">
      <div class="sidebar-box">
        <div class="sidebar-title">âš™ï¸ Analysis Parameters</div>
        
        <div class="analysis-section">
          <div class="analysis-header">
            <span class="analysis-icon">ğŸ”</span>
            <span class="analysis-label">Analysis Depth</span>
          </div>
          <select class="analysis-select" id="analysisDepth">
            <option value="basic">Basic Analysis</option>
            <option value="standard" selected>Standard Analysis</option>
            <option value="comprehensive">Comprehensive Analysis</option>
            <option value="advanced">Advanced Analysis</option>
          </select>
          
          <div class="analysis-header">
            <span class="analysis-icon">â±ï¸</span>
            <span class="analysis-label">Refresh Timer</span>
          </div>
          <select class="analysis-select" id="timerSelect">
            <option value="0">Off (Manual)</option>
            <option value="15">15 Minutes</option>
            <option value="30">30 Minutes</option>
            <option value="45">45 Minutes</option>
            <option value="60">60 Minutes</option>
          </select>
          
          <div style="position: relative; display: inline-block; width: 100%;">
            <button class="analyze-btn" id="analyzeBtn">
              <span class="icon">ğŸš€</span>
              <span>Analyze All</span>
            </button>
          </div>
          
          <div class="timer-display" id="timerDisplay">Ready</div>
          <div class="status-display" id="statusDisplay">Click analyze to start</div>
          
          <div class="timer-line-container" id="timerLineContainer">
            <div class="timer-text-small">
              <span>Auto-refresh</span>
              <span id="timerTextTime">00:00</span>
            </div>
            <div class="timer-line-track">
              <div class="timer-line-fill" id="timerLineFill"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Test Button -->
      <button class="test-btn" id="testBtn">
        <span class="icon">ğŸ§ª</span>
        <span>Calibrate</span>
      </button>
    </div>
    
    <div class="table-container">
      <!-- MyList Container Header with Edit Name and Action Buttons -->
      <div class="mylist-header" id="mylistHeader">
        <div class="mylist-title">
          <span>ğŸ”‘</span>
          <div class="mylist-name-edit">
            <span class="mylist-name-display" id="mylistNameDisplay">
              <span id="mylistNameText">My List</span>
              <div class="edit-icon-container">
                <span class="edit-icon">âœï¸</span>
              </div>
            </span>
            <input type="text" class="mylist-name-input" id="mylistNameInput" value="My List" style="display: none">
          </div>
        </div>
        <div class="mylist-actions">
          <button class="mylist-action-btn guide" id="guideBtn">
            <span class="icon">ğŸ“–</span>
            <span>Guide</span>
          </button>
          <button class="mylist-action-btn keyword" id="keywordRefBtn">
            <span class="icon">ğŸ”‘</span>
            <span>Keyword Reference</span>
          </button>
          <button class="mylist-action-btn export" id="exportBtn">
            <span class="icon">ğŸ“¤</span>
            <span>Export</span>
          </button>
          <button class="mylist-action-btn compare" id="compareBtn">
            <span class="icon">ğŸ“Š</span>
            <span>Compare</span>
          </button>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>No</th>
              <th>Companies</th>
              <th>Sector</th>
              <th><span class="emoji">ğŸ˜¢</span>Sad %</th>
              <th><span class="emoji">ğŸ˜</span>Neutral %</th>
              <th><span class="emoji">ğŸ˜Š</span>Happy %</th>
              <th><div class="rag-header"><span style="background:#e53935"></span><span style="background:#fdd835"></span><span style="background:#43a047"></span></div>RAG</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div class="add-row-btn" onclick="openModal()">
          <span style="font-size:20px">â•</span>
          <span>Add New Company</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2 id="modalTitle">âœ¨ Add Company</h2>
    <div class="form-group">
      <label>Company Name</label>
      <input type="text" id="companyName" placeholder="Enter company name...">
    </div>
    <div class="form-group">
      <label>Sector</label>
      <select id="sectorSelect">
        <option value="Semiconductor">ğŸ’¾ Semiconductor</option>
        <option value="Pharma">ğŸ’Š Pharma</option>
        <option value="Electricity">âš¡ Electricity</option>
        <option value="Mining">â›ï¸ Mining</option>
        <option value="Automobile">ğŸš— Automobile</option>
        <option value="Quantum">âš›ï¸ Quantum</option>
        <option value="Finance">ğŸ’° Finance</option>
        <option value="Retail">ğŸ›ï¸ Retail</option>
        <option value="Technology">ğŸ’» Technology</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-btn btn-save" onclick="saveCompany()">ğŸ’¾ Save</button>
    </div>
  </div>
</div>

<!-- Edit RAG Modal -->
<div class="modal-overlay" id="editRagModal" style="display: none;">
  <div class="modal edit-rag-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ¨</span> Edit RAG Status</h2>
      <button class="modal-close" onclick="closeEditRagModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Company</label>
        <input type="text" id="ragCompanyName" readonly style="background:#f5f5f5;">
      </div>
      
      <div class="form-group">
        <label>Select RAG Status</label>
        <div class="rag-edit-options">
          <div class="rag-edit-option" data-rag="red">
            <div class="rag-edit-dot red"></div>
            <span>Red</span>
          </div>
          <div class="rag-edit-option" data-rag="yellow">
            <div class="rag-edit-dot yellow"></div>
            <span>Yellow</span>
          </div>
          <div class="rag-edit-option" data-rag="green">
            <div class="rag-edit-dot green"></div>
            <span>Green</span>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label>Manual Sentiment Override (Optional)</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
          <div>
            <label style="font-size: 12px;">Sad %</label>
            <input type="number" id="manualSad" min="0" max="100" placeholder="0-100" style="text-align: center;">
          </div>
          <div>
            <label style="font-size: 12px;">Neutral %</label>
            <input type="number" id="manualNeutral" min="0" max="100" placeholder="0-100" style="text-align: center;">
          </div>
          <div>
            <label style="font-size: 12px;">Happy %</label>
            <input type="number" id="manualHappy" min="0" max="100" placeholder="0-100" style="text-align: center;">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeEditRagModal()">Cancel</button>
      <button class="modal-btn btn-save" onclick="saveRagEdit()">ğŸ’¾ Save Changes</button>
    </div>
  </div>
</div>

<!-- Add Tab Modal -->
<div class="modal-overlay" id="addTabModal" style="display: none;">
  <div class="modal add-tab-modal">
    <div class="modal-header">
      <h2><span class="icon">â•</span> Add New Tab</h2>
      <button class="modal-close" onclick="closeAddTabModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Tab Name</label>
        <input type="text" id="newTabName" placeholder="Enter tab name...">
      </div>
      
      <div class="form-group">
        <label>Tab Icon</label>
        <select id="newTabIcon" style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px;">
          <option value="ğŸ¢">ğŸ¢ Building</option>
          <option value="ğŸ­">ğŸ­ Factory</option>
          <option value="ğŸš€">ğŸš€ Rocket</option>
          <option value="ğŸ“±">ğŸ“± Mobile</option>
          <option value="ğŸ’">ğŸ’ Diamond</option>
          <option value="ğŸ”¬">ğŸ”¬ Science</option>
          <option value="ğŸŒ±">ğŸŒ± Plant</option>
          <option value="ğŸ›’">ğŸ›’ Shopping</option>
          <option value="ğŸ“ˆ">ğŸ“ˆ Chart</option>
          <option value="ğŸ¯">ğŸ¯ Target</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Background Color</label>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
          <div class="color-option" data-color="linear-gradient(135deg, #e3f2fd, #bbdefb)" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #e8f5e9, #c8e6c9)" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #fff3e0, #ffe0b2)" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #fbe9e7, #ffccbc)" style="background: linear-gradient(135deg, #fbe9e9, #ffccbc); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #f3e5f5, #e1bee7)" style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #e0f2f1, #b2dfdb)" style="background: linear-gradient(135deg, #e0f2f1, #b2dfdb); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #e8eaf6, #c5cae9)" style="background: linear-gradient(135deg, #e8eaf6, #c5cae9); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
          <div class="color-option" data-color="linear-gradient(135deg, #fff8e1, #ffecb3)" style="background: linear-gradient(135deg, #fff8e1, #ffecb3); height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;"></div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeAddTabModal()">Cancel</button>
      <button class="modal-btn btn-save" onclick="createNewTab()">â• Create Tab</button>
    </div>
  </div>
</div>

<!-- ENHANCED: Test Analysis Modal with More Accurate Details -->
<div class="modal-overlay" id="testModal" style="display: none;">
  <div class="modal test-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ§ª</span> Text Sentiment Analysis Test</h2>
      <button class="modal-close" onclick="closeTestModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="guide-section">
        <h3><span class="icon">ğŸ“„</span> Editable Test Page</h3>
        <p>Type or paste text below to analyze its sentiment using keyword-based scoring:</p>
        
        <!-- Enhanced Company Input Section -->
        <div class="test-company-input-section">
          <h4><span class="icon">ğŸ¢</span> Add Company for Analysis</h4>
          <div class="test-company-input-row">
            <input type="text" 
                   class="test-company-input" 
                   id="testCompanyName" 
                   placeholder="Enter company name (e.g., Apple)">
            
            <select id="testCompanySector" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px; background: white;">
              <option value="Technology">ğŸ’» Technology</option>
              <option value="Semiconductor">ğŸ’¾ Semiconductor</option>
              <option value="Pharma">ğŸ’Š Pharma</option>
              <option value="Electricity">âš¡ Electricity</option>
              <option value="Mining">â›ï¸ Mining</option>
              <option value="Automobile">ğŸš— Automobile</option>
              <option value="Quantum">âš›ï¸ Quantum</option>
              <option value="Finance">ğŸ’° Finance</option>
              <option value="Retail">ğŸ›ï¸ Retail</option>
            </select>
            
            <button class="add-company-test-btn" onclick="addTestCompany()">
              <span class="icon">â•</span>
              <span>Add Company</span>
            </button>
          </div>
          
          <div class="test-companies-list" id="testCompaniesList">
            <!-- Test companies will be added here -->
            <div class="empty-state" style="text-align: center; color: #999; padding: 20px;">
              No companies added yet. Add a company to test sentiment analysis.
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Test Text Content</label>
          <textarea 
            id="testTextInput" 
            placeholder="Enter or paste text here for sentiment analysis..."
            rows="8"
            style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px; font-family: inherit; resize: vertical;"
          >NVIDIA continues to demonstrate strong innovation in AI and graphics technology. The company shows robust growth with high performance across multiple sectors. However, there are some concerns about market volatility and competition in certain areas. Overall, the benefits of their technology advancements outweigh the risks.</textarea>
        </div>
        
        <div class="test-action-buttons">
          <button class="modal-btn btn-cancel" onclick="closeTestModal()">Close</button>
          <button class="modal-btn btn-save" onclick="runSentimentTest()">
            <span class="icon">ğŸ§ª</span>
            Calibrate
          </button>
        </div>

        <!-- Enhanced Test Results Section -->
        <div id="testResultsSection" style="display: none;">
          <div class="chart-container">
            <div class="chart-title">ğŸ“Š Sentiment Analysis Results</div>
            
            <!-- Overall Sentiment Summary -->
            <div class="sentiment-summary">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                  <h4 style="margin: 0; color: #1a1a2e;">Overall Analysis</h4>
                  <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    <span id="analysisDetails">Analyzed <span id="wordCount">0</span> words with <span id="keywordCount">0</span> keywords detected</span>
                  </div>
                </div>
                <div id="overallSentimentBadge" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 14px;">
                  Loading...
                </div>
              </div>
              
              <!-- Confidence Score -->
              <div style="margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                  <span style="font-size: 12px; font-weight: 600; color: #555;">Confidence Score</span>
                  <span style="font-size: 12px; font-weight: 600; color: #667eea;" id="confidenceScore">0%</span>
                </div>
                <div style="width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
                  <div id="confidenceBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 3px; transition: width 0.5s;"></div>
                </div>
              </div>
            </div>
            
            <!-- Enhanced Sentiment Charts -->
            <div class="sentiment-chart">
              <div class="chart-bar">
                <div class="chart-bar-label">
                  <span>ğŸ˜Š Positive</span>
                  <span class="chart-bar-value" id="happyScoreValue">0%</span>
                </div>
                <div class="chart-bar-track">
                  <div class="chart-bar-fill happy" id="happyBar" style="width: 0%"></div>
                </div>
                <div class="chart-bar-details">
                  <span id="positiveKeywordCount">0 keywords</span>
                </div>
              </div>
              <div class="chart-bar">
                <div class="chart-bar-label">
                  <span>ğŸ˜¢ Negative</span>
                  <span class="chart-bar-value" id="sadScoreValue">0%</span>
                </div>
                <div class="chart-bar-track">
                  <div class="chart-bar-fill sad" id="sadBar" style="width: 0%"></div>
                </div>
                <div class="chart-bar-details">
                  <span id="negativeKeywordCount">0 keywords</span>
                </div>
              </div>
              <div class="chart-bar">
                <div class="chart-bar-label">
                  <span>ğŸ˜ Neutral</span>
                  <span class="chart-bar-value" id="neutralScoreValue">0%</span>
                </div>
                <div class="chart-bar-track">
                  <div class="chart-bar-fill neutral" id="neutralBar" style="width: 0%"></div>
                </div>
                <div class="chart-bar-details">
                  <span id="neutralKeywordCount">0 keywords</span>
                </div>
              </div>
            </div>
            
            <!-- Enhanced Pie Chart -->
            <div class="pie-chart-container">
              <div class="pie-chart" id="sentimentPieChart">
                <div class="pie-chart-center" id="pieChartCenter">0%</div>
              </div>
            </div>
            <div class="pie-legend" id="sentimentLegend">
              <div class="legend-item">
                <div class="legend-color happy"></div>
                <span>Positive (<span id="legendHappy">0%</span>)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color neutral"></div>
                <span>Neutral (<span id="legendNeutral">0%</span>)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color sad"></div>
                <span>Negative (<span id="legendSad">0%</span>)</span>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Company Test Results -->
          <div id="companyTestResults" style="margin-top: 20px;">
            <!-- Test results for each company will be added here -->
          </div>
          
          <!-- Keyword Analysis Details -->
          <div class="keyword-analysis-details">
            <div class="chart-container">
              <div class="chart-title">ğŸ” Keyword Analysis Details</div>
              
              <!-- Top Keywords -->
              <div style="margin-top: 15px;">
                <h4 style="margin-bottom: 10px; font-size: 16px; color: #1a1a2e;">Top Detected Keywords</h4>
                <div id="topKeywordsContainer" style="display: flex; flex-wrap: wrap; gap: 8px;">
                  <!-- Top keywords will be dynamically added -->
                </div>
              </div>
              
              <!-- Keyword Statistics -->
              <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                  <div style="font-size: 24px; font-weight: bold; color: #43a047;" id="totalPositiveKeywords">0</div>
                  <div style="font-size: 12px; color: #666;">Positive Keywords</div>
                </div>
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                  <div style="font-size: 24px; font-weight: bold; color: #ff9800;" id="totalNeutralKeywords">0</div>
                  <div style="font-size: 12px; color: #666;">Neutral Keywords</div>
                </div>
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                  <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="totalNegativeKeywords">0</div>
                  <div style="font-size: 12px; color: #666;">Negative Keywords</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Keyword Categories with Search -->
        <div class="keyword-categories" style="margin-top: 20px;">
          <div class="keyword-search" style="margin-bottom: 15px;">
            <input type="text" id="keywordSearchTest" placeholder="Search keywords in text..." style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px;">
          </div>
          
          <div class="keyword-category">
            <h4><span class="icon">ğŸ˜Š</span> Positive Keywords</h4>
            <div class="keyword-list" id="positiveKeywordsList">
              <!-- Positive keywords will be populated dynamically -->
            </div>
          </div>
          
          <div class="keyword-category">
            <h4><span class="icon">ğŸ˜¢</span> Negative Keywords</h4>
            <div class="keyword-list" id="negativeKeywordsList">
              <!-- Negative keywords will be populated dynamically -->
            </div>
          </div>
          
          <div class="keyword-category">
            <h4><span class="icon">ğŸ˜</span> Neutral Keywords</h4>
            <div class="keyword-list" id="neutralKeywordsList">
              <!-- Neutral keywords will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="clearTestResults()">Clear Results</button>
      <button class="modal-btn btn-save" onclick="saveTestToCompany()">
        <span class="icon">ğŸ’¾</span>
        <span>Save to Main List</span>
      </button>
    </div>
  </div>
</div>

<!-- REMOVED: Edit Keyword Modal completely -->

<!-- Enhanced Keyword Reference Modal with Imported Files Display -->
<div class="modal-overlay" id="keywordModal" style="display: none;">
  <div class="modal keyword-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ”‘</span> Keyword Reference Guide</h2>
      <button class="modal-close" onclick="closeKeywordModal()">Ã—</button>
    </div>
    
    <!-- Imported Files Info -->
    <div class="imported-files-info" id="importedFilesInfo">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span class="icon">ğŸ“</span>
          <span style="font-size: 13px; font-weight: 600;">Imported Keywords:</span>
        </div>
        <div id="importedFilesList" style="display: flex; gap: 8px; font-size: 11px;">
          <!-- Imported files will be listed here -->
        </div>
      </div>
    </div>
    
    <!-- Emotion Tabs Navigation -->
    <div class="keyword-tabs-nav">
      <button class="keyword-tab-btn active" data-emotion="all" onclick="filterKeywordsByEmotion('all')">
        <span class="icon">ğŸ“Š</span>
        <span>All Keywords</span>
        <span class="keyword-count-badge" id="allKeywordCount">0</span>
      </button>
      <button class="keyword-tab-btn" data-emotion="happy" onclick="filterKeywordsByEmotion('happy')">
        <span class="icon">ğŸ˜Š</span>
        <span>Happy</span>
        <span class="keyword-count-badge" id="happyKeywordCount">0</span>
      </button>
      <button class="keyword-tab-btn" data-emotion="neutral" onclick="filterKeywordsByEmotion('neutral')">
        <span class="icon">ğŸ˜</span>
        <span>Neutral</span>
        <span class="keyword-count-badge" id="neutralKeywordCount">0</span>
      </button>
      <button class="keyword-tab-btn" data-emotion="sad" onclick="filterKeywordsByEmotion('sad')">
        <span class="icon">ğŸ˜¢</span>
        <span>Sad</span>
        <span class="keyword-count-badge" id="sadKeywordCount">0</span>
      </button>
    </div>
    
    <!-- Top Used Keywords Section -->
    <div style="margin: 15px; padding: 12px; background: linear-gradient(135deg, #fff9c4, #ffeb3b); border-radius: 10px; border-left: 4px solid #fbc02d;">
      <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 13px; color: #f57f17;"><span class="icon">â­</span> Top Used Keywords</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div style="background: white; padding: 8px; border-radius: 8px; border: 1px solid #fdd835;">
          <div style="font-size: 11px; font-weight: 600; color: #f57f17; margin-bottom: 4px;">ğŸ¥‡ Top 1</div>
          <div id="topKeyword1" style="font-size: 12px; font-weight: 600; color: #1a1a2e; word-break: break-word;">-</div>
        </div>
        <div style="background: white; padding: 8px; border-radius: 8px; border: 1px solid #fdd835;">
          <div style="font-size: 11px; font-weight: 600; color: #f57f17; margin-bottom: 4px;">ğŸ¥ˆ Top 2</div>
          <div id="topKeyword2" style="font-size: 12px; font-weight: 600; color: #1a1a2e; word-break: break-word;">-</div>
        </div>
      </div>
    </div>

    <div class="keyword-modal-body">
      <div class="keyword-search">
        <input type="text" id="keywordSearch" placeholder="Search keywords...">
        <span class="search-icon">ğŸ”</span>
      </div>
      
      <!-- Keywords Container with Individual Boxes -->
      <div class="keywords-container" id="keywordsContainer">
        <!-- Keywords will be populated by JavaScript -->
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn" onclick="openAddKeywordModal()" style="background: linear-gradient(135deg, #4caf50, #388e3c); color: white;">
        <span class="icon">â•</span>
        <span>Add Keyword</span>
      </button>
      <button class="modal-btn btn-cancel" onclick="closeKeywordModal()">Close</button>
      <button class="modal-btn btn-save" onclick="copyAllKeywords()">
        <span class="icon">ğŸ“‹</span>
        <span>Copy All Keywords</span>
      </button>
      <button class="modal-btn" onclick="exportKeywordsToCSV()" style="background: linear-gradient(135deg, #42a5f5, #1e88e5); color: white;">
        <span class="icon">ğŸ“¤</span>
        <span>Export Keywords</span>
      </button>
    </div>
  </div>
</div>

<!-- Edit Keyword Modal -->
<div class="modal-overlay" id="editKeywordModal" style="display: none;">
  <div class="modal" style="max-width: 320px; padding: 22px; background: linear-gradient(135deg, #f8f9fa, #ffffff);">
    <h2 style="margin-bottom: 16px; font-size: 18px; color: #1a1a2e;"><span class="icon">âœï¸</span> Edit Keyword</h2>
    
    <div class="form-group" style="margin-bottom: 12px;">
      <label style="font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Keyword Name</label>
      <input type="text" id="editKeywordName" readonly style="background:#f5f5f5; padding: 9px 12px; font-size: 13px; color: #1a1a2e; border: 1px solid #e0e0e0; border-radius: 8px;">
    </div>

    <div class="form-group" style="margin-bottom: 12px;">
      <label style="font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Category</label>
      <select id="editKeywordEmotion" style="width: 100%; padding: 9px 12px; font-size: 13px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">
        <option value="happy">ğŸ˜Š Happy</option>
        <option value="neutral">ğŸ˜ Neutral</option>
        <option value="sad">ğŸ˜¢ Sad</option>
      </select>
    </div>

    <div class="form-group" style="margin-bottom: 16px;">
      <label style="font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Score</label>
      <div style="display: flex; gap: 6px; align-items: center;">
        <input type="number" id="editKeywordScore" min="1" max="5" step="1" value="5" style="flex: 1; padding: 9px 12px; font-size: 13px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; font-weight: 600;">
        <div style="font-size: 11px; color: #999; padding: 0 4px; white-space: nowrap;">1 - 5</div>
      </div>
    </div>

    <div class="modal-actions" style="display: flex; gap: 8px; margin: 0;">
      <button class="modal-btn btn-cancel" onclick="closeEditKeywordModal()" style="flex: 1; padding: 9px 12px; font-size: 12px; font-weight: 600; border-radius: 8px; border: 1px solid #e0e0e0; background: white; color: #666; cursor: pointer; transition: all 0.2s;">Cancel</button>
      <button class="modal-btn btn-save" onclick="saveKeywordEdit()" style="flex: 1; padding: 9px 12px; font-size: 12px; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">Save</button>
    </div>
  </div>
</div>

<!-- Add Keyword Modal -->
<div class="modal-overlay" id="addKeywordModal" style="display: none;">
  <div class="modal" style="max-width: 240px; padding: 12px; background: linear-gradient(135deg, #f8f9fa, #ffffff);">
    <h2 style="margin-bottom: 8px; font-size: 14px; color: #1a1a2e;"><span class="icon">â•</span> Add New</h2>
    
    <div class="form-group" style="margin-bottom: 7px;">
      <label style="font-size: 9px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; display: block;">Keyword</label>
      <input type="text" id="addKeywordName" placeholder="Enter keyword..." style="background:white; padding: 5px 8px; font-size: 11px; color: #1a1a2e; border: 1px solid #e0e0e0; border-radius: 6px; width: 100%;">
    </div>

    <div class="form-group" style="margin-bottom: 7px;">
      <label style="font-size: 9px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; display: block;">Category</label>
      <select id="addKeywordEmotion" style="width: 100%; padding: 5px 8px; font-size: 11px; border: 1px solid #e0e0e0; border-radius: 6px; background: white; cursor: pointer;">
        <option value="happy">ğŸ˜Š Happy</option>
        <option value="neutral">ğŸ˜ Neutral</option>
        <option value="sad">ğŸ˜¢ Sad</option>
      </select>
    </div>

    <div class="form-group" style="margin-bottom: 9px;">
      <label style="font-size: 9px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; display: block;">Score (1-5)</label>
      <input type="number" id="addKeywordScore" min="1" max="5" step="1" value="5" style="width: 100%; padding: 5px 8px; font-size: 11px; border: 1px solid #e0e0e0; border-radius: 6px; text-align: center; font-weight: 600;">
    </div>

    <div class="modal-actions" style="display: flex; gap: 5px; margin: 0;">
      <button class="modal-btn btn-cancel" onclick="closeAddKeywordModal()" style="flex: 1; padding: 6px 8px; font-size: 10px; font-weight: 600; border-radius: 6px; border: 1px solid #e0e0e0; background: white; color: #666; cursor: pointer;">Cancel</button>
      <button class="modal-btn btn-save" onclick="saveNewKeyword()" style="flex: 1; padding: 6px 8px; font-size: 10px; font-weight: 600; border-radius: 6px; border: none; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; cursor: pointer;">Add</button>
    </div>
  </div>
</div>

<!-- Guide Modal -->
<div class="modal-overlay" id="guideModal" style="display: none;">
  <div class="modal guide-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ“–</span> User Guide</h2>
      <button class="modal-close" onclick="closeGuideModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="guide-section">
        <h3><span class="icon">ğŸ¯</span> How to Use This Tool</h3>
        <p>This Sector Sentiment Analysis tool helps you analyze company sentiment based on keywords found in news, reports, and other text sources.</p>
        
        <div class="feature-grid">
          <div class="feature-card">
            <h4>ğŸ“Š Add Companies</h4>
            <ul>
              <li>Click "Add New Company" at the bottom of the table</li>
              <li>Enter company name and select sector</li>
              <li>Companies will appear in your list</li>
            </ul>
          </div>
          
          <div class="feature-card">
            <h4>ğŸš€ Analyze Sentiment</h4>
            <ul>
              <li>Click "Analyze All" to process all companies</li>
              <li>Each analysis takes about 12 seconds</li>
              <li>Results show Sad, Neutral, and Happy percentages</li>
            </ul>
          </div>
          
          <div class="feature-card">
            <h4>ğŸ¨ RAG Status</h4>
            <ul>
              <li>Green: Positive sentiment (â‰¥70% Happy)</li>
              <li>Yellow: Mixed sentiment</li>
              <li>Red: Negative sentiment (â‰¥70% Sad)</li>
              <li>Click RAG dots to manually edit</li>
            </ul>
          </div>
          
          <div class="feature-card">
            <h4>ğŸ”§ Advanced Features</h4>
            <ul>
              <li>Create custom tabs for different sectors</li>
              <li>Test text sentiment in the Test modal</li>
              <li>Export data to CSV format</li>
              <li>Compare company performances</li>
            </ul>
          </div>
        </div>
        
        <h3><span class="icon">ğŸ“ˆ</span> Understanding the Analysis</h3>
        <p>The tool uses a keyword-based scoring system to determine sentiment. Keywords are categorized as Happy, Neutral, or Sad based on their emotional tone.</p>
        <p>RAG (Red-Amber-Green) status provides a quick visual indicator of overall sentiment. You can override the automatic RAG assessment by clicking on the RAG dot and manually setting the status.</p>
        
        <h3><span class="icon">ğŸ“¥</span> Importing Keywords</h3>
        <p>You can import custom keywords with scores using CSV files. The format should be:</p>
        <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace;">
keyword_name,keyword_score
innovation,8
growth,7
decline,9
        </pre>
        <p>Imported keywords will be displayed in the Keyword Reference with their scores and source files.</p>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeGuideModal()">Close</button>
      <button class="modal-btn btn-save" onclick="showQuickStart()">
        <span class="icon">ğŸš€</span>
        <span>Quick Start Demo</span>
      </button>
    </div>
  </div>
</div>


<!-- ENHANCED: Export Modal with Import and Update Options -->
<div class="modal-overlay" id="exportModal" style="display: none;">
  <div class="modal export-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ“¤</span> Export & Import Data</h2>
      <button class="modal-close" onclick="closeExportModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="guide-section">
        <!-- Import Section -->
        <div style="margin-bottom: 30px;">
          <h3><span class="icon">ğŸ“¥</span> Import Data</h3>
          <p>Import company data or keywords from CSV files only:</p>
          
          <div class="import-section">
            <div class="import-options">
              <div class="import-option" data-format="csv" onclick="selectImportOption('csv')">
                <div class="icon">ğŸ“„</div>
                <h4>CSV File</h4>
                <p>Import data from CSV format only</p>
              </div>
            </div>
            
            <div style="margin-top: 20px;">
              <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="handleFileImport()">
              <button class="modal-btn" onclick="document.getElementById('importFile').click()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #42a5f5, #1e88e5); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                <span class="icon">ğŸ“</span>
                <span>Choose CSV File to Import</span>
              </button>
              <div id="selectedFileName" style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;"></div>
            </div>
            
            <!-- Import Options -->
            <div style="margin-top: 20px;">
              <h4 style="font-size: 14px; margin-bottom: 10px;">Import Options</h4>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                  <input type="radio" name="importMode" value="add" checked> Add New Only
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                  <input type="radio" name="importMode" value="update"> Update Existing
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                  <input type="radio" name="importMode" value="replace"> Replace All
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                  <input type="checkbox" id="importWithScores" checked> Keep Sentiment Scores
                </label>
              </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
              <button class="modal-btn btn-cancel" onclick="clearImport()" style="flex: 1;">
                Clear
              </button>
              <button class="modal-btn btn-save" onclick="performImport()" style="flex: 1;">
                <span class="icon">ğŸ“¥</span>
                Import Data
              </button>
            </div>
          </div>
          
          <!-- Import Log Section -->
          <div style="margin-top: 20px; border-top: 1px solid #e9ecef; padding-top: 20px;">
            <h4><span class="icon">ğŸ“Š</span> Import Log</h4>
            <div id="importLog" style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px; font-size: 12px; max-height: 100px; overflow-y: auto;">
              No imports yet.
            </div>
            <button onclick="clearImportLog()" style="margin-top: 10px; padding: 6px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; font-size: 11px; cursor: pointer;">
              Clear Log
            </button>
          </div>
        </div>
        
        <!-- Export Section -->
        <div style="border-top: 1px solid #e9ecef; padding-top: 20px;">
          <h3><span class="icon">ğŸ“¤</span> Export Data</h3>
          <p>Choose how you want to export your sentiment analysis data:</p>
          
          <div class="export-options">
            <div class="export-option" data-format="csv" onclick="selectExportOption('csv')">
              <div class="icon">ğŸ“„</div>
              <h4>CSV File</h4>
              <p>Comma-separated values, compatible with Excel and data analysis tools</p>
            </div>
            
            <div class="export-option" data-format="json" onclick="selectExportOption('json')">
              <div class="icon">ğŸ”§</div>
              <h4>JSON Format</h4>
              <p>Structured data format for developers and API integration</p>
            </div>
            
            <div class="export-option" data-format="pdf" onclick="selectExportOption('pdf')">
              <div class="icon">ğŸ“Š</div>
              <h4>PDF Report</h4>
              <p>Formatted report with charts and analysis summary</p>
            </div>
            
            <div class="export-option" data-format="excel" onclick="selectExportOption('excel')">
              <div class="icon">ğŸ“ˆ</div>
              <h4>Excel File</h4>
              <p>Formatted Excel spreadsheet with styling and charts</p>
            </div>
          </div>
          
          <div class="form-group" style="margin-top: 20px;">
            <label>Export Scope</label>
            <select id="exportScope" style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px;">
              <option value="current">Current Tab Only</option>
              <option value="all">All Companies</option>
              <option value="analyzed">Only Analyzed Companies</option>
              <option value="custom">Custom Selection</option>
            </select>
          </div>
          
          <!-- Export Options -->
          <div style="margin-top: 20px;">
            <h4 style="font-size: 14px; margin-bottom: 10px;">Export Options</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <input type="checkbox" id="includeRAG" checked> Include RAG Status
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <input type="checkbox" id="includeTimestamps" checked> Include Timestamps
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <input type="checkbox" id="includeMetadata" checked> Include Metadata
              </label>
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <input type="checkbox" id="formatNumbers"> Format Numbers
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeExportModal()">Cancel</button>
      <button class="modal-btn btn-save" onclick="performExport()">
        <span class="icon">ğŸ“¥</span>
        <span>Export Now</span>
      </button>
    </div>
  </div>
</div>

<!-- Compare Modal -->
<div class="modal-overlay" id="compareModal" style="display: none;">
  <div class="modal compare-modal">
    <div class="modal-header">
      <h2><span class="icon">ğŸ“Š</span> Compare Companies</h2>
      <button class="modal-close" onclick="closeCompareModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="guide-section">
        <h3><span class="icon">âš–ï¸</span> Performance Comparison</h3>
        <p>Analysis of your company list based on sentiment scores:</p>
        
        <div class="comparison-results">
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">ğŸ“Š</span>
              <span>Total Companies</span>
            </div>
            <div class="comparison-value" id="totalCompanies">0</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">âœ…</span>
              <span>Analyzed Companies</span>
            </div>
            <div class="comparison-value" id="analyzedCompanies">0</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">ğŸ˜Š</span>
              <span>Average Happy Score</span>
            </div>
            <div class="comparison-value" id="avgSentiment">0%</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">ğŸ†</span>
              <span>Most Positive Company</span>
            </div>
            <div class="comparison-value" id="happiestCompany">None</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">âš ï¸</span>
              <span>Most Negative Company</span>
            </div>
            <div class="comparison-value" id="saddestCompany">None</div>
          </div>
          
          <div class="comparison-item">
            <div class="comparison-label">
              <span class="icon">âš–ï¸</span>
              <span>Most Balanced Company</span>
            </div>
            <div class="comparison-value" id="mostBalancedCompany">None</div>
          </div>
        </div>
        
        <div style="margin-top: 30px;">
          <h4><span class="icon">ğŸ“ˆ</span> Sector Distribution</h4>
          <div id="sectorDistribution" style="background: #f8f9fa; border-radius: 12px; padding: 15px; margin-top: 10px;">
            <!-- Sector distribution will be populated dynamically -->
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions-sticky">
      <button class="modal-btn btn-cancel" onclick="closeCompareModal()">Close</button>
      <button class="modal-btn btn-save" onclick="exportComparison()">
        <span class="icon">ğŸ“¤</span>
        <span>Export Comparison</span>
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast">âœ… Action completed successfully!</div>
<script>
const API_URL = window.location.origin;
let currentEditKeyword = null;
let currentEditEmotion = null;
let selectedEditEmotion = null;
let currentKeywordFilter = 'all';

// Emotions data - with weight scores
const emotions = {
    'happy': {
        'keywords': [
            { keyword: 'ability to attract', weight: 5 },
            { keyword: 'abundant', weight: 5 },
            { keyword: 'absolutely', weight: 5 },
            { keyword: 'accessible', weight: 5 },
            { keyword: 'acclaimed', weight: 5 },
            { keyword: 'accommodative', weight: 5 },
            { keyword: 'achievement', weight: 5 },
            { keyword: 'admire', weight: 5 },
            { keyword: 'adore', weight: 5 },
            { keyword: 'adulation', weight: 5 },
            { keyword: 'advance', weight: 5 },
            { keyword: 'advanced', weight: 5 },
            { keyword: 'advancing', weight: 5 },
            { keyword: 'amazing', weight: 5 },
            { keyword: 'approve', weight: 5 },
            { keyword: 'arousing', weight: 5 },
            { keyword: 'assure', weight: 5 },
            { keyword: 'attentive', weight: 5 },
            { keyword: 'attractive', weight: 5 },
            { keyword: 'awe-inspiring', weight: 5 },
            { keyword: 'awesome', weight: 5 },
            { keyword: 'beaming', weight: 5 },
            { keyword: 'beloved', weight: 5 },
            { keyword: 'beneficial', weight: 5 },
            { keyword: 'best', weight: 5 },
            { keyword: 'bold', weight: 5 },
            { keyword: 'booming', weight: 5 },
            { keyword: 'brainy', weight: 5 },
            { keyword: 'breakthrough', weight: 5 },
            { keyword: 'breath-taking', weight: 5 },
            { keyword: 'bright', weight: 5 },
            { keyword: 'bright future', weight: 5 },
            { keyword: 'brilliant', weight: 5 },
            { keyword: 'buoyant', weight: 5 },
            { keyword: 'celebration', weight: 5 },
            { keyword: 'centered', weight: 5 },
            { keyword: 'champion', weight: 5 },
            { keyword: 'charming', weight: 5 },
            { keyword: 'cheerful', weight: 5 },
            { keyword: 'clever', weight: 5 },
            { keyword: 'confidence', weight: 5 },
            { keyword: 'confident', weight: 5 },
            { keyword: 'constant', weight: 5 },
            { keyword: 'courage', weight: 5 },
            { keyword: 'courageous', weight: 5 },
            { keyword: 'delectable', weight: 5 },
            { keyword: 'definite', weight: 5 },
            { keyword: 'delightful', weight: 5 },
            { keyword: 'dependable', weight: 5 },
            { keyword: 'developing', weight: 5 },
            { keyword: 'dignified', weight: 5 },
            { keyword: 'divine', weight: 5 },
            { keyword: 'doing well', weight: 5 },
            { keyword: 'dynamite', weight: 5 },
            { keyword: 'eager', weight: 5 },
            { keyword: 'earnings growth', weight: 5 },
            { keyword: 'ecstatic', weight: 5 },
            { keyword: 'efficient', weight: 5 },
            { keyword: 'efficient use of assets', weight: 5 },
            { keyword: 'electrifying', weight: 5 },
            { keyword: 'employable', weight: 5 },
            { keyword: 'empowered', weight: 5 },
            { keyword: 'endearing', weight: 5 },
            { keyword: 'enjoyable', weight: 5 },
            { keyword: 'enriching', weight: 5 },
            { keyword: 'enthusiastic', weight: 5 },
            { keyword: 'enticing', weight: 5 },
            { keyword: 'especial', weight: 5 },
            { keyword: 'exceptional', weight: 5 },
            { keyword: 'exciting', weight: 5 },
            { keyword: 'exhilarating', weight: 5 },
            { keyword: 'exponential', weight: 5 },
            { keyword: 'exquisite', weight: 5 },
            { keyword: 'extraordinary', weight: 5 },
            { keyword: 'extraordinary good', weight: 5 },
            { keyword: 'exultant', weight: 5 },
            { keyword: 'fabulous', weight: 5 },
            { keyword: 'fascinating', weight: 5 },
            { keyword: 'favorite', weight: 5 },
            { keyword: 'fearless', weight: 5 },
            { keyword: 'fetching', weight: 5 },
            { keyword: 'financial stability', weight: 5 },
            { keyword: 'finest', weight: 5 },
            { keyword: 'flourishing', weight: 5 },
            { keyword: 'gallant', weight: 5 },
            { keyword: 'generous', weight: 5 },
            { keyword: 'generously', weight: 5 },
            { keyword: 'genuine', weight: 5 },
            { keyword: 'gleaming', weight: 5 },
            { keyword: 'goal-oriented', weight: 5 },
            { keyword: 'godawful', weight: 5 },
            { keyword: 'good future', weight: 5 },
            { keyword: 'good judgment', weight: 5 },
            { keyword: 'good perception', weight: 5 },
            { keyword: 'good quarter', weight: 5 },
            { keyword: 'good report', weight: 5 },
            { keyword: 'great', weight: 5 },
            { keyword: 'greatest', weight: 5 },
            { keyword: 'growing', weight: 5 },
            { keyword: 'growing revenue', weight: 5 },
            { keyword: 'growth', weight: 5 },
            { keyword: 'growth potential', weight: 5 },
            { keyword: 'gumptious', weight: 5 },
            { keyword: 'happiness', weight: 5 },
            { keyword: 'happy', weight: 5 },
            { keyword: 'healthy cash balance', weight: 5 },
            { keyword: 'high achievement', weight: 5 },
            { keyword: 'high investment motivation', weight: 5 },
            { keyword: 'high market share', weight: 5 },
            { keyword: 'high outcomes', weight: 5 },
            { keyword: 'high potential', weight: 5 },
            { keyword: 'high profit margin', weight: 5 },
            { keyword: 'high reward', weight: 5 },
            { keyword: 'highest', weight: 5 },
            { keyword: 'highest quality', weight: 5 },
            { keyword: 'highly recommend', weight: 5 },
            { keyword: 'highly recommended', weight: 5 },
            { keyword: 'ideal', weight: 5 },
            { keyword: 'imaginative', weight: 5 },
            { keyword: 'impressively', weight: 5 },
            { keyword: 'impressive', weight: 5 },
            { keyword: 'increased', weight: 5 },
            { keyword: 'increased net income', weight: 5 },
            { keyword: 'increase in value', weight: 5 },
            { keyword: 'increase share value', weight: 5 },
            { keyword: 'increase stock value', weight: 5 },
            { keyword: 'increasing', weight: 5 },
            { keyword: 'incredible', weight: 5 },
            { keyword: 'innovative', weight: 5 },
            { keyword: 'insightful', weight: 5 },
            { keyword: 'inspiring', weight: 5 },
            { keyword: 'instinctive', weight: 5 },
            { keyword: 'intellectual', weight: 5 },
            { keyword: 'irreplaceable', weight: 5 },
            { keyword: 'irresistible', weight: 5 },
            { keyword: 'jolly', weight: 5 },
            { keyword: 'jovial', weight: 5 },
            { keyword: 'joyful', weight: 5 },
            { keyword: 'joysome', weight: 5 },
            { keyword: 'judicious', weight: 5 },
            { keyword: 'just', weight: 5 },
            { keyword: 'keen', weight: 5 },
            { keyword: 'knowledgeable', weight: 5 },
            { keyword: 'lambent', weight: 5 },
            { keyword: 'laudable', weight: 5 },
            { keyword: 'leading', weight: 5 },
            { keyword: 'leading ahead', weight: 5 },
            { keyword: 'legendary', weight: 5 },
            { keyword: 'likable', weight: 5 },
            { keyword: 'lively', weight: 5 },
            { keyword: 'low debt-to-equity', weight: 5 },
            { keyword: 'luminous', weight: 5 },
            { keyword: 'magical', weight: 5 },
            { keyword: 'magnetic', weight: 5 },
            { keyword: 'magnificent', weight: 5 },
            { keyword: 'majestic', weight: 5 },
            { keyword: 'making headway', weight: 5 },
            { keyword: 'making progress', weight: 5 },
            { keyword: 'marvelous', weight: 5 },
            { keyword: 'masterful', weight: 5 },
            { keyword: 'meagre', weight: 5 },
            { keyword: 'miraculous', weight: 5 },
            { keyword: 'mindful', weight: 5 },
            { keyword: 'motivated', weight: 5 },
            { keyword: 'moving up', weight: 5 },
            { keyword: 'new products', weight: 5 },
            { keyword: 'numinous', weight: 5 },
            { keyword: 'on the increase', weight: 5 },
            { keyword: 'on the rise', weight: 5 },
            { keyword: 'on-target', weight: 5 },
            { keyword: 'optimistic', weight: 5 },
            { keyword: 'orderly', weight: 5 },
            { keyword: 'organized', weight: 5 },
            { keyword: 'out-of-this-world', weight: 5 },
            { keyword: 'outstanding', weight: 5 },
            { keyword: 'overjoyed', weight: 5 },
            { keyword: 'paramount', weight: 5 },
            { keyword: 'perceptive', weight: 5 },
            { keyword: 'persistent', weight: 5 },
            { keyword: 'persuasive', weight: 5 },
            { keyword: 'phenomenal', weight: 5 },
            { keyword: 'piquant', weight: 5 },
            { keyword: 'pleasurable', weight: 5 },
            { keyword: 'poise', weight: 5 },
            { keyword: 'polished', weight: 5 },
            { keyword: 'positive', weight: 5 },
            { keyword: 'positive achievement', weight: 5 },
            { keyword: 'positive future', weight: 5 },
            { keyword: 'positive outcomes', weight: 5 },
            { keyword: 'positive quarter', weight: 5 },
            { keyword: 'positive return', weight: 5 },
            { keyword: 'powerful', weight: 5 },
            { keyword: 'praiseworthy', weight: 5 },
            { keyword: 'praise', weight: 5 },
            { keyword: 'proactive', weight: 5 },
            { keyword: 'productive', weight: 5 },
            { keyword: 'profit', weight: 5 },
            { keyword: 'profitable', weight: 5 },
            { keyword: 'projected price increase', weight: 5 },
            { keyword: 'prominent', weight: 5 },
            { keyword: 'promising', weight: 5 },
            { keyword: 'prompt', weight: 5 },
            { keyword: 'prospering', weight: 5 },
            { keyword: 'proud', weight: 5 },
            { keyword: 'punctual', weight: 5 },
            { keyword: 'quick-witted', weight: 5 },
            { keyword: 'radiant', weight: 5 },
            { keyword: 'rallying', weight: 5 },
            { keyword: 'rapturous', weight: 5 },
            { keyword: 'rational', weight: 5 },
            { keyword: 'razor-sharp', weight: 5 },
            { keyword: 'reassuring', weight: 5 },
            { keyword: 'recherche', weight: 5 },
            { keyword: 'record high', weight: 5 },
            { keyword: 'refulgent', weight: 5 },
            { keyword: 'rejoicing', weight: 5 },
            { keyword: 'reliable', weight: 5 },
            { keyword: 'remarkable', weight: 5 },
            { keyword: 'remarkably', weight: 5 },
            { keyword: 'resilient', weight: 5 },
            { keyword: 'resourceful', weight: 5 },
            { keyword: 'respectable', weight: 5 },
            { keyword: 'return on assets', weight: 5 },
            { keyword: 'revolutionary', weight: 5 },
            { keyword: 'rewarding', weight: 5 },
            { keyword: 'righteous', weight: 5 },
            { keyword: 'rising', weight: 5 },
            { keyword: 'rising return on equity', weight: 5 },
            { keyword: 'sagacious', weight: 5 },
            { keyword: 'savvy', weight: 5 },
            { keyword: 'sensational', weight: 5 },
            { keyword: 'sensationally', weight: 5 },
            { keyword: 'shrewd', weight: 5 },
            { keyword: 'sincere', weight: 5 },
            { keyword: 'skilled', weight: 5 },
            { keyword: 'smart', weight: 5 },
            { keyword: 'sound judgment', weight: 5 },
            { keyword: 'spellbinding', weight: 5 },
            { keyword: 'spirited', weight: 5 },
            { keyword: 'spunky', weight: 5 },
            { keyword: 'steadfast', weight: 5 },
            { keyword: 'stellar', weight: 5 },
            { keyword: 'stimulating', weight: 5 },
            { keyword: 'strong bottom-line', weight: 5 },
            { keyword: 'strong growth', weight: 5 },
            { keyword: 'strong profitability', weight: 5 },
            { keyword: 'struggling', weight: 5 },
            { keyword: 'struggles', weight: 5 },
            { keyword: 'succeeding', weight: 5 },
            { keyword: 'success', weight: 5 },
            { keyword: 'successful', weight: 5 },
            { keyword: 'supreme', weight: 5 },
            { keyword: 'surge', weight: 5 },
            { keyword: 'surprising', weight: 5 },
            { keyword: 'surprisingly', weight: 5 },
            { keyword: 'systematic', weight: 5 },
            { keyword: 'teeming', weight: 5 },
            { keyword: 'tenacious', weight: 5 },
            { keyword: 'thriving', weight: 5 },
            { keyword: 'trailblazing', weight: 5 },
            { keyword: 'transcendental', weight: 5 },
            { keyword: 'triumph', weight: 5 },
            { keyword: 'tubular', weight: 5 },
            { keyword: 'upbeat', weight: 5 },
            { keyword: 'uplifting', weight: 5 },
            { keyword: 'upstanding', weight: 5 },
            { keyword: 'valiant', weight: 5 },
            { keyword: 'very clever', weight: 5 },
            { keyword: 'very profitable', weight: 5 },
            { keyword: 'very successful', weight: 5 },
            { keyword: 'vibrant', weight: 5 },
            { keyword: 'victorious', weight: 5 },
            { keyword: 'victory', weight: 5 },
            { keyword: 'vigor', weight: 5 },
            { keyword: 'vigorous', weight: 5 },
            { keyword: 'visionary', weight: 5 },
            { keyword: 'vivacious', weight: 5 },
            { keyword: 'well-informed', weight: 5 },
            { keyword: 'win', weight: 5 },
            { keyword: 'winner', weight: 5 },
            { keyword: 'winners', weight: 5 },
            { keyword: 'wins', weight: 5 },
            { keyword: 'wise', weight: 5 },
            { keyword: 'worthy', weight: 5 },
            { keyword: 'worthy of praise', weight: 5 }
        ],
        'emoji': 'ğŸ˜Š'
    },
    'neutral': {
        'keywords': [
            { keyword: 'according', weight: 3 },
            { keyword: 'analyst call', weight: 3 },
            { keyword: 'annual general meeting', weight: 3 },
            { keyword: 'annual report', weight: 3 },
            { keyword: 'announced', weight: 3 },
            { keyword: 'announcement', weight: 3 },
            { keyword: 'anticipated data', weight: 3 },
            { keyword: 'audit report', weight: 3 },
            { keyword: 'balance sheet', weight: 3 },
            { keyword: 'board meeting', weight: 3 },
            { keyword: 'business', weight: 3 },
            { keyword: 'business update', weight: 3 },
            { keyword: 'cautionary statement', weight: 3 },
            { keyword: 'company update', weight: 3 },
            { keyword: 'compliance report', weight: 3 },
            { keyword: 'conference', weight: 3 },
            { keyword: 'conference call', weight: 3 },
            { keyword: 'cookie policy', weight: 3 },
            { keyword: 'corporate announcement', weight: 3 },
            { keyword: 'data', weight: 3 },
            { keyword: 'disclaimer', weight: 3 },
            { keyword: 'downtime notification', weight: 3 },
            { keyword: 'earnings', weight: 3 },
            { keyword: 'earnings call', weight: 3 },
            { keyword: 'economic data', weight: 3 },
            { keyword: 'emergency maintenance', weight: 3 },
            { keyword: 'estimated figures', weight: 3 },
            { keyword: 'expected report', weight: 3 },
            { keyword: 'extraordinary meeting', weight: 3 },
            { keyword: 'final results', weight: 3 },
            { keyword: 'financial', weight: 3 },
            { keyword: 'financial results', weight: 3 },
            { keyword: 'financial statement', weight: 3 },
            { keyword: 'financial update', weight: 3 },
            { keyword: 'formal announcement', weight: 3 },
            { keyword: 'forward looking statement', weight: 3 },
            { keyword: 'government data', weight: 3 },
            { keyword: 'industry news', weight: 3 },
            { keyword: 'industry report', weight: 3 },
            { keyword: 'information', weight: 3 },
            { keyword: 'interim report', weight: 3 },
            { keyword: 'investor presentation', weight: 3 },
            { keyword: 'launch', weight: 3 },
            { keyword: 'legal notice', weight: 3 },
            { keyword: 'management discussion', weight: 3 },
            { keyword: 'market analysis', weight: 3 },
            { keyword: 'market announcement', weight: 3 },
            { keyword: 'market update', weight: 3 },
            { keyword: 'material information', weight: 3 },
            { keyword: 'media release', weight: 3 },
            { keyword: 'meeting', weight: 3 },
            { keyword: 'meeting minutes', weight: 3 },
            { keyword: 'non-material information', weight: 3 },
            { keyword: 'official communication', weight: 3 },
            { keyword: 'official statement', weight: 3 },
            { keyword: 'operational update', weight: 3 },
            { keyword: 'outlook statement', weight: 3 },
            { keyword: 'performance review', weight: 3 },
            { keyword: 'planned outage', weight: 3 },
            { keyword: 'planned release', weight: 3 },
            { keyword: 'preliminary results', weight: 3 },
            { keyword: 'press conference', weight: 3 },
            { keyword: 'press release', weight: 3 },
            { keyword: 'price sensitive information', weight: 3 },
            { keyword: 'privacy policy', weight: 3 },
            { keyword: 'product update', weight: 3 },
            { keyword: 'projected results', weight: 3 },
            { keyword: 'proxy statement', weight: 3 },
            { keyword: 'public statement', weight: 3 },
            { keyword: 'quarterly', weight: 3 },
            { keyword: 'quarterly report', weight: 3 },
            { keyword: 'regulatory filing', weight: 3 },
            { keyword: 'regulatory news', weight: 3 },
            { keyword: 'regulatory update', weight: 3 },
            { keyword: 'release', weight: 3 },
            { keyword: 'reported', weight: 3 },
            { keyword: 'reports', weight: 3 },
            { keyword: 'revised figures', weight: 3 },
            { keyword: 'risk factors', weight: 3 },
            { keyword: 'routine maintenance', weight: 3 },
            { keyword: 'routine update', weight: 3 },
            { keyword: 'scheduled announcement', weight: 3 },
            { keyword: 'scheduled downtime', weight: 3 },
            { keyword: 'sector update', weight: 3 },
            { keyword: 'service announcement', weight: 3 },
            { keyword: 'service interruption', weight: 3 },
            { keyword: 'shareholder meeting', weight: 3 },
            { keyword: 'shareholder vote', weight: 3 },
            { keyword: 'special meeting', weight: 3 },
            { keyword: 'statement', weight: 3 },
            { keyword: 'statistical release', weight: 3 },
            { keyword: 'strategic update', weight: 3 },
            { keyword: 'system maintenance', weight: 3 },
            { keyword: 'technical update', weight: 3 },
            { keyword: 'terms and conditions', weight: 3 },
            { keyword: 'trading update', weight: 3 },
            { keyword: 'unplanned outage', weight: 3 },
            { keyword: 'unscheduled downtime', weight: 3 },
            { keyword: 'update', weight: 3 },
            { keyword: 'updated guidance', weight: 3 },
            { keyword: 'updates', weight: 3 },
            { keyword: 'website update', weight: 3 }
        ],
        'emoji': 'ğŸ˜'
    },
    'sad': {
        'keywords': [
            { keyword: 'abate', weight: 5 },
            { keyword: 'abysmal', weight: 5 },
            { keyword: 'accounting discrepancies', weight: 5 },
            { keyword: 'administration', weight: 5 },
            { keyword: 'adverse', weight: 5 },
            { keyword: 'alarming', weight: 5 },
            { keyword: 'annoy', weight: 5 },
            { keyword: 'anxious', weight: 5 },
            { keyword: 'apathy', weight: 5 },
            { keyword: 'appalling', weight: 5 },
            { keyword: 'atrocious', weight: 5 },
            { keyword: 'awful', weight: 5 },
            { keyword: 'bad', weight: 5 },
            { keyword: 'bad assets', weight: 5 },
            { keyword: 'bankrupt', weight: 5 },
            { keyword: 'battle', weight: 5 },
            { keyword: 'belligerent', weight: 5 },
            { keyword: 'below', weight: 5 },
            { keyword: 'below expectation', weight: 5 },
            { keyword: 'bemoan', weight: 5 },
            { keyword: 'beneath', weight: 5 },
            { keyword: 'blame', weight: 5 },
            { keyword: 'boring', weight: 5 },
            { keyword: 'broken', weight: 5 },
            { keyword: 'cash-strapped', weight: 5 },
            { keyword: 'cheap', weight: 5 },
            { keyword: 'chronic', weight: 5 },
            { keyword: 'closed', weight: 5 },
            { keyword: 'collapse', weight: 5 },
            { keyword: 'conflict', weight: 5 },
            { keyword: 'confront', weight: 5 },
            { keyword: 'contrary', weight: 5 },
            { keyword: 'contradictory', weight: 5 },
            { keyword: 'corrosive', weight: 5 },
            { keyword: 'corrupt', weight: 5 },
            { keyword: 'criminal', weight: 5 },
            { keyword: 'crummy', weight: 5 },
            { keyword: 'curtail', weight: 5 },
            { keyword: 'curtailment', weight: 5 },
            { keyword: 'cut', weight: 5 },
            { keyword: 'cutback', weight: 5 },
            { keyword: 'cutting', weight: 5 },
            { keyword: 'damage', weight: 5 },
            { keyword: 'damaging', weight: 5 },
            { keyword: 'dangerous', weight: 5 },
            { keyword: 'dead', weight: 5 },
            { keyword: 'death', weight: 5 },
            { keyword: 'deaths', weight: 5 },
            { keyword: 'debts', weight: 5 },
            { keyword: 'decaying', weight: 5 },
            { keyword: 'decrease', weight: 5 },
            { keyword: 'decreased', weight: 5 },
            { keyword: 'decreasing', weight: 5 },
            { keyword: 'defective', weight: 5 },
            { keyword: 'deficient', weight: 5 },
            { keyword: 'deficiency', weight: 5 },
            { keyword: 'deformed', weight: 5 },
            { keyword: 'dejected', weight: 5 },
            { keyword: 'deleterious', weight: 5 },
            { keyword: 'deny', weight: 5 },
            { keyword: 'depressed', weight: 5 },
            { keyword: 'deprived', weight: 5 },
            { keyword: 'destroy', weight: 5 },
            { keyword: 'destructive', weight: 5 },
            { keyword: 'detrimental', weight: 5 },
            { keyword: 'diabolical', weight: 5 },
            { keyword: 'difficult', weight: 5 },
            { keyword: 'diminish', weight: 5 },
            { keyword: 'diminished', weight: 5 },
            { keyword: 'dirty', weight: 5 },
            { keyword: 'disadvantageous', weight: 5 },
            { keyword: 'disagreeable', weight: 5 },
            { keyword: 'disappointed', weight: 5 },
            { keyword: 'disastrous', weight: 5 },
            { keyword: 'disgusting', weight: 5 },
            { keyword: 'disheveled', weight: 5 },
            { keyword: 'dishonest', weight: 5 },
            { keyword: 'dishonorable', weight: 5 },
            { keyword: 'dismal', weight: 5 },
            { keyword: 'disobedient', weight: 5 },
            { keyword: "don't", weight: 5 },
            { keyword: 'downside', weight: 5 },
            { keyword: 'dreary', weight: 5 },
            { keyword: 'dreadful', weight: 5 },
            { keyword: 'drop', weight: 5 },
            { keyword: 'dwindle', weight: 5 },
            { keyword: 'dwindling', weight: 5 },
            { keyword: 'ebb', weight: 5 },
            { keyword: 'egregious', weight: 5 },
            { keyword: 'enraged', weight: 5 },
            { keyword: 'eroding', weight: 5 },
            { keyword: 'evil', weight: 5 },
            { keyword: 'execrable', weight: 5 },
            { keyword: 'fail', weight: 5 },
            { keyword: 'failing', weight: 5 },
            { keyword: 'fall', weight: 5 },
            { keyword: 'falling', weight: 5 },
            { keyword: 'falling market share', weight: 5 },
            { keyword: 'falling off', weight: 5 },
            { keyword: 'faulty', weight: 5 },
            { keyword: 'fear', weight: 5 },
            { keyword: 'feeble', weight: 5 },
            { keyword: 'fight', weight: 5 },
            { keyword: 'filthy', weight: 5 },
            { keyword: 'financial distress', weight: 5 },
            { keyword: 'financial trouble', weight: 5 },
            { keyword: 'fired', weight: 5 },
            { keyword: 'flop', weight: 5 },
            { keyword: 'foul', weight: 5 },
            { keyword: 'frighten', weight: 5 },
            { keyword: 'frightful', weight: 5 },
            { keyword: 'gawky', weight: 5 },
            { keyword: 'ghastly', weight: 5 },
            { keyword: 'going concern warning', weight: 5 },
            { keyword: 'grave', weight: 5 },
            { keyword: 'greed', weight: 5 },
            { keyword: 'grim', weight: 5 },
            { keyword: 'grimace', weight: 5 },
            { keyword: 'gross', weight: 5 },
            { keyword: 'grotesque', weight: 5 },
            { keyword: 'gruesome', weight: 5 },
            { keyword: 'guilty', weight: 5 },
            { keyword: 'haggard', weight: 5 },
            { keyword: 'harmful', weight: 5 },
            { keyword: 'hate', weight: 5 },
            { keyword: 'headwinds', weight: 5 },
            { keyword: 'hideous', weight: 5 },
            { keyword: 'high debt', weight: 5 },
            { keyword: 'high debt levels', weight: 5 },
            { keyword: 'high overheads', weight: 5 },
            { keyword: 'hopeless', weight: 5 },
            { keyword: 'horrendous', weight: 5 },
            { keyword: 'horrible', weight: 5 },
            { keyword: 'hostile', weight: 5 },
            { keyword: 'hurt', weight: 5 },
            { keyword: 'hurtful', weight: 5 },
            { keyword: 'ignorant', weight: 5 },
            { keyword: 'ignore', weight: 5 },
            { keyword: 'ill', weight: 5 },
            { keyword: 'immature', weight: 5 },
            { keyword: 'imminent failure', weight: 5 },
            { keyword: 'immoral', weight: 5 },
            { keyword: 'imperfect', weight: 5 },
            { keyword: 'impossible', weight: 5 },
            { keyword: 'inability', weight: 5 },
            { keyword: 'inadequate', weight: 5 },
            { keyword: 'inane', weight: 5 },
            { keyword: 'inappropriate', weight: 5 },
            { keyword: 'inauspicious', weight: 5 },
            { keyword: 'incompetent', weight: 5 },
            { keyword: 'ineffectual', weight: 5 },
            { keyword: 'inefficient', weight: 5 },
            { keyword: 'inelegant', weight: 5 },
            { keyword: 'inept', weight: 5 },
            { keyword: 'inexpert', weight: 5 },
            { keyword: 'inferior', weight: 5 },
            { keyword: 'infernal', weight: 5 },
            { keyword: 'injure', weight: 5 },
            { keyword: 'injurious', weight: 5 },
            { keyword: 'inimical', weight: 5 },
            { keyword: 'insane', weight: 5 },
            { keyword: 'insipid', weight: 5 },
            { keyword: 'insidious', weight: 5 },
            { keyword: 'insolvency', weight: 5 },
            { keyword: 'insolvent', weight: 5 },
            { keyword: 'interest payments', weight: 5 },
            { keyword: 'jealous', weight: 5 },
            { keyword: 'junk', weight: 5 },
            { keyword: 'junky', weight: 5 },
            { keyword: 'lack of innovation', weight: 5 },
            { keyword: 'lamentable', weight: 5 },
            { keyword: 'laughable', weight: 5 },
            { keyword: 'layoffs', weight: 5 },
            { keyword: 'legal dispute', weight: 5 },
            { keyword: 'legal disputes', weight: 5 },
            { keyword: 'legal issues', weight: 5 },
            { keyword: 'legal issues', weight: 5 },
            { keyword: 'lessen', weight: 5 },
            { keyword: 'lessening', weight: 5 },
            { keyword: 'liabilities', weight: 5 },
            { keyword: 'life-threatening', weight: 5 },
            { keyword: 'lose', weight: 5 },
            { keyword: 'losing', weight: 5 },
            { keyword: 'losing money', weight: 5 },
            { keyword: 'loss', weight: 5 },
            { keyword: 'lousy', weight: 5 },
            { keyword: 'low', weight: 5 },
            { keyword: 'low growth', weight: 5 },
            { keyword: 'low margin', weight: 5 },
            { keyword: 'low order book', weight: 5 },
            { keyword: 'low revenue', weight: 5 },
            { keyword: 'low sales', weight: 5 },
            { keyword: 'low turnover', weight: 5 },
            { keyword: 'lower', weight: 5 },
            { keyword: 'lowering', weight: 5 },
            { keyword: 'lumpy', weight: 5 },
            { keyword: 'malicious', weight: 5 },
            { keyword: 'market value decline', weight: 5 },
            { keyword: 'menacing', weight: 5 },
            { keyword: 'messy', weight: 5 },
            { keyword: 'mischievous', weight: 5 },
            { keyword: 'miserable', weight: 5 },
            { keyword: 'misshapen', weight: 5 },
            { keyword: 'missing', weight: 5 },
            { keyword: 'misunderstood', weight: 5 },
            { keyword: 'monstrous', weight: 5 },
            { keyword: 'naÃ¯ve', weight: 5 },
            { keyword: 'nasty', weight: 5 },
            { keyword: 'naughty', weight: 5 },
            { keyword: 'negative', weight: 5 },
            { keyword: 'negative cash flow', weight: 5 },
            { keyword: 'negative financial state', weight: 5 },
            { keyword: 'negative order book', weight: 5 },
            { keyword: 'negate', weight: 5 },
            { keyword: 'neglect', weight: 5 },
            { keyword: 'never', weight: 5 },
            { keyword: 'nondescript', weight: 5 },
            { keyword: 'nonsense', weight: 5 },
            { keyword: 'not to par', weight: 5 },
            { keyword: 'not up to scratch', weight: 5 },
            { keyword: 'noxious', weight: 5 },
            { keyword: 'objectionable', weight: 5 },
            { keyword: 'obliterate', weight: 5 },
            { keyword: 'obliterated', weight: 5 },
            { keyword: 'odious', weight: 5 },
            { keyword: 'offensive', weight: 5 },
            { keyword: 'oppressive', weight: 5 },
            { keyword: 'outstanding debts', weight: 5 },
            { keyword: 'pain', weight: 5 },
            { keyword: 'parlous', weight: 5 },
            { keyword: 'pathetic', weight: 5 },
            { keyword: 'pessimistic', weight: 5 },
            { keyword: 'perturb', weight: 5 },
            { keyword: 'petty', weight: 5 },
            { keyword: 'pitiful', weight: 5 },
            { keyword: 'poisonous', weight: 5 },
            { keyword: 'poor', weight: 5 },
            { keyword: 'poor credit control', weight: 5 },
            { keyword: 'poor credit ratings', weight: 5 },
            { keyword: 'poor report', weight: 5 },
            { keyword: 'poor reports', weight: 5 },
            { keyword: 'prejudice', weight: 5 },
            { keyword: 'product call back', weight: 5 },
            { keyword: 'product call backs', weight: 5 },
            { keyword: 'questionable', weight: 5 },
            { keyword: 'quit', weight: 5 },
            { keyword: 'reduce', weight: 5 },
            { keyword: 'reducing', weight: 5 },
            { keyword: 'reducing orders', weight: 5 },
            { keyword: 'reduction', weight: 5 },
            { keyword: 'redundancies', weight: 5 },
            { keyword: 'regrettable', weight: 5 },
            { keyword: 'reject', weight: 5 },
            { keyword: 'renege', weight: 5 },
            { keyword: 'repellant', weight: 5 },
            { keyword: 'repugnant', weight: 5 },
            { keyword: 'repulsive', weight: 5 },
            { keyword: 'revenge', weight: 5 },
            { keyword: 'revolting', weight: 5 },
            { keyword: 'rocky', weight: 5 },
            { keyword: 'rotten', weight: 5 },
            { keyword: 'rubbish', weight: 5 },
            { keyword: 'rude', weight: 5 },
            { keyword: 'ruinous', weight: 5 },
            { keyword: 'sacking', weight: 5 },
            { keyword: 'sad', weight: 5 },
            { keyword: 'scanty', weight: 5 },
            { keyword: 'second-class', weight: 5 },
            { keyword: 'second-rate', weight: 5 },
            { keyword: 'severe', weight: 5 },
            { keyword: 'severe financial trouble', weight: 5 },
            { keyword: 'serious decline', weight: 5 },
            { keyword: 'shoddy', weight: 5 },
            { keyword: 'shocking', weight: 5 },
            { keyword: 'shrink', weight: 5 },
            { keyword: 'shrinking', weight: 5 },
            { keyword: 'shutdown', weight: 5 },
            { keyword: 'significant drop', weight: 5 },
            { keyword: 'slow economic growth', weight: 5 },
            { keyword: 'stagflation', weight: 5 },
            { keyword: 'struggling', weight: 5 },
            { keyword: 'struggles', weight: 5 },
            { keyword: 'subdued', weight: 5 },
            { keyword: 'subside', weight: 5 },
            { keyword: 'substandard', weight: 5 },
            { keyword: 'suffering', weight: 5 },
            { keyword: 'substandard', weight: 5 },
            { keyword: 'terrible', weight: 5 },
            { keyword: 'terrifying', weight: 5 },
            { keyword: 'third-rate', weight: 5 },
            { keyword: 'threatening', weight: 5 },
            { keyword: 'tragedy', weight: 5 },
            { keyword: 'troubled', weight: 5 },
            { keyword: 'unacceptable', weight: 5 },
            { keyword: 'unfavourable', weight: 5 },
            { keyword: 'unfavorable', weight: 5 },
            { keyword: 'unfortunate', weight: 5 },
            { keyword: 'unhealthy', weight: 5 },
            { keyword: 'unlucky', weight: 5 },
            { keyword: 'unpleasant', weight: 5 },
            { keyword: 'unprofitable', weight: 5 },
            { keyword: 'unsatisfactory', weight: 5 },
            { keyword: 'unsuitable', weight: 5 },
            { keyword: 'unskilled', weight: 5 },
            { keyword: 'unwelcome', weight: 5 },
            { keyword: 'unpropitious', weight: 5 },
            { keyword: 'untoward', weight: 5 },
            { keyword: 'useless', weight: 5 },
            { keyword: 'vulnerable', weight: 5 },
            { keyword: 'wane', weight: 5 },
            { keyword: 'weak leadership', weight: 5 },
            { keyword: 'weak management', weight: 5 },
            { keyword: 'worthless', weight: 5 },
            { keyword: 'wretched', weight: 5 },
            { keyword: 'wrong', weight: 5 },
            { keyword: 'wipe out', weight: 5 }
        ],
        'emoji': 'ğŸ˜¢'
    }
};

// Expanded Dummy Data with new sectors
let companies = [
  {name:"Nvidia",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"Pfizer",sector:"Pharma",sad:null,neutral:null,happy:null},
  {name:"Broadcom",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"NextEra Energy",sector:"Electricity",sad:null,neutral:null,happy:null},
  {name:"TSMC",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"Tesla",sector:"Automobile",sad:null,neutral:null,happy:null},
  {name:"Samsung",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"Rio Tinto",sector:"Mining",sad:null,neutral:null,happy:null},
  {name:"IonQ",sector:"Quantum",sad:null,neutral:null,happy:null},
  {name:"AMD",sector:"Semiconductor",sad:null,neutral:null,happy:null},
  {name:"JPMorgan Chase",sector:"Finance",sad:null,neutral:null,happy:null},
  {name:"Walmart",sector:"Retail",sad:null,neutral:null,happy:null},
  {name:"Microsoft",sector:"Technology",sad:null,neutral:null,happy:null},
  {name:"Goldman Sachs",sector:"Finance",sad:null,neutral:null,happy:null},
  {name:"Amazon",sector:"Retail",sad:null,neutral:null,happy:null},
  {name:"Apple",sector:"Technology",sad:null,neutral:null,happy:null}
];

// Test companies storage
let testCompanies = [];
let testResults = {};

// Import logging system
let importLog = [];
let importedFiles = [];
let keywordScores = {};

let editIndex = -1;
let analysisInProgress = false;
let refreshInterval = null;
let currentSector = 'mylist'; // Default tab
let currentRagEditIndex = -1; // Track which company's RAG we're editing
let selectedExportFormat = 'csv'; // Default export format
let selectedFile = null;
let selectedImportFormat = 'csv';

// Enhanced tab names with new sectors and custom tabs
let tabNames = {
  'mylist': 'My List',
  'Semiconductor': 'Semiconductors',
  'Pharma': 'Pharma',
  'Electricity': 'Electricity',
  'Mining': 'Mining',
  'Automobile': 'Automobile',
  'Quantum': 'Quantum',
  'Finance': 'Finance',
  'Retail': 'Retail',
  'Technology': 'Technology'
};

// Custom tabs storage
let customTabs = [];

// Countdown timer variables
let countdownInterval = null;
let estimatedTimeRemaining = 0;
const TIME_PER_COMPANY = 11.69; // seconds per company

function getRAG(sad, happy, company = null) {
  // Check for manual RAG override
  if (company && company.ragOverride) {
    return company.ragOverride;
  }
  
  if (sad === null || happy === null) return '';
  if (happy >= 70) return 'green';
  if (sad >= 70) return 'red';
  return 'yellow';
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// Function to calculate total analysis time for current tab
function calculateTotalAnalysisTime() {
  let companiesToAnalyze = [];
  
  if (currentSector === 'mylist') {
    companiesToAnalyze = companies;
  } else {
    companiesToAnalyze = companies.filter(c => c.sector === currentSector);
  }
  
  const totalCompanies = companiesToAnalyze.length;
  return Math.round(totalCompanies * TIME_PER_COMPANY); // Total seconds
}

// Function to start countdown timer
function startCountdownTimer() {
  // Clear any existing timer
  if (countdownInterval) clearInterval(countdownInterval);
  
  // Calculate estimated time
  estimatedTimeRemaining = calculateTotalAnalysisTime();
  
  const analyzeBtn = document.getElementById('analyzeBtn');
  
  // Create countdown overlay if it doesn't exist
  let countdownOverlay = document.getElementById('countdownOverlay');
  if (!countdownOverlay) {
    const btnContainer = analyzeBtn.parentNode;
    countdownOverlay = document.createElement('div');
    countdownOverlay.id = 'countdownOverlay';
    countdownOverlay.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      color: white;
      font-weight: bold;
      font-size: 24px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    `;
    btnContainer.style.position = 'relative';
    btnContainer.appendChild(countdownOverlay);
  }
  
  // Show countdown
  countdownOverlay.style.opacity = '1';
  
  // Update countdown every second
  countdownInterval = setInterval(() => {
    estimatedTimeRemaining--;
    
    if (estimatedTimeRemaining <= 0) {
      clearInterval(countdownInterval);
      countdownOverlay.style.opacity = '0';
      return;
    }
    
    // Format time as MM:SS
    const minutes = Math.floor(estimatedTimeRemaining / 60);
    const seconds = estimatedTimeRemaining % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Update timer display
    countdownOverlay.textContent = timeString;
    
  }, 1000);
}

// Function to stop countdown timer
function stopCountdownTimer() {
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
  
  const countdownOverlay = document.getElementById('countdownOverlay');
  if (countdownOverlay) {
    countdownOverlay.style.opacity = '0';
  }
}

// Existing MyList name editing functions
function enableMyListNameEdit() {
  const display = document.getElementById('mylistNameDisplay');
  const input = document.getElementById('mylistNameInput');
  const text = document.getElementById('mylistNameText');
  
  // Hide display, show input
  display.style.display = 'none';
  input.style.display = 'block';
  input.focus();
  input.select();
  
  // Handle input events
  input.onkeydown = function(e) {
    if (e.key === 'Enter') {
      saveMyListName();
    } else if (e.key === 'Escape') {
      cancelMyListNameEdit();
    }
  };
  
  input.onblur = function() {
    saveMyListName();
  };
}

function saveMyListName() {
  const display = document.getElementById('mylistNameDisplay');
  const input = document.getElementById('mylistNameInput');
  const text = document.getElementById('mylistNameText');
  const newName = input.value.trim();
  
  if (newName) {
    // Update the tab name in our object
    tabNames[currentSector] = newName;
    
    // Update the display
    text.textContent = newName;
    
    // Update the tab name in navigation
    updateTabNameInNavigation(currentSector, newName);
    
    showToast('âœ… List name updated!');
  }
  
  // Reset UI
  display.style.display = 'flex';
  input.style.display = 'none';
}

function updateTabNameInNavigation(sector, newName) {
  const navButtons = document.querySelectorAll('.nav-btn');
  navButtons.forEach(btn => {
    if (btn.getAttribute('data-sector') === sector) {
      const tabNameSpan = btn.querySelector('.tab-name');
      if (tabNameSpan) {
        tabNameSpan.textContent = newName;
      }
    }
  });
}

function cancelMyListNameEdit() {
  const display = document.getElementById('mylistNameDisplay');
  const input = document.getElementById('mylistNameInput');
  
  // Reset input value to current name
  input.value = tabNames[currentSector];
  
  // Reset UI
  display.style.display = 'flex';
  input.style.display = 'none';
}

// Existing MyList action buttons
function handleMyListAction(action) {
  switch(action) {
    case 'guide':
      openGuideModal();
      break;
    case 'keyword':
      openKeywordModal();
      break;
    case 'export':
      openExportModal();
      break;
    case 'compare':
      openCompareModal();
      break;
  }
}

// Enhanced populate keyword modal with individual containers and weight scores
function populateKeywordModal() {
    const container = document.getElementById('keywordsContainer');
    let html = '';
    
    // Update keyword counts
    const allCount = emotions.happy.keywords.length + emotions.neutral.keywords.length + emotions.sad.keywords.length;
    document.getElementById('allKeywordCount').textContent = allCount;
    document.getElementById('happyKeywordCount').textContent = emotions.happy.keywords.length;
    document.getElementById('neutralKeywordCount').textContent = emotions.neutral.keywords.length;
    document.getElementById('sadKeywordCount').textContent = emotions.sad.keywords.length;
    
    // Create keyword items for all emotions
    for (const [emotion, data] of Object.entries(emotions)) {
        const keywords = data.keywords;
        
        keywords.forEach((keywordObj, index) => {
            const keyword = keywordObj.keyword;
            const weight = keywordObj.weight;
            
            html += `
        <div class="keyword-item ${emotion}" data-emotion="${emotion}" data-index="${index}" data-keyword="${keyword}">
          <div class="keyword-header">
            <div class="keyword-text">${keyword}</div>
            <div class="keyword-score-weight">
              <div class="keyword-score">${weight}</div>
              <div class="keyword-weight-badge" title="Weight Score">W:${weight}</div>
            </div>
          </div>
          <div class="keyword-emotion">
            <span class="icon">${data.emoji}</span>
            <span>${emotion.charAt(0).toUpperCase() + emotion.slice(1)}</span>
          </div>
          <div style="display:flex; gap:6px; margin-top:12px;">
            <button class="keyword-action-btn copy" data-keyword="${keyword}" style="flex:1; padding:8px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; background: rgba(102, 126, 234, 0.1); color: #667eea;">
              <span class="icon">ğŸ“‹</span>
              <span>Copy</span>
            </button>
            <button class="keyword-action-btn edit" data-keyword="${keyword}" style="flex:1; padding:8px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; background: linear-gradient(135deg, #42a5f5, #1e88e5); color: white;">
              <span class="icon">âœï¸</span>
              <span>Edit</span>
            </button>
            <button class="keyword-action-btn delete" data-keyword="${keyword}" style="flex:1; padding:8px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; background: linear-gradient(135deg, #ef5350, #e53935); color: white;">
              <span class="icon">ğŸ—‘ï¸</span>
              <span>Delete</span>
            </button>
          </div>
        </div>
      `;
        });
    }
    
    container.innerHTML = html;
    
    // Add copy functionality
    container.addEventListener('click', function(e) {
      const btn = e.target.closest('.keyword-action-btn');
      if (!btn) return;

      if (btn.classList.contains('copy')) {
        const keyword = btn.getAttribute('data-keyword');
        copyKeyword(keyword);
        return;
      }

      if (btn.classList.contains('edit')) {
        const item = btn.closest('.keyword-item');
        const keyword = item.getAttribute('data-keyword');
        const emotion = item.getAttribute('data-emotion');
        const index = parseInt(item.getAttribute('data-index'));
        openEditKeywordModal(keyword, emotion, index);
        return;
      }

      if (btn.classList.contains('delete')) {
        const item = btn.closest('.keyword-item');
        const keyword = item.getAttribute('data-keyword');
        const emotion = item.getAttribute('data-emotion');
        deleteKeyword(keyword, emotion);
        return;
      }
    });
    
    // Add search functionality
    const searchInput = document.getElementById('keywordSearch');
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        filterKeywords(searchTerm);
    });
    
    // Update top keywords display
    updateTopKeywordsDisplay();
    
    // Apply current filter
    filterKeywordsByEmotion(currentKeywordFilter);
}

// Filter keywords by emotion
function filterKeywordsByEmotion(emotion) {
    currentKeywordFilter = emotion;
    
    // Update active tab
    document.querySelectorAll('.keyword-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-emotion') === emotion) {
            btn.classList.add('active');
        }
    });
    
    // Show/hide keyword items
    const keywordItems = document.querySelectorAll('.keyword-item');
    
    keywordItems.forEach(item => {
        const itemEmotion = item.getAttribute('data-emotion');
        
        if (emotion === 'all' || itemEmotion === emotion) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
    
    // Handle empty state
    const container = document.getElementById('keywordsContainer');
    const visibleItems = container.querySelectorAll('.keyword-item[style*="display: block"]');
    
    if (visibleItems.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-keywords-state';
        emptyState.innerHTML = `
            <div class="icon">ğŸ”</div>
            <div>No keywords found</div>
        `;
        
        // Remove existing empty state if any
        const existingEmptyState = container.querySelector('.empty-keywords-state');
        if (existingEmptyState) existingEmptyState.remove();
        
        container.appendChild(emptyState);
    } else {
        // Remove empty state if it exists
        const emptyState = container.querySelector('.empty-keywords-state');
        if (emptyState) emptyState.remove();
    }
}

// Enhanced filter keywords with emotion filtering
function filterKeywords(searchTerm) {
    const keywordItems = document.querySelectorAll('.keyword-item');
    
    keywordItems.forEach(item => {
        const keywordText = item.querySelector('.keyword-text').textContent.toLowerCase();
        const itemEmotion = item.getAttribute('data-emotion');
        
        // Check if item matches current emotion filter
        const emotionMatch = currentKeywordFilter === 'all' || itemEmotion === currentKeywordFilter;
        
        if (searchTerm === '') {
            item.style.display = emotionMatch ? 'block' : 'none';
        } else {
            if (keywordText.includes(searchTerm) && emotionMatch) {
                item.style.display = 'block';
                // Highlight the search term in the keyword text
                const keywordElement = item.querySelector('.keyword-text');
                const originalText = keywordElement.textContent;
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                keywordElement.innerHTML = originalText.replace(regex, '<span class="highlight">$1</span>');
            } else {
                item.style.display = 'none';
            }
        }
    });
    
    // Handle empty state
    const container = document.getElementById('keywordsContainer');
    const visibleItems = container.querySelectorAll('.keyword-item[style*="display: block"]');
    
    if (visibleItems.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-keywords-state';
        emptyState.innerHTML = `
            <div class="icon">ğŸ”</div>
            <div>No keywords found for "${searchTerm}"</div>
        `;
        
        // Remove existing empty state if any
        const existingEmptyState = container.querySelector('.empty-keywords-state');
        if (existingEmptyState) existingEmptyState.remove();
        
        container.appendChild(emptyState);
    } else {
        // Remove empty state if it exists
        const emptyState = container.querySelector('.empty-keywords-state');
        if (emptyState) emptyState.remove();
    }
}

// Copy keyword to clipboard
function copyKeyword(keyword) {
    navigator.clipboard.writeText(keyword)
        .then(() => {
            showToast('ğŸ“‹ Keyword copied to clipboard!');
        })
        .catch(err => {
            console.error('Failed to copy keyword:', err);
            showToast('âŒ Failed to copy keyword');
        });
}

// Copy all keywords to clipboard
function copyAllKeywords() {
    let allKeywords = '';
    
    for (const [emotion, data] of Object.entries(emotions)) {
        const emotionName = emotion.charAt(0).toUpperCase() + emotion.slice(1);
        allKeywords += `${emotionName} Keywords:\n`;
        data.keywords.forEach(keywordObj => {
            allKeywords += `${keywordObj.keyword} (Weight: ${keywordObj.weight})\n`;
        });
        allKeywords += '\n';
    }
    
    navigator.clipboard.writeText(allKeywords.trim())
        .then(() => {
            showToast('ğŸ“‹ All keywords copied to clipboard!');
        })
        .catch(err => {
            console.error('Failed to copy keywords:', err);
            showToast('âŒ Failed to copy keywords');
        });
}

// Function to export keywords to CSV
function exportKeywordsToCSV() {
  let allKeywords = [];
  
  // Collect all keywords with their scores
  for (const [emotion, data] of Object.entries(emotions)) {
    data.keywords.forEach(keywordObj => {
      allKeywords.push({
        keyword: keywordObj.keyword,
        score: keywordObj.weight,
        emotion: emotion
      });
    });
  }
  
  // Create CSV content
  let csvContent = 'keyword_name,keyword_score,emotion\n';
  
  allKeywords.forEach(kw => {
    csvContent += `"${kw.keyword}",${kw.score},"${kw.emotion}"\n`;
  });
  
  // Create download link
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sentiment_keywords_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  showToast('ğŸ“¤ Keywords exported to CSV!');
}

// Existing modal functions
function openGuideModal() {
  document.getElementById('guideModal').style.display = 'flex';
}

function closeGuideModal() {
  document.getElementById('guideModal').style.display = 'none';
}

// Open keyword modal
function openKeywordModal() {
    document.getElementById('keywordModal').style.display = 'flex';
    
    // Populate the modal with enhanced keyword data
    populateKeywordModal();
    
    // Show imported files info
    updateImportedFilesDisplay();
    
    // Reset search
    document.getElementById('keywordSearch').value = '';
    
    // Reset to all filter
    currentKeywordFilter = 'all';
    document.querySelectorAll('.keyword-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.keyword-tab-btn[data-emotion="all"]').classList.add('active');
}

function closeKeywordModal() {
    document.getElementById('keywordModal').style.display = 'none';
}

// Edit Keyword Modal functions and markup
function openEditKeywordModal(keyword, emotion, index) {
  currentEditKeyword = { keyword: keyword, emotion: emotion, index: index };
  document.getElementById('editKeywordName').value = keyword;
  document.getElementById('editKeywordEmotion').value = emotion;
  const scoreInput = document.getElementById('editKeywordScore');
  const existing = emotions[emotion] && emotions[emotion].keywords[index];
  scoreInput.value = existing ? (existing.weight || 5) : 5;
  document.getElementById('editKeywordModal').style.display = 'flex';
}

function closeEditKeywordModal() {
  document.getElementById('editKeywordModal').style.display = 'none';
  currentEditKeyword = null;
}

function saveKeywordEdit() {
  if (!currentEditKeyword) return;
  const newScore = parseInt(document.getElementById('editKeywordScore').value) || 1;
  const newEmotion = document.getElementById('editKeywordEmotion').value;
  const { keyword, emotion: oldEmotion, index } = currentEditKeyword;

  keywordScores[keyword.toLowerCase()] = newScore;

  if (newEmotion !== oldEmotion) {
    emotions[oldEmotion].keywords = emotions[oldEmotion].keywords.filter(kw => kw.keyword !== keyword);
    const exists = emotions[newEmotion].keywords.find(kw => kw.keyword === keyword);
    if (exists) {
      exists.weight = newScore;
    } else {
      emotions[newEmotion].keywords.push({ keyword: keyword, weight: newScore });
    }
  } else {
    if (emotions[oldEmotion].keywords[index] && emotions[oldEmotion].keywords[index].keyword === keyword) {
      emotions[oldEmotion].keywords[index].weight = newScore;
    } else {
      const found = emotions[oldEmotion].keywords.find(kw => kw.keyword === keyword);
      if (found) found.weight = newScore;
    }
  }

  showToast('âœ… Keyword updated');
  closeEditKeywordModal();
  const km = document.getElementById('keywordModal');
  if (km && km.style.display === 'flex') populateKeywordModal();
}

function deleteKeyword(keyword, emotion) {
  if (!confirm(`Delete keyword "${keyword}"?`)) return;
  emotions[emotion].keywords = emotions[emotion].keywords.filter(kw => kw.keyword !== keyword);
  delete keywordScores[keyword.toLowerCase()];
  showToast('ğŸ—‘ï¸ Keyword deleted');
  const km = document.getElementById('keywordModal');
  if (km && km.style.display === 'flex') populateKeywordModal();
}

function openAddKeywordModal() {
  document.getElementById('addKeywordName').value = '';
  document.getElementById('addKeywordEmotion').value = 'happy';
  document.getElementById('addKeywordScore').value = '5';
  document.getElementById('addKeywordModal').style.display = 'flex';
}

function closeAddKeywordModal() {
  document.getElementById('addKeywordModal').style.display = 'none';
}

function saveNewKeyword() {
  const keyword = document.getElementById('addKeywordName').value.trim().toLowerCase();
  const emotion = document.getElementById('addKeywordEmotion').value;
  const score = parseInt(document.getElementById('addKeywordScore').value) || 5;
  
  if (!keyword) {
    showToast('âš ï¸ Please enter a keyword');
    return;
  }
  
  // Check if keyword exists
  const exists = emotions[emotion].keywords.find(kw => kw.keyword === keyword);
  if (exists) {
    showToast('âš ï¸ Keyword already exists');
    return;
  }
  
  // Add new keyword
  emotions[emotion].keywords.push({ keyword: keyword, weight: score });
  keywordScores[keyword] = score;
  
  showToast('âœ… Keyword added successfully');
  closeAddKeywordModal();
  populateKeywordModal();
}

function getTopKeywords() {
  // Get all keywords with their frequency (used in scores)
  const keywordFreq = {};
  
  for (const emotion in emotions) {
    emotions[emotion].keywords.forEach(kw => {
      const keyword = kw.keyword;
      keywordFreq[keyword] = (keywordFreq[keyword] || 0) + kw.weight;
    });
  }
  
  // Sort by frequency
  const sorted = Object.entries(keywordFreq)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 2);
  
  return sorted.map(([keyword, freq]) => ({
    keyword,
    frequency: freq
  }));
}

function updateTopKeywordsDisplay() {
  const topKeywords = getTopKeywords();
  
  if (topKeywords.length >= 1) {
    document.getElementById('topKeyword1').textContent = `${topKeywords[0].keyword} (${topKeywords[0].frequency})`;
  }
  if (topKeywords.length >= 2) {
    document.getElementById('topKeyword2').textContent = `${topKeywords[1].keyword} (${topKeywords[1].frequency})`;
  }
}

// Open export modal - MODIFIED TO RESTRICT TO CSV ONLY
function openExportModal() {
  document.getElementById('exportModal').style.display = 'flex';
  
  // Update import log display
  updateImportLogDisplay();
  
  // Reset selection
  document.querySelectorAll('.export-option').forEach(opt => {
    opt.classList.remove('selected');
    if (opt.getAttribute('data-format') === selectedExportFormat) {
      opt.classList.add('selected');
    }
  });
  
  // Reset import selection - Only CSV option available
  document.querySelectorAll('.import-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  document.querySelector('.import-option[onclick*="csv"]').classList.add('selected');
  
  // Clear file input
  clearImport();
}

function closeExportModal() {
  document.getElementById('exportModal').style.display = 'none';
}

// Select export option
function selectExportOption(format) {
  selectedExportFormat = format;
  document.querySelectorAll('.export-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  document.querySelector(`.export-option[data-format="${format}"]`).classList.add('selected');
}

// Select import option - RESTRICTED TO CSV ONLY
function selectImportOption(format) {
  selectedImportFormat = 'csv'; // Only CSV allowed
  document.querySelectorAll('.import-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  // Find the CSV option
  const csvOption = document.querySelector('.import-option[onclick*="csv"]');
  if (csvOption) {
    csvOption.classList.add('selected');
  }
  
  // Update file input accept attribute to only CSV
  const fileInput = document.getElementById('importFile');
  fileInput.accept = '.csv';
}

// Handle file import - RESTRICTED TO CSV ONLY
function handleFileImport() {
  const fileInput = document.getElementById('importFile');
  const fileNameDisplay = document.getElementById('selectedFileName');
  
  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    // Check if file is CSV
    if (!file.name.toLowerCase().endsWith('.csv')) {
      showToast('âŒ Only CSV files are allowed for import');
      fileInput.value = '';
      fileNameDisplay.textContent = 'No file selected';
      fileNameDisplay.style.color = '#666';
      selectedFile = null;
      return;
    }
    
    selectedFile = file;
    fileNameDisplay.textContent = `Selected: ${selectedFile.name} (${(selectedFile.size / 1024).toFixed(2)} KB)`;
    fileNameDisplay.style.color = '#667eea';
  } else {
    selectedFile = null;
    fileNameDisplay.textContent = 'No file selected';
    fileNameDisplay.style.color = '#666';
  }
}

// Clear import
function clearImport() {
  document.getElementById('importFile').value = '';
  document.getElementById('selectedFileName').textContent = 'No file selected';
  document.getElementById('selectedFileName').style.color = '#666';
  selectedFile = null;
}

// Enhanced CSV export
function exportToCSVEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata, formatNumbers) {
  // Create CSV headers
  let headers = ['Company', 'Sector', 'Sad %', 'Neutral %', 'Happy %'];
  if (includeRAG) headers.push('RAG Status');
  if (includeTimestamps) headers.push('Last Analyzed');
  
  let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
  
  companiesToExport.forEach(company => {
    const sad = company.sad !== null ? (formatNumbers ? `${company.sad}%` : company.sad) : "N/A";
    const neutral = company.neutral !== null ? (formatNumbers ? `${company.neutral}%` : company.neutral) : "N/A";
    const happy = company.happy !== null ? (formatNumbers ? `${company.happy}%` : company.happy) : "N/A";
    const rag = company.sad !== null && company.happy !== null ? getRAG(company.sad, company.happy) : "N/A";
    
    let row = [
      `"${company.name}"`,
      `"${company.sector}"`,
      `"${sad}"`,
      `"${neutral}"`,
      `"${happy}"`
    ];
    
    if (includeRAG) row.push(`"${rag}"`);
    if (includeTimestamps) row.push(`"${new Date().toISOString()}"`);
    
    csvContent += row.join(',') + '\n';
  });
  
  if (includeMetadata) {
    csvContent += '\n' + `"Metadata","Value"` + '\n';
    csvContent += `"Export Date","${new Date().toISOString()}"` + '\n';
    csvContent += `"Total Companies","${companiesToExport.length}"` + '\n';
    csvContent += `"Analyzed Companies","${companiesToExport.filter(c => c.sad !== null).length}"` + '\n';
    csvContent += `"Export Scope","${document.getElementById('exportScope').value}"` + '\n';
    csvContent += `"Export Format","${selectedExportFormat}"` + '\n';
  }
  
  // Create download link
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sentiment_analysis_${new Date().toISOString().split('T')[0]}_${companiesToExport.length}_companies.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  showToast('ğŸ“¤ CSV data exported successfully!');
}

// Enhanced JSON export
function exportToJSONEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata) {
  const exportData = {
    exportDate: new Date().toISOString(),
    totalCompanies: companiesToExport.length,
    analyzedCompanies: companiesToExport.filter(c => c.sad !== null).length,
    companies: companiesToExport.map(company => {
      const data = {
        name: company.name,
        sector: company.sector,
        sentiment: {
          sad: company.sad,
          neutral: company.neutral,
          happy: company.happy
        }
      };
      
      if (includeRAG && company.sad !== null && company.happy !== null) {
        data.rag = getRAG(company.sad, company.happy);
      }
      
      if (includeTimestamps) {
        data.lastAnalyzed = new Date().toISOString();
        data.analysisDate = new Date().toISOString();
      }
      
      return data;
    })
  };
  
  if (includeMetadata) {
    exportData.metadata = {
      totalCompanies: companiesToExport.length,
      analyzedCompanies: companiesToExport.filter(c => c.sad !== null).length,
      exportScope: document.getElementById('exportScope').value,
      exportFormat: selectedExportFormat,
      version: '1.0.0',
      emotionKeywords: {
        happy: emotions.happy.keywords.length,
        neutral: emotions.neutral.keywords.length,
        sad: emotions.sad.keywords.length
      }
    };
  }
  
  const jsonString = JSON.stringify(exportData, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sentiment_analysis_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  showToast('ğŸ“¤ JSON data exported successfully!');
}

// PDF export
function exportToPDF(companiesToExport, includeRAG, includeTimestamps, includeMetadata) {
  // Create a simple PDF using jsPDF (you'll need to include jsPDF library)
  showToast('ğŸ“Š PDF export requires jsPDF library. For now, exporting as CSV...');
  
  // Fallback to CSV export
  exportToCSVEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata, true);
}

// Excel export
function exportToExcel(companiesToExport, includeRAG, includeTimestamps, includeMetadata) {
  // For Excel export, we can create an enhanced CSV that Excel can open nicely
  let headers = ['Company', 'Sector', 'Sad %', 'Neutral %', 'Happy %', 'RAG Status'];
  
  let csvContent = 'sep=,\n'; // Excel separator
  csvContent += headers.map(h => `"${h}"`).join(',') + '\n';
  
  companiesToExport.forEach(company => {
    const sad = company.sad !== null ? `${company.sad}%` : "N/A";
    const neutral = company.neutral !== null ? `${company.neutral}%` : "N/A";
    const happy = company.happy !== null ? `${company.happy}%` : "N/A";
    const rag = company.sad !== null && company.happy !== null ? getRAG(company.sad, company.happy) : "N/A";
    
    let row = [
      `"${company.name}"`,
      `"${company.sector}"`,
      `"${sad}"`,
      `"${neutral}"`,
      `"${happy}"`,
      `"${rag}"`
    ];
    
    csvContent += row.join(',') + '\n';
  });
  
  // Create download link
  const blob = new Blob([csvContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sentiment_analysis_${new Date().toISOString().split('T')[0]}.xls`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  showToast('ğŸ“ˆ Excel file exported successfully!');
}

// Perform export
function performExport() {
  const scope = document.getElementById('exportScope').value;
  const includeRAG = document.getElementById('includeRAG').checked;
  const includeTimestamps = document.getElementById('includeTimestamps').checked;
  const includeMetadata = document.getElementById('includeMetadata').checked;
  const formatNumbers = document.getElementById('formatNumbers').checked;
  
  let companiesToExport = [];
  
  // Filter companies based on scope
  switch(scope) {
    case 'current':
      if (currentSector === 'mylist') {
        companiesToExport = companies;
      } else {
        companiesToExport = companies.filter(c => c.sector === currentSector);
      }
      break;
    case 'all':
      companiesToExport = companies;
      break;
    case 'analyzed':
      companiesToExport = companies.filter(c => c.sad !== null && c.neutral !== null && c.happy !== null);
      break;
    case 'custom':
      // For custom selection, show a prompt for now
      const selectedNames = prompt('Enter company names to export (comma-separated):');
      if (selectedNames) {
        const names = selectedNames.split(',').map(name => name.trim());
        companiesToExport = companies.filter(c => names.includes(c.name));
      } else {
        companiesToExport = companies; // Fallback to all
      }
      break;
  }
  
  if (companiesToExport.length === 0) {
    showToast('âš ï¸ No companies to export');
    return;
  }
  
  // Create export data based on format
  switch(selectedExportFormat) {
    case 'csv':
      exportToCSVEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata, formatNumbers);
      break;
    case 'json':
      exportToJSONEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata);
      break;
    case 'pdf':
      exportToPDF(companiesToExport, includeRAG, includeTimestamps, includeMetadata);
      break;
    case 'excel':
      exportToExcel(companiesToExport, includeRAG, includeTimestamps, includeMetadata);
      break;
    default:
      exportToCSVEnhanced(companiesToExport, includeRAG, includeTimestamps, includeMetadata, formatNumbers);
  }
  
  closeExportModal();
}

// Update import log display
function updateImportLogDisplay() {
  const logContainer = document.getElementById('importLog');
  
  if (importLog.length === 0) {
    logContainer.innerHTML = 'No imports yet.';
    return;
  }
  
  // Show last 5 imports
  const recentLogs = importLog.slice(-5).reverse();
  
  logContainer.innerHTML = recentLogs.map(log => `
    <div style="padding: 5px 0; border-bottom: 1px solid #e9ecef;">
      <div style="display: flex; justify-content: space-between;">
        <span style="font-weight: 600;">${log.fileName}</span>
        <span style="color: #667eea; font-size: 11px;">${new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
      </div>
      <div style="font-size: 11px; color: #666;">
        ${log.type === 'keywords' ? 'Keywords' : 'Companies'}: ${log.count} ${log.action === 'import' ? 'imported' : log.action}
      </div>
    </div>
  `).join('');
}

// Update imported files display in keyword modal
function updateImportedFilesDisplay() {
  const filesInfo = document.getElementById('importedFilesInfo');
  const filesList = document.getElementById('importedFilesList');
  
  if (importedFiles.length === 0) {
    filesInfo.style.display = 'none';
    return;
  }
  
  filesInfo.style.display = 'block';
  
  // Show last 3 imported files
  const recentFiles = importedFiles.slice(-3).reverse();
  
  filesList.innerHTML = recentFiles.map(file => `
    <div style="background: rgba(102, 126, 234, 0.1); padding: 4px 8px; border-radius: 6px; display: flex; align-items: center; gap: 4px;">
      <span class="icon" style="font-size: 10px;">ğŸ“</span>
      <span title="${file.name}">${file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name}</span>
      <span style="color: #667eea; font-weight: 600;">(${file.keywordCount})</span>
    </div>
  `).join('');
  
  // Add tooltip for more files
  if (importedFiles.length > 3) {
    filesList.innerHTML += `
      <div style="background: #f5f5f5; padding: 4px 8px; border-radius: 6px; cursor: help;" 
           title="Total ${importedFiles.length} files imported with ${importedFiles.reduce((sum, file) => sum + file.keywordCount, 0)} keywords">
        +${importedFiles.length - 3} more
      </div>
    `;
  }
}

// Function to clear import log
function clearImportLog() {
  if (confirm('Clear all import history?')) {
    importLog = [];
    importedFiles = [];
    updateImportLogDisplay();
    updateImportedFilesDisplay();
    showToast('ğŸ—‘ï¸ Import log cleared');
  }
}

// Function to import keywords from CSV (keyword_name,keyword_score format)
async function importKeywordsFromCSV(csvText) {
  const lines = csvText.split('\n').filter(line => line.trim());
  let importedCount = 0;
  
  // Skip header if present
  const startIndex = lines[0].toLowerCase().includes('keyword') ? 1 : 0;
  
  for (let i = startIndex; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    // Parse the line: keyword_name,keyword_score
    const parts = line.split(',').map(part => part.trim().replace(/"/g, ''));
    
    if (parts.length >= 2) {
      const keywordName = parts[0].toLowerCase();
      const keywordScore = parseInt(parts[1]) || 5; // Default score if not provided
      
      // Store keyword score
      keywordScores[keywordName] = keywordScore;
      
      // Update keyword in emotions if it exists
      let keywordUpdated = false;
      
      // Check and update in happy keywords
      emotions.happy.keywords = emotions.happy.keywords.map(kw => {
        if (kw.keyword.toLowerCase() === keywordName) {
          keywordUpdated = true;
          return { ...kw, weight: keywordScore };
        }
        return kw;
      });
      
      // Check and update in neutral keywords
      emotions.neutral.keywords = emotions.neutral.keywords.map(kw => {
        if (kw.keyword.toLowerCase() === keywordName) {
          keywordUpdated = true;
          return { ...kw, weight: keywordScore };
        }
        return kw;
      });
      
      // Check and update in sad keywords
      emotions.sad.keywords = emotions.sad.keywords.map(kw => {
        if (kw.keyword.toLowerCase() === keywordName) {
          keywordUpdated = true;
          return { ...kw, weight: keywordScore };
        }
        return kw;
      });
      
      // If keyword doesn't exist, add it to appropriate category based on score
      if (!keywordUpdated) {
        // You could add logic here to determine which category to add it to
        // For now, let's add it to neutral with the imported score
        emotions.neutral.keywords.push({
          keyword: keywordName,
          weight: keywordScore
        });
      }
      
      importedCount++;
    }
  }
  
  return importedCount;
}

// Perform import - MODIFIED FOR CSV ONLY
async function performImport() {
  if (!selectedFile) {
    showToast('âš ï¸ Please select a CSV file to import');
    return;
  }

  // Ensure it's a CSV file
  if (!selectedFile.name.toLowerCase().endsWith('.csv')) {
    showToast('âŒ Only CSV files are allowed for import');
    return;
  }

  const importMode = document.querySelector('input[name="importMode"]:checked').value;
  const keepScores = document.getElementById('importWithScores').checked;
  
  try {
    const text = await selectedFile.text();
    let importCount = 0;
    let updateCount = 0;
    let keywordImportCount = 0;
    
    // Check if this is a keyword import (keyword_name,keyword_score format)
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length === 0) {
      showToast('âš ï¸ CSV file is empty');
      return;
    }
    
    // Check first line to determine format
    const firstLine = lines[0].toLowerCase();
    const isKeywordImport = firstLine.includes('keyword') && firstLine.includes('score');
    
    if (isKeywordImport) {
      // Handle keyword import: keyword_name,keyword_score format
      keywordImportCount = await importKeywordsFromCSV(text);
      
      // Add to import log
      const logEntry = {
        timestamp: new Date().toISOString(),
        fileName: selectedFile.name,
        type: 'keywords',
        count: keywordImportCount,
        action: 'import'
      };
      importLog.push(logEntry);
      updateImportLogDisplay();
      
      // Update imported files list
      importedFiles.push({
        name: selectedFile.name,
        date: new Date().toISOString(),
        keywordCount: keywordImportCount
      });
      updateImportedFilesDisplay();
      
      showToast(`âœ… Imported ${keywordImportCount} keywords from CSV!`);
      
    } else {
      // Handle company data import (original functionality)
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        
        // Handle quoted CSV values
        const values = [];
        let inQuotes = false;
        let currentValue = '';
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(currentValue.trim().replace(/"/g, ''));
            currentValue = '';
          } else {
            currentValue += char;
          }
        }
        values.push(currentValue.trim().replace(/"/g, ''));
        
        const companyData = {};
        headers.forEach((header, index) => {
          if (index < values.length) {
            companyData[header] = values[index];
          }
        });
        
        if (!companyData.company && !companyData.name) {
          continue; // Skip if no company name
        }
        
        const companyName = companyData.company || companyData.name || companyData['company name'];
        const sector = companyData.sector || companyData.industry || 'Technology';
        
        const existingIndex = companies.findIndex(c => 
          c.name.toLowerCase() === companyName.toLowerCase()
        );
        
        if (existingIndex !== -1) {
          if (importMode === 'update' || importMode === 'replace') {
            // Update existing company
            if (keepScores) {
              companies[existingIndex].sad = parseInt(companyData['sad %'] || companyData.sad) || companies[existingIndex].sad;
              companies[existingIndex].neutral = parseInt(companyData['neutral %'] || companyData.neutral) || companies[existingIndex].neutral;
              companies[existingIndex].happy = parseInt(companyData['happy %'] || companyData.happy) || companies[existingIndex].happy;
            }
            companies[existingIndex].sector = sector || companies[existingIndex].sector;
            updateCount++;
          }
        } else if (importMode !== 'update') {
          // Add new company
          companies.push({
            name: companyName,
            sector: sector,
            sad: keepScores ? (parseInt(companyData['sad %'] || companyData.sad) || null) : null,
            neutral: keepScores ? (parseInt(companyData['neutral %'] || companyData.neutral) || null) : null,
            happy: keepScores ? (parseInt(companyData['happy %'] || companyData.happy) || null) : null
          });
          importCount++;
        }
      }
      
      if (importMode === 'replace') {
        // Remove all existing companies and add imported ones
        companies = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;
          
          // Parse CSV line (simplified)
          const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
          const companyData = {};
          headers.forEach((header, index) => {
            if (index < values.length) {
              companyData[header] = values[index];
            }
          });
          
          if (!companyData.company && !companyData.name) continue;
          
          const companyName = companyData.company || companyData.name || companyData['company name'];
          const sector = companyData.sector || companyData.industry || 'Technology';
          
          companies.push({
            name: companyName,
            sector: sector,
            sad: keepScores ? (parseInt(companyData['sad %'] || companyData.sad) || null) : null,
            neutral: keepScores ? (parseInt(companyData['neutral %'] || companyData.neutral) || null) : null,
            happy: keepScores ? (parseInt(companyData['happy %'] || companyData.happy) || null) : null
          });
          importCount++;
        }
      }
      
      // Add to import log
      const logEntry = {
        timestamp: new Date().toISOString(),
        fileName: selectedFile.name,
        type: 'companies',
        count: importCount + updateCount,
        action: importMode
      };
      importLog.push(logEntry);
      updateImportLogDisplay();
      
      renderTable();
      showToast(`âœ… Imported ${importCount} new companies, updated ${updateCount} existing companies from CSV`);
    }
    
    closeExportModal();
    
  } catch (error) {
    console.error('Import error:', error);
    showToast('âŒ Error importing CSV file. Please check the format and try again.');
  }
}

// Open compare modal
function openCompareModal() {
  // Calculate comparison data
  const companiesWithData = companies.filter(c => c.sad !== null && c.neutral !== null && c.happy !== null);
  
  if (companiesWithData.length > 0) {
    // Find company with highest happy percentage
    const happiest = companiesWithData.reduce((prev, current) => 
      (prev.happy > current.happy) ? prev : current
    );
    
    // Find company with highest sad percentage
    const saddest = companiesWithData.reduce((prev, current) => 
      (prev.sad > current.sad) ? prev : current
    );
    
    // Find company with most balanced sentiment
    const mostBalanced = companiesWithData.reduce((prev, current) => {
      const prevDiff = Math.abs(prev.happy - prev.sad);
      const currentDiff = Math.abs(current.happy - current.sad);
      return (prevDiff < currentDiff) ? prev : current;
    });
    
    // Update UI
    document.getElementById('happiestCompany').textContent = `${happiest.name} (${happiest.happy}%)`;
    document.getElementById('saddestCompany').textContent = `${saddest.name} (${saddest.sad}%)`;
    document.getElementById('mostBalancedCompany').textContent = `${mostBalanced.name} (${mostBalanced.happy}% happy, ${mostBalanced.sad}% sad)`;
    
    // Update metrics
    document.getElementById('totalCompanies').textContent = companies.length;
    document.getElementById('analyzedCompanies').textContent = companiesWithData.length;
    
    // Calculate average sentiment
    const avgSentiment = companiesWithData.length > 0 
      ? Math.round(companiesWithData.reduce((sum, c) => sum + c.happy, 0) / companiesWithData.length)
      : 0;
    document.getElementById('avgSentiment').textContent = `${avgSentiment}%`;
    
    // Calculate sector distribution
    const sectorDistribution = document.getElementById('sectorDistribution');
    const sectors = {};
    
    companies.forEach(company => {
      sectors[company.sector] = (sectors[company.sector] || 0) + 1;
    });
    
    let sectorHTML = '';
    for (const [sector, count] of Object.entries(sectors)) {
      sectorHTML += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 500;">${sector}</span>
          <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${count}</span>
        </div>
      `;
    }
    
    sectorDistribution.innerHTML = sectorHTML;
  }
  
  document.getElementById('compareModal').style.display = 'flex';
}

function closeCompareModal() {
  document.getElementById('compareModal').style.display = 'none';
}

function exportComparison() {
  showToast('ğŸ“Š Comparison exported!');
  closeCompareModal();
}

// RAG Editing Functions
function editRagStatus(companyIndex) {
  const company = companies[companyIndex];
  currentRagEditIndex = companyIndex;
  
  // Set modal values
  document.getElementById('ragCompanyName').value = company.name;
  
  // Determine current RAG - check for override first
  const currentRag = company.ragOverride || getRAG(company.sad, company.happy, company);
  
  // Set selected RAG option
  document.querySelectorAll('.rag-edit-option').forEach(option => {
    option.classList.remove('selected');
    if (option.getAttribute('data-rag') === currentRag) {
      option.classList.add('selected');
    }
  });
  
  // Set manual sentiment values if they exist
  document.getElementById('manualSad').value = company.sad || '';
  document.getElementById('manualNeutral').value = company.neutral || '';
  document.getElementById('manualHappy').value = company.happy || '';
  
  // Show modal
  document.getElementById('editRagModal').style.display = 'flex';
}

function closeEditRagModal() {
  document.getElementById('editRagModal').style.display = 'none';
  currentRagEditIndex = -1;
}

function saveRagEdit() {
  if (currentRagEditIndex === -1) return;
  
  const selectedRag = document.querySelector('.rag-edit-option.selected').getAttribute('data-rag');
  const manualSad = document.getElementById('manualSad').value;
  const manualNeutral = document.getElementById('manualNeutral').value;
  const manualHappy = document.getElementById('manualHappy').value;
  
  // Store the selected RAG color
  companies[currentRagEditIndex].ragOverride = selectedRag;
  
  // If manual values are provided, update sentiment percentages
  if (manualSad || manualNeutral || manualHappy) {
    companies[currentRagEditIndex].sad = manualSad ? parseInt(manualSad) : companies[currentRagEditIndex].sad;
    companies[currentRagEditIndex].neutral = manualNeutral ? parseInt(manualNeutral) : companies[currentRagEditIndex].neutral;
    companies[currentRagEditIndex].happy = manualHappy ? parseInt(manualHappy) : companies[currentRagEditIndex].happy;
  }
  
  // Clear any calculated RAG since we have an override
  delete companies[currentRagEditIndex].calculatedRAG;
  
  renderTable();
  closeEditRagModal();
  showToast('âœ… RAG status updated successfully!');
}

// Add Tab Functions
function openAddTabModal() {
  document.getElementById('addTabModal').style.display = 'flex';
  document.getElementById('newTabName').value = '';
  document.getElementById('newTabIcon').value = 'ğŸ¢';
  
  // Reset color selection
  document.querySelectorAll('.color-option').forEach(option => {
    option.style.border = '2px solid transparent';
  });
  // Select first color by default
  document.querySelector('.color-option').style.border = '2px solid #667eea';
}

function closeAddTabModal() {
  document.getElementById('addTabModal').style.display = 'none';
}

function createNewTab() {
  const tabName = document.getElementById('newTabName').value.trim();
  const tabIcon = document.getElementById('newTabIcon').value;
  const selectedColor = document.querySelector('.color-option[style*="border: 2px solid rgb(102, 126, 234)"]');
  
  if (!tabName) {
    showToast('âš ï¸ Please enter a tab name');
    return;
  }
  
  if (!selectedColor) {
    showToast('âš ï¸ Please select a color');
    return;
  }
  
  const tabId = tabName.toLowerCase().replace(/\s+/g, '_');
  const tabColor = selectedColor.getAttribute('data-color');
  
  // Add to custom tabs
  customTabs.push({
    id: tabId,
    name: tabName,
    icon: tabIcon,
    color: tabColor
  });
  
  // Add to tabNames for rendering
  tabNames[tabId] = tabName;
  
  // Create new tab button
  const navBar = document.getElementById('navBar');
  const addTabBtn = document.getElementById('addTabBtn');
  const newTabBtn = document.createElement('button');
  newTabBtn.className = 'nav-btn custom-tab';
  newTabBtn.setAttribute('data-sector', tabId);
  newTabBtn.innerHTML = `
    <span class="icon">${tabIcon}</span>
    <span class="tab-name">${tabName}</span>
    <button class="remove-tab" onclick="removeCustomTab('${tabId}', event)">Ã—</button>
  `;
  
  // Insert before add button
  navBar.insertBefore(newTabBtn, addTabBtn);
  
  // Add event listener
  newTabBtn.addEventListener('click', function() {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentSector = tabId;
    renderTable();
  });
  
  // Add CSS for this tab's mylist-header style
  const style = document.createElement('style');
  style.textContent = `
    .mylist-header.${tabId} { 
      background: ${tabColor}; 
    }
  `;
  document.head.appendChild(style);
  
  closeAddTabModal();
  showToast(`âœ… Tab "${tabName}" created successfully!`);
}

function removeCustomTab(tabId, event) {
  event.stopPropagation();
  
  if (confirm(`Remove tab "${tabNames[tabId]}"?`)) {
    // Remove from customTabs array
    customTabs = customTabs.filter(tab => tab.id !== tabId);
    
    // Remove from tabNames
    delete tabNames[tabId];
    
    // Remove button from DOM
    const tabBtn = document.querySelector(`.nav-btn[data-sector="${tabId}"]`);
    if (tabBtn) tabBtn.remove();
    
    // If this was the active tab, switch to My List
    if (currentSector === tabId) {
      currentSector = 'mylist';
      document.querySelector('.nav-btn[data-sector="mylist"]').classList.add('active');
      renderTable();
    }
    
    showToast(`ğŸ—‘ï¸ Tab removed successfully!`);
  }
}

function clearRagOverride() {
  if (currentRagEditIndex === -1) return;
  
  delete companies[currentRagEditIndex].ragOverride;
  renderTable();
  closeEditRagModal();
  showToast('ğŸ”„ RAG reset to automatic calculation');
}

// Enhanced Test Modal Functions
function openTestModal() {
  document.getElementById('testModal').style.display = 'flex';
  
  // Clear previous results
  clearTestResults();
  
  // Reset companies list
  testCompanies = [];
  testResults = {};
  renderTestCompaniesList();
  
  // Populate keyword lists with all keywords
  const positiveList = document.getElementById('positiveKeywordsList');
  const negativeList = document.getElementById('negativeKeywordsList');
  const neutralList = document.getElementById('neutralKeywordsList');
  
  positiveList.innerHTML = emotions.happy.keywords.slice(0, 30).map(keywordObj => 
    `<span class="keyword-tag happy">${keywordObj.keyword} (${keywordObj.weight})</span>`
  ).join('');
  
  negativeList.innerHTML = emotions.sad.keywords.slice(0, 30).map(keywordObj => 
    `<span class="keyword-tag sad">${keywordObj.keyword} (${keywordObj.weight})</span>`
  ).join('');
  
  neutralList.innerHTML = emotions.neutral.keywords.slice(0, 30).map(keywordObj => 
    `<span class="keyword-tag neutral">${keywordObj.keyword} (${keywordObj.weight})</span>`
  ).join('');
  
  // Hide results section initially
  document.getElementById('testResultsSection').style.display = 'none';
}

function closeTestModal() {
  document.getElementById('testModal').style.display = 'none';
}

// Add company to test modal with sector
function addTestCompany() {
  const companyName = document.getElementById('testCompanyName').value.trim();
  const companySector = document.getElementById('testCompanySector').value;
  
  if (!companyName) {
    showToast('âš ï¸ Please enter a company name');
    return;
  }
  
  // Check if company already exists in test
  if (testCompanies.some(c => c.name.toLowerCase() === companyName.toLowerCase())) {
    showToast('âš ï¸ Company already added to test');
    return;
  }
  
  // Add to test companies with sector
  testCompanies.push({
    name: companyName,
    sector: companySector,
    keywords: {
      positive: [],
      negative: [],
      neutral: []
    },
    sentences: []
  });
  
  // Clear input
  document.getElementById('testCompanyName').value = '';
  
  // Update display
  renderTestCompaniesList();
  
  showToast(`âœ… "${companyName}" added to test (${companySector})`);
}

// Render test companies list with sector
function renderTestCompaniesList() {
  const container = document.getElementById('testCompaniesList');
  
  if (testCompanies.length === 0) {
    container.innerHTML = '<div class="empty-state" style="text-align: center; color: #999; padding: 20px;">No companies added yet. Add a company to test sentiment analysis.</div>';
    return;
  }
  
  container.innerHTML = testCompanies.map((company, index) => `
    <div class="test-company-item">
      <div>
        <div class="test-company-name">${company.name}</div>
        <div style="font-size: 11px; color: #667eea; font-weight: 600; margin-top: 2px;">
          <span class="sector-badge" style="font-size: 10px; padding: 2px 8px;">${company.sector}</span>
        </div>
        <div class="test-company-keywords">
          ${company.keywords.positive.length > 0 ? `ğŸ‘ ${company.keywords.positive.length} positive` : ''}
          ${company.keywords.positive.length > 0 && company.keywords.negative.length > 0 ? ' â€¢ ' : ''}
          ${company.keywords.negative.length > 0 ? `ğŸ‘ ${company.keywords.negative.length} negative` : ''}
          ${(company.keywords.positive.length > 0 || company.keywords.negative.length > 0) && company.keywords.neutral.length > 0 ? ' â€¢ ' : ''}
          ${company.keywords.neutral.length > 0 ? `ğŸ˜ ${company.keywords.neutral.length} neutral` : ''}
        </div>
      </div>
      <button class="remove-test-company" onclick="removeTestCompany(${index})">Ã—</button>
    </div>
  `).join('');
}

// Remove test company
function removeTestCompany(index) {
  testCompanies.splice(index, 1);
  renderTestCompaniesList();
  showToast('ğŸ—‘ï¸ Company removed from test');
}

// Enhanced sentiment analysis test with detailed results and weight scoring
function runSentimentTest() {
  const textInput = document.getElementById('testTextInput').value;
  
  if (!textInput.trim()) {
    showToast('âš ï¸ Please enter some text to analyze');
    return;
  }
  
  // Show loading state
  document.getElementById('happyScoreValue').textContent = '...';
  document.getElementById('sadScoreValue').textContent = '...';
  document.getElementById('neutralScoreValue').textContent = '...';
  document.getElementById('pieChartCenter').textContent = '...';
  document.getElementById('confidenceScore').textContent = '...';
  
  // Analyze text sentiment with enhanced details and weight scoring
  const analysis = analyzeTextSentimentEnhancedWithWeight(textInput);
  
  // Update word count and keyword count
  const wordCount = textInput.trim().split(/\s+/).length;
  const totalKeywords = analysis.detectedKeywords.length;
  
  document.getElementById('wordCount').textContent = wordCount;
  document.getElementById('keywordCount').textContent = totalKeywords;
  document.getElementById('analysisDetails').textContent = 
    `Analyzed ${wordCount} words with ${totalKeywords} keywords detected`;
  
  // Calculate percentages for visualization (using weighted scores)
  const totalWeight = analysis.happyWeight + analysis.sadWeight + analysis.neutralWeight;
  const happyPercent = totalWeight > 0 ? Math.round((analysis.happyWeight / totalWeight) * 100) : 0;
  const sadPercent = totalWeight > 0 ? Math.round((analysis.sadWeight / totalWeight) * 100) : 0;
  const neutralPercent = totalWeight > 0 ? Math.round((analysis.neutralWeight / totalWeight) * 100) : 0;
  
  // Update text displays
  document.getElementById('happyScoreValue').textContent = `${happyPercent}%`;
  document.getElementById('sadScoreValue').textContent = `${sadPercent}%`;
  document.getElementById('neutralScoreValue').textContent = `${neutralPercent}%`;
  document.getElementById('legendHappy').textContent = `${happyPercent}%`;
  document.getElementById('legendSad').textContent = `${sadPercent}%`;
  document.getElementById('legendNeutral').textContent = `${neutralPercent}%`;
  document.getElementById('pieChartCenter').textContent = `${happyPercent}% Pos`;
  
  // Update keyword counts
  document.getElementById('positiveKeywordCount').textContent = `${analysis.positiveKeywords.length} keywords`;
  document.getElementById('negativeKeywordCount').textContent = `${analysis.negativeKeywords.length} keywords`;
  document.getElementById('neutralKeywordCount').textContent = `${analysis.neutralKeywords.length} keywords`;
  
  // Update overall sentiment badge
  const overallSentimentBadge = document.getElementById('overallSentimentBadge');
  if (happyPercent >= 60) {
    overallSentimentBadge.textContent = 'Mostly Positive';
    overallSentimentBadge.style.background = 'linear-gradient(135deg, #4caf50, #2e7d32)';
  } else if (sadPercent >= 60) {
    overallSentimentBadge.textContent = 'Mostly Negative';
    overallSentimentBadge.style.background = 'linear-gradient(135deg, #f44336, #c62828)';
  } else {
    overallSentimentBadge.textContent = 'Mixed/Neutral';
    overallSentimentBadge.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
  }
  
  // Calculate and display confidence score
  const confidenceScore = Math.min(100, Math.round((totalKeywords / Math.max(wordCount, 1)) * 100 * 3));
  document.getElementById('confidenceScore').textContent = `${confidenceScore}%`;
  document.getElementById('confidenceBar').style.width = `${confidenceScore}%`;
  
  // Update total keyword statistics
  document.getElementById('totalPositiveKeywords').textContent = analysis.positiveKeywords.length;
  document.getElementById('totalNegativeKeywords').textContent = analysis.negativeKeywords.length;
  document.getElementById('totalNeutralKeywords').textContent = analysis.neutralKeywords.length;
  
  // Show top keywords with weight scores
  displayTopKeywordsWithWeight(analysis);
  
  // Animate chart bars
  animateChartBars(happyPercent, sadPercent, neutralPercent);
  
  // Update pie chart
  updatePieChart(happyPercent, sadPercent, neutralPercent);
  
  // Show results section
  document.getElementById('testResultsSection').style.display = 'block';
  
  // Update test companies with analysis results
  updateTestCompaniesWithAnalysis(analysis);
  
  // Show company-specific results
  displayCompanyTestResults(analysis);
  
  // Populate keyword lists with weight scores
  populateEnhancedKeywordListsWithWeight(analysis);
  
  // Setup keyword search
  setupKeywordSearch(analysis);
  
  showToast('âœ… Sentiment analysis complete!');
}

// Enhanced sentiment analysis with weight scoring
function analyzeTextSentimentEnhancedWithWeight(text) {
  const lowerText = text.toLowerCase();
  
  let happyScore = 0;
  let sadScore = 0;
  let neutralScore = 0;
  let happyWeight = 0;
  let sadWeight = 0;
  let neutralWeight = 0;
  const detectedPositive = [];
  const detectedNegative = [];
  const detectedNeutral = [];
  const detectedKeywords = [];
  
  // Check for happy keywords with weight
  emotions.happy.keywords.forEach(keywordObj => {
    const keyword = keywordObj.keyword;
    const weight = keywordObj.weight;
    const regex = new RegExp(`\\b${keyword.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
    const matches = lowerText.match(regex);
    if (matches) {
      happyScore += matches.length;
      happyWeight += matches.length * weight;
      if (!detectedPositive.find(k => k.keyword === keyword)) {
        detectedPositive.push({ keyword, weight, count: matches.length });
        detectedKeywords.push({ keyword, weight, count: matches.length, type: 'positive' });
      }
    }
  });
  
  // Check for sad keywords with weight
  emotions.sad.keywords.forEach(keywordObj => {
    const keyword = keywordObj.keyword;
    const weight = keywordObj.weight;
    const regex = new RegExp(`\\b${keyword.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
    const matches = lowerText.match(regex);
    if (matches) {
      sadScore += matches.length;
      sadWeight += matches.length * weight;
      if (!detectedNegative.find(k => k.keyword === keyword)) {
        detectedNegative.push({ keyword, weight, count: matches.length });
        detectedKeywords.push({ keyword, weight, count: matches.length, type: 'negative' });
      }
    }
  });
  
  // Check for neutral keywords with weight
  emotions.neutral.keywords.forEach(keywordObj => {
    const keyword = keywordObj.keyword;
    const weight = keywordObj.weight;
    const regex = new RegExp(`\\b${keyword.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
    const matches = lowerText.match(regex);
    if (matches) {
      neutralScore += matches.length;
      neutralWeight += matches.length * weight;
      if (!detectedNeutral.find(k => k.keyword === keyword)) {
        detectedNeutral.push({ keyword, weight, count: matches.length });
        detectedKeywords.push({ keyword, weight, count: matches.length, type: 'neutral' });
      }
    }
  });
  
  const totalWeight = happyWeight + sadWeight + neutralWeight;
  const happyPercent = totalWeight > 0 ? Math.round((happyWeight / totalWeight) * 100) : 0;
  const sadPercent = totalWeight > 0 ? Math.round((sadWeight / totalWeight) * 100) : 0;
  const neutralPercent = totalWeight > 0 ? Math.round((neutralWeight / totalWeight) * 100) : 0;
  
  return {
    happy: happyScore,
    sad: sadScore,
    neutral: neutralScore,
    happyWeight,
    sadWeight,
    neutralWeight,
    happyPercent,
    sadPercent,
    neutralPercent,
    positiveKeywords: detectedPositive,
    negativeKeywords: detectedNegative,
    neutralKeywords: detectedNeutral,
    detectedKeywords,
    text: text
  };
}

// Display top keywords with weight scores
function displayTopKeywordsWithWeight(analysis) {
  const container = document.getElementById('topKeywordsContainer');
  
  // Sort keywords by weight (frequency * weight)
  const sortedKeywords = analysis.detectedKeywords
    .sort((a, b) => (b.count * b.weight) - (a.count * a.weight))
    .slice(0, 15); // Show top 15 keywords
  
  container.innerHTML = sortedKeywords.map(kw => `
    <div class="top-keyword-tag ${kw.type}" title="Found ${kw.count} time${kw.count > 1 ? 's' : ''} (Weight: ${kw.weight})">
      ${kw.keyword}
      <span class="score-badge">${kw.count}Ã—${kw.weight}</span>
    </div>
  `).join('');
}

// Enhanced chart animation
function animateChartBars(happyPercent, sadPercent, neutralPercent) {
  const happyBar = document.getElementById('happyBar');
  const sadBar = document.getElementById('sadBar');
  const neutralBar = document.getElementById('neutralBar');
  
  // Reset widths first
  happyBar.style.width = '0%';
  sadBar.style.width = '0%';
  neutralBar.style.width = '0%';
  
  // Animate to target widths with delays
  setTimeout(() => happyBar.style.width = `${happyPercent}%`, 100);
  setTimeout(() => sadBar.style.width = `${sadPercent}%`, 300);
  setTimeout(() => neutralBar.style.width = `${neutralPercent}%`, 500);
}

// Enhanced pie chart update
function updatePieChart(happyPercent, sadPercent, neutralPercent) {
  const pieChart = document.getElementById('sentimentPieChart');
  
  pieChart.style.setProperty('--happy-percent', `${happyPercent}%`);
  pieChart.style.setProperty('--neutral-percent', `${neutralPercent}%`);
  pieChart.style.setProperty('--sad-percent', `${sadPercent}%`);
  
  pieChart.style.background = `conic-gradient(
    #4caf50 0% ${happyPercent}%,
    #ff9800 ${happyPercent}% ${happyPercent + neutralPercent}%,
    #f44336 ${happyPercent + neutralPercent}% ${happyPercent + neutralPercent + sadPercent}%
  )`;
}

// Enhanced keyword list population with weight scores
function populateEnhancedKeywordListsWithWeight(analysis) {
  // Populate positive keywords with weight
  const positiveList = document.getElementById('positiveKeywordsList');
  positiveList.innerHTML = analysis.positiveKeywords.slice(0, 30).map(keywordObj => 
    `<span class="keyword-tag happy" title="Weight: ${keywordObj.weight}">${keywordObj.keyword} (${keywordObj.weight})</span>`
  ).join('');
  
  // Populate negative keywords with weight
  const negativeList = document.getElementById('negativeKeywordsList');
  negativeList.innerHTML = analysis.negativeKeywords.slice(0, 30).map(keywordObj => 
    `<span class="keyword-tag sad" title="Weight: ${keywordObj.weight}">${keywordObj.keyword} (${keywordObj.weight})</span>`
  ).join('');
  
  // Populate neutral keywords with weight
  const neutralList = document.getElementById('neutralKeywordsList');
  neutralList.innerHTML = analysis.neutralKeywords.slice(0, 30).map(keywordObj => 
    `<span class="keyword-tag neutral" title="Weight: ${keywordObj.weight}">${keywordObj.keyword} (${keywordObj.weight})</span>`
  ).join('');
}

// Setup keyword search in test modal
function setupKeywordSearch(analysis) {
  const searchInput = document.getElementById('keywordSearchTest');
  
  searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    
    // Filter all keyword lists
    ['positiveKeywordsList', 'negativeKeywordsList', 'neutralKeywordsList'].forEach(listId => {
      const container = document.getElementById(listId);
      const keywordTags = container.querySelectorAll('.keyword-tag');
      
      keywordTags.forEach(tag => {
        const keyword = tag.textContent.toLowerCase();
        if (searchTerm === '' || keyword.includes(searchTerm)) {
          tag.style.display = 'inline-block';
        } else {
          tag.style.display = 'none';
        }
      });
    });
  });
}

// Update test companies with analysis
function updateTestCompaniesWithAnalysis(analysis) {
  testCompanies.forEach(company => {
    // Add detected keywords to each company
    company.keywords.positive = analysis.positiveKeywords.filter(kw => 
      company.name.toLowerCase().includes(kw.keyword) || 
      analysis.text.toLowerCase().includes(company.name.toLowerCase())
    );
    
    company.keywords.negative = analysis.negativeKeywords.filter(kw => 
      company.name.toLowerCase().includes(kw.keyword) || 
      analysis.text.toLowerCase().includes(company.name.toLowerCase())
    );
    
    company.keywords.neutral = analysis.neutralKeywords.filter(kw => 
      company.name.toLowerCase().includes(kw.keyword) || 
      analysis.text.toLowerCase().includes(company.name.toLowerCase())
    );
    
    // Add sentences containing company name
    const sentences = analysis.text.split(/[.!?]+/);
    company.sentences = sentences.filter(sentence => 
      sentence.toLowerCase().includes(company.name.toLowerCase())
    );
    
    // Store analysis results with sector
    testResults[company.name] = {
      name: company.name,
      sector: company.sector,
      happy: analysis.happyPercent,
      sad: analysis.sadPercent,
      neutral: analysis.neutralPercent,
      positiveKeywords: company.keywords.positive,
      negativeKeywords: company.keywords.negative,
      neutralKeywords: company.keywords.neutral,
      sentences: company.sentences
    };
  });
  
  // Update companies list display
  renderTestCompaniesList();
}

// Display company test results
function displayCompanyTestResults(analysis) {
  const container = document.getElementById('companyTestResults');
  
  if (testCompanies.length === 0) {
    container.innerHTML = `
      <div class="chart-container">
        <div class="chart-title">ğŸ¢ No Companies to Analyze</div>
        <p style="color: #666; text-align: center;">Add companies above to see their specific analysis results.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = testCompanies.map(company => {
    const result = testResults[company.name];
    const happyPercent = result ? result.happy : 0;
    const sadPercent = result ? result.sad : 0;
    const neutralPercent = result ? result.neutral : 0;
    
    return `
      <div class="chart-container">
        <div class="chart-title">ğŸ¢ ${company.name}</div>
        <div class="sentiment-chart">
          <div class="chart-bar">
            <div class="chart-bar-label">
              <span>ğŸ˜Š Positive</span>
              <span class="chart-bar-value">${happyPercent}%</span>
            </div>
            <div class="chart-bar-track">
              <div class="chart-bar-fill happy" style="width: ${happyPercent}%"></div>
            </div>
          </div>
          <div class="chart-bar">
            <div class="chart-bar-label">
              <span>ğŸ˜¢ Negative</span>
              <span class="chart-bar-value">${sadPercent}%</span>
            </div>
            <div class="chart-bar-track">
              <div class="chart-bar-fill sad" style="width: ${sadPercent}%"></div>
            </div>
          </div>
          <div class="chart-bar">
            <div class="chart-bar-label">
              <span>ğŸ˜ Neutral</span>
              <span class="chart-bar-value">${neutralPercent}%</span>
            </div>
            <div class="chart-bar-track">
              <div class="chart-bar-fill neutral" style="width: ${neutralPercent}%"></div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 15px;">
          <div style="font-size: 14px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Detected Keywords:</div>
          <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
            ${result.positiveKeywords.map(keywordObj => 
              `<span class="keyword-tag happy" style="font-size: 11px;">${keywordObj.keyword} (${keywordObj.weight})</span>`
            ).join('')}
            ${result.negativeKeywords.map(keywordObj => 
              `<span class="keyword-tag sad" style="font-size: 11px;">${keywordObj.keyword} (${keywordObj.weight})</span>`
            ).join('')}
            ${result.neutralKeywords.map(keywordObj => 
              `<span class="keyword-tag neutral" style="font-size: 11px;">${keywordObj.keyword} (${keywordObj.weight})</span>`
            ).join('')}
          </div>
          
          ${result.sentences.length > 0 ? `
            <div style="font-size: 14px; font-weight: 600; color: #1a1a2e; margin-bottom: 10px;">Relevant Sentences:</div>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 13px; color: #555;">
              ${result.sentences.slice(0, 3).map(sentence => 
                `<p style="margin: 5px 0;">â€¢ ${sentence.trim()}.</p>`
              ).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

// Save test results to main companies list with correct sector
function saveTestToCompany() {
  if (testCompanies.length === 0) {
    showToast('âš ï¸ No test companies to save');
    return;
  }
  
  let savedCount = 0;
  let updatedCount = 0;
  
  testCompanies.forEach(company => {
    const result = testResults[company.name];
    if (!result) return;
    
    // Check if company already exists
    const existingIndex = companies.findIndex(c => 
      c.name.toLowerCase() === company.name.toLowerCase()
    );
    
    if (existingIndex !== -1) {
      // Update existing company with new sentiment scores
      companies[existingIndex].sad = result.sad;
      companies[existingIndex].happy = result.happy;
      companies[existingIndex].neutral = result.neutral || (100 - result.sad - result.happy);
      
      // Update sector if different
      if (company.sector && company.sector !== companies[existingIndex].sector) {
        companies[existingIndex].sector = company.sector;
      }
      
      // Clear loading/empty states
      delete companies[existingIndex].ragOverride;
      updatedCount++;
    } else {
      // Add new company with sector from test
      companies.push({
        name: company.name,
        sector: company.sector || 'Technology',
        sad: result.sad,
        happy: result.happy,
        neutral: result.neutral || (100 - result.sad - result.happy)
      });
      savedCount++;
    }
  });
  
  if (savedCount > 0 || updatedCount > 0) {
    renderTable();
    
    let message = '';
    if (savedCount > 0 && updatedCount > 0) {
      message = `âœ… ${savedCount} new companies added and ${updatedCount} existing companies updated!`;
    } else if (savedCount > 0) {
      message = `âœ… ${savedCount} new companies saved to main list!`;
    } else if (updatedCount > 0) {
      message = `âœ… ${updatedCount} existing companies updated with new sentiment scores!`;
    }
    
    showToast(message);
    
    // Close test modal
    closeTestModal();
  } else {
    showToast('âš ï¸ No companies were saved or updated');
  }
}

// Enhanced clear test results
function clearTestResults() {
  document.getElementById('testTextInput').value = '';
  document.getElementById('happyScoreValue').textContent = '0%';
  document.getElementById('sadScoreValue').textContent = '0%';
  document.getElementById('neutralScoreValue').textContent = '0%';
  document.getElementById('legendHappy').textContent = '0%';
  document.getElementById('legendSad').textContent = '0%';
  document.getElementById('legendNeutral').textContent = '0%';
  document.getElementById('pieChartCenter').textContent = '0%';
  document.getElementById('confidenceScore').textContent = '0%';
  document.getElementById('confidenceBar').style.width = '0%';
  
  // Reset charts
  animateChartBars(0, 0, 0);
  updatePieChart(0, 0, 0);
  
  // Clear keyword lists
  document.getElementById('topKeywordsContainer').innerHTML = '';
  document.getElementById('positiveKeywordsList').innerHTML = '';
  document.getElementById('negativeKeywordsList').innerHTML = '';
  document.getElementById('neutralKeywordsList').innerHTML = '';
  
  // Hide results section
  document.getElementById('testResultsSection').style.display = 'none';
  document.getElementById('companyTestResults').innerHTML = '';
  
  // Clear test companies
  testCompanies = [];
  testResults = {};
  renderTestCompaniesList();
  
  // Reset search
  document.getElementById('keywordSearchTest').value = '';
  
  showToast('ğŸ§¹ Test results cleared!');
}

// Tab Navigation Scroll Functions
function setupTabScroll() {
  const navBar = document.getElementById('navBar');
  const scrollLeftBtn = document.getElementById('scrollLeft');
  const scrollRightBtn = document.getElementById('scrollRight');
  
  function updateScrollButtons() {
    const scrollLeft = navBar.scrollLeft;
    const maxScroll = navBar.scrollWidth - navBar.clientWidth;
    
    scrollLeftBtn.classList.toggle('hidden', scrollLeft <= 0);
    scrollRightBtn.classList.toggle('hidden', scrollLeft >= maxScroll - 5);
  }
  
  scrollLeftBtn.addEventListener('click', () => {
    navBar.scrollBy({ left: -200, behavior: 'smooth' });
  });
  
  scrollRightBtn.addEventListener('click', () => {
    navBar.scrollBy({ left: 200, behavior: 'smooth' });
  });
  
  navBar.addEventListener('scroll', updateScrollButtons);
  window.addEventListener('resize', updateScrollButtons);
  
  // Initial update
  updateScrollButtons();
}

// Updated renderTable to include RAG editing and new tabs
function renderTable() {
  const tbody = document.getElementById('tableBody');
  const mylistHeader = document.getElementById('mylistHeader');
  const text = document.getElementById('mylistNameText');
  
  // Update MyList header with current tab name
  text.textContent = tabNames[currentSector];
  const input = document.getElementById('mylistNameInput');
  input.value = tabNames[currentSector];
  
  // Apply tab-specific styling
  mylistHeader.className = 'mylist-header';
  if (currentSector !== 'mylist') {
    mylistHeader.classList.add(currentSector.toLowerCase());
  }
  
  // Filter data
  let displayCompanies = [];
  if (currentSector === 'mylist') {
    displayCompanies = companies; // Show all for My List
  } else {
    displayCompanies = companies.filter(c => c.sector === currentSector);
  }

  if (displayCompanies.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#999;">No companies found in this sector.</td></tr>';
      return;
  }

  tbody.innerHTML = displayCompanies.map((c, i) => {
    // Find original index for actions to work correctly on the main array
    const originalIndex = companies.indexOf(c);
    
    let sadDisplay, neutralDisplay, happyDisplay, ragDisplay;
    
    if (c.sad === null || c.neutral === null || c.happy === null) {
      sadDisplay = '<span class="empty-cell">â€”</span>';
      neutralDisplay = '<span class="empty-cell">â€”</span>';
      happyDisplay = '<span class="empty-cell">â€”</span>';
      ragDisplay = '<span class="empty-cell">â€”</span>';
    } else if (c.sad === 'loading') {
      sadDisplay = '<span class="loading-cell">â³</span>';
      neutralDisplay = '<span class="loading-cell">â³</span>';
      happyDisplay = '<span class="loading-cell">â³</span>';
      ragDisplay = '<span class="loading-cell">â³</span>';
    } else {
      sadDisplay = `${c.sad}%`;
      neutralDisplay = `${c.neutral}%`;
      happyDisplay = `${c.happy}%`;
      const ragStatus = getRAG(c.sad, c.happy, c);
      ragDisplay = `<div class="rag-dot rag-${ragStatus}" onclick="editRagStatus(${originalIndex})" title="Click to edit RAG status"></div>`;
    }
    
    return `
    <tr>
      <td><strong>${i + 1}</strong></td>
      <td class="company-name">${c.name}</td>
      <td><span class="sector-badge">${c.sector}</span></td>
      <td class="score-cell score-sad">${sadDisplay}</td>
      <td class="score-cell score-neutral">${neutralDisplay}</td>
      <td class="score-cell score-happy">${happyDisplay}</td>
      <td><div class="rag-cell">${ragDisplay}</div></td>
      <td>
        <div class="actions-cell">
          <button class="action-btn btn-edit" onclick="editCompany(${originalIndex})" title="Edit">âœï¸</button>
          <button class="action-btn btn-delete" onclick="deleteCompany(${originalIndex})" title="Delete">ğŸ—‘ï¸</button>
          <button class="action-btn btn-up" onclick="moveUp(${originalIndex})" title="Move Up">â†‘</button>
          <button class="action-btn btn-down" onclick="moveDown(${originalIndex})" title="Move Down">â†“</button>
        </div>
      </td>
    </tr>
  `}).join('');
}

// Enhanced analyzeAllCompanies function with countdown - MODIFIED TO ANALYZE ONLY CURRENT TAB
async function analyzeAllCompanies() {
  if (analysisInProgress) {
    showToast('âš ï¸ Analysis already in progress');
    return;
  }
  
  analysisInProgress = true;
  const analyzeBtn = document.getElementById('analyzeBtn');
  const timerDisplay = document.getElementById('timerDisplay');
  const statusDisplay = document.getElementById('statusDisplay');
  
  // Check Timer
  const timerMinutes = parseInt(document.getElementById('timerSelect').value);
  if (timerMinutes > 0) {
      startRefreshTimer(timerMinutes);
  } else {
      if(refreshInterval) clearInterval(refreshInterval);
      document.getElementById('timerLineContainer').style.display = 'none';
  }
  
  analyzeBtn.disabled = true;
  analyzeBtn.innerHTML = '<span class="icon">â³</span><span>Analyzing...</span>';
  
  // Get companies to analyze based on current tab
  let companiesToAnalyze = [];
  if (currentSector === 'mylist') {
    companiesToAnalyze = companies; // Analyze all for My List
  } else {
    companiesToAnalyze = companies.filter(c => c.sector === currentSector);
  }
  
  if (companiesToAnalyze.length === 0) {
    showToast('âš ï¸ No companies to analyze in this tab');
    analysisInProgress = false;
    analyzeBtn.disabled = false;
    analyzeBtn.innerHTML = '<span class="icon">ğŸš€</span><span>Analyze All</span>';
    return;
  }
  
  // Calculate estimated time based on companies in current tab
  estimatedTimeRemaining = Math.round(companiesToAnalyze.length * TIME_PER_COMPANY);
  
  // Start countdown timer
  startCountdownTimer();
  
  let completed = 0;
  const total = companiesToAnalyze.length;
  
  // Use fixed delay of 11.69 seconds per company
  const delay = 11690; // 11.69 seconds in milliseconds
  
  for (let i = 0; i < companiesToAnalyze.length; i++) {
    const company = companiesToAnalyze[i];
    
    // Find the index of this company in the main companies array
    const companyIndex = companies.findIndex(c => c === company);
    
    if (companyIndex === -1) continue; // Skip if not found
    
    // Update status in data
    companies[companyIndex].sad = 'loading';
    companies[companyIndex].neutral = 'loading';
    companies[companyIndex].happy = 'loading';
    renderTable();
    
    timerDisplay.textContent = `Analyzing ${company.name}...`;
    statusDisplay.textContent = `Processing ${completed + 1} of ${total} (${currentSector === 'mylist' ? 'My List' : currentSector})`;
    
    try {
      const response = await fetch(`${API_URL}/api/analyze-single`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ company_name: company.name })
      });
      
      const data = await response.json();
      
      if (data.result) {
        companies[companyIndex].sad = data.result.sad;
        companies[companyIndex].neutral = data.result.neutral;
        companies[companyIndex].happy = data.result.happy;
      } else {
        companies[companyIndex].sad = null; 
        companies[companyIndex].neutral = null; 
        companies[companyIndex].happy = null;
      }
    } catch (error) {
      console.error(`Error analyzing ${company.name}:`, error);
      companies[companyIndex].sad = null; 
      companies[companyIndex].neutral = null; 
      companies[companyIndex].happy = null;
    }
    
    renderTable();
    completed++;
    
    if (i < companiesToAnalyze.length - 1) {
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  
  analysisInProgress = false;
  analyzeBtn.disabled = false;
  analyzeBtn.innerHTML = '<span class="icon">ğŸš€</span><span>Analyze All</span>';
  timerDisplay.textContent = 'Complete!';
  statusDisplay.textContent = `Analyzed ${total} companies in ${currentSector === 'mylist' ? 'My List' : currentSector}`;
  
  // Stop countdown timer
  stopCountdownTimer();
  
  showToast(`âœ… Analysis completed for ${total} companies in ${currentSector === 'mylist' ? 'My List' : currentSector}!`);
}

function startRefreshTimer(minutes) {
    if (refreshInterval) clearInterval(refreshInterval);
    
    const container = document.getElementById('timerLineContainer');
    const fill = document.getElementById('timerLineFill');
    const timeText = document.getElementById('timerTextTime');
    
    container.style.display = 'block';
    
    const duration = minutes * 60 * 1000;
    const endTime = Date.now() + duration;
    
    refreshInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now;
        
        if (remaining <= 0) {
            clearInterval(refreshInterval);
            fill.style.width = '0%';
            timeText.textContent = 'Refreshing...';
            location.reload();
            return;
        }
        
        // Calculate percentage
        const percent = (remaining / duration) * 100;
        fill.style.width = percent + '%';
        
        // Format time mm:ss
        const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((remaining % (1000 * 60)) / 1000);
        timeText.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        
        // Change colors based on remaining percentage
        fill.className = 'timer-line-fill'; // reset
        if (percent < 20) fill.classList.add('danger');
        else if (percent < 50) fill.classList.add('warning');
        
    }, 1000);
}

function openModal(index = -1) {
  editIndex = index;
  document.getElementById('modalTitle').textContent = index === -1 ? 'âœ¨ Add Company' : 'âœï¸ Edit Company';
  if (index >= 0) {
    const c = companies[index];
    document.getElementById('companyName').value = c.name;
    document.getElementById('sectorSelect').value = c.sector;
  } else {
    document.getElementById('companyName').value = '';
    document.getElementById('sectorSelect').value = 'Semiconductor';
  }
  document.getElementById('modalOverlay').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  editIndex = -1;
}

function saveCompany() {
  const name = document.getElementById('companyName').value.trim();
  if (!name) { showToast('âš ï¸ Please enter company name'); return; }
  const sector = document.getElementById('sectorSelect').value;
  
  const company = {name, sector, sad: null, neutral: null, happy: null};
  if (editIndex >= 0) {
    companies[editIndex].name = name;
    companies[editIndex].sector = sector;
    showToast('âœ… Company updated successfully!');
  } else {
    companies.push(company);
    showToast('âœ… Company added successfully!');
  }
  renderTable();
  closeModal();
}

function editCompany(i) { openModal(i); }

function deleteCompany(i) {
  if (confirm(`Delete "${companies[i].name}"?`)) {
    companies.splice(i, 1);
    renderTable();
    showToast('ğŸ—‘ï¸ Company deleted!');
  }
}

function moveUp(i) {
  if (i > 0) {
    [companies[i], companies[i-1]] = [companies[i-1], companies[i]];
    renderTable();
    showToast('â¬†ï¸ Moved up!');
  }
}

function moveDown(i) {
  if (i < companies.length - 1) {
    [companies[i], companies[i+1]] = [companies[i+1], companies[i]];
    renderTable();
    showToast('â¬‡ï¸ Moved down!');
  }
}

function addNewKeyword() {
    // REMOVED: Edit functionality removed
    showToast('âš ï¸ Keyword editing has been disabled');
}

function showQuickStart() {
  showToast('ğŸš€ Starting quick demo...');
  // Add demo companies
  companies.push(
    {name: "Demo Corp", sector: "Technology", sad: null, neutral: null, happy: null},
    {name: "Test Inc", sector: "Finance", sad: null, neutral: null, happy: null}
  );
  renderTable();
  closeGuideModal();
}

// Initialize on DOM loaded
document.addEventListener('DOMContentLoaded', function() {
  // Event listeners
  document.getElementById('analyzeBtn').addEventListener('click', analyzeAllCompanies);
  document.getElementById('testBtn').addEventListener('click', openTestModal);
  document.getElementById('mylistNameDisplay').addEventListener('click', enableMyListNameEdit);
  document.getElementById('guideBtn').addEventListener('click', () => handleMyListAction('guide'));
  document.getElementById('keywordRefBtn').addEventListener('click', () => handleMyListAction('keyword'));
  document.getElementById('exportBtn').addEventListener('click', () => handleMyListAction('export'));
  document.getElementById('compareBtn').addEventListener('click', () => handleMyListAction('compare'));
  
  // Add tab button
  document.getElementById('addTabBtn').addEventListener('click', openAddTabModal);
  
  // RAG edit options selection
  document.querySelectorAll('.rag-edit-option').forEach(option => {
    option.addEventListener('click', function() {
      document.querySelectorAll('.rag-edit-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
    });
  });
  
  // Color selection for new tab
  document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', function() {
      document.querySelectorAll('.color-option').forEach(opt => opt.style.border = '2px solid transparent');
      this.style.border = '2px solid #667eea';
    });
  });
  
  // Tab switching
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentSector = this.getAttribute('data-sector');
      renderTable();
      
      // Update estimated analysis time for this tab
      if (!analysisInProgress) {
        const totalSeconds = calculateTotalAnalysisTime();
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = Math.round(totalSeconds % 60);
        const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
        document.getElementById('timerDisplay').textContent = `Est: ${timeStr}`;
      }
    });
  });
  
  // Setup tab scrolling
  setupTabScroll();
  
  // Import file change handler - RESTRICTED TO CSV ONLY
  document.getElementById('importFile').addEventListener('change', function(e) {
    if (this.files.length > 0) {
      const file = this.files[0];
      // Check if file is CSV
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showToast('âŒ Only CSV files are allowed for import');
        this.value = '';
        const fileNameDisplay = document.getElementById('selectedFileName');
        fileNameDisplay.textContent = 'No file selected';
        fileNameDisplay.style.color = '#666';
        selectedFile = null;
        return;
      }
      
      selectedFile = file;
      const fileNameDisplay = document.getElementById('selectedFileName');
      fileNameDisplay.textContent = `Selected: ${selectedFile.name} (${(selectedFile.size / 1024).toFixed(1)} KB)`;
      fileNameDisplay.style.color = '#667eea';
    }
  });
  
  // Export option click handlers
  document.querySelectorAll('.export-option').forEach(option => {
    option.addEventListener('click', function() {
      const format = this.getAttribute('data-format');
      selectExportOption(format);
    });
  });
  
  // Import option click handlers - ONLY CSV
  document.querySelectorAll('.import-option').forEach(option => {
    option.addEventListener('click', function() {
      selectImportOption('csv');
    });
  });
  
  // Modal close on outside click
  const modals = ['guideModal', 'keywordModal', 'exportModal', 'compareModal', 
                  'testModal', 'editRagModal', 'addTabModal', 'modalOverlay'];
  
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          const closeFunc = {
            'guideModal': closeGuideModal,
            'keywordModal': closeKeywordModal,
            'exportModal': closeExportModal,
            'compareModal': closeCompareModal,
            'testModal': closeTestModal,
            'editRagModal': closeEditRagModal,
            'addTabModal': closeAddTabModal,
            'modalOverlay': closeModal
          }[modalId];
          closeFunc();
        }
      });
    }
  });
  
  // Calculate and show initial estimated time
  const totalSeconds = calculateTotalAnalysisTime();
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = Math.round(totalSeconds % 60);
  const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
  document.getElementById('timerDisplay').textContent = `Est: ${timeStr}`;
  setTimeout(() => {
    if (!analysisInProgress) {
      document.getElementById('timerDisplay').textContent = 'Ready';
    }
  }, 3000);
  
  // Initial render
  renderTable();
});
</script>
</body>

{% endblock %}