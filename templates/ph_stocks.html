{% extends "base.html" %} {% block title %}Philippine Stocks | Financial
Dashboard{% endblock %} {% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/ph_style.css') }}">

<div class="stocks-dashboard">
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1 class="dashboard-title">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="icon"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
            clip-rule="evenodd"
          />
        </svg>
        Philippine Stock Market
      </h1>
      <p class="dashboard-subtitle">
        Real-time market data and analytics for PSE-listed companies
      </p>
    </div>
    <div class="market-summary">
      <div class="summary-item">
        <span class="summary-label">PSEi Index</span>
        <span class="summary-value positive">6,842.15</span>
        <span class="summary-change positive">+1.25%</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">All Shares</span>
        <span class="summary-value">3,521.76</span>
        <span class="summary-change positive">+0.89%</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Advancers</span>
        <span class="summary-value positive">112</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Decliners</span>
        <span class="summary-value negative">78</span>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="control-panel">
    <form method="POST" action="/ph_stocks" id="stock-filter-form">
        <div class="search-container">
            <div class="search-box">
                <svg xmlns="http://www.w3.org/2000/svg" class="search-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
                <input type="text" name="stock_symbols" id="stock-search" 
                       placeholder="Search stocks (e.g. JFC, BDO, ALI)" 
                       value="{{ ','.join(symbols) if symbols else '' }}" 
                       autocomplete="off" />
                <div class="search-results" id="search-results"></div>
            </div>
            <button type="submit" class="search-btn" id="search-stocks">
                <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
                Search
            </button>
        </div>

        <div class="filter-group">
            <div class="filter-dropdown">
                <label for="sector-filter">Sector</label>
                <select id="sector-filter" name="sector">
                    <option value="all" {% if current_sector == 'all' %}selected{% endif %}>All Sectors</option>
                    <option value="financial" {% if current_sector == 'financial' %}selected{% endif %}>Financials</option>
                    <option value="industrial" {% if current_sector == 'industrial' %}selected{% endif %}>Industrial</option>
                    <option value="holding" {% if current_sector == 'holding' %}selected{% endif %}>Holding Firms</option>
                    <option value="property" {% if current_sector == 'property' %}selected{% endif %}>Property</option>
                    <option value="services" {% if current_sector == 'services' %}selected{% endif %}>Services</option>
                    <option value="mining" {% if current_sector == 'mining' %}selected{% endif %}>Mining & Oil</option>
                    <option value="sme" {% if current_sector == 'sme' %}selected{% endif %}>SME</option>
                </select>
            </div>

            <div class="filter-dropdown">
                <label for="price-filter">Price Range</label>
                <select id="price-filter" name="price">
                    <option value="all" {% if current_price == 'all' %}selected{% endif %}>Any Price</option>
                    <option value="0-10" {% if current_price == '0-10' %}selected{% endif %}>Under ₱10</option>
                    <option value="10-50" {% if current_price == '10-50' %}selected{% endif %}>₱10 - ₱50</option>
                    <option value="50-100" {% if current_price == '50-100' %}selected{% endif %}>₱50 - ₱100</option>
                    <option value="100-500" {% if current_price == '100-500' %}selected{% endif %}>₱100 - ₱500</option>
                    <option value="500" {% if current_price == '500' %}selected{% endif %}>Over ₱500</option>
                </select>
            </div>

            <div class="filter-dropdown">
                <label for="performance-filter">Performance</label>
                <select id="performance-filter" name="performance">
                    <option value="all" {% if current_performance == 'all' %}selected{% endif %}>All Performances</option>
                    <option value="gainers" {% if current_performance == 'gainers' %}selected{% endif %}>Top Gainers</option>
                    <option value="losers" {% if current_performance == 'losers' %}selected{% endif %}>Top Losers</option>
                    <option value="active" {% if current_performance == 'active' %}selected{% endif %}>Most Active</option>
                </select>
            </div>

            <button type="submit" class="filter-btn" id="apply-filters">
                <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                </svg>
                Apply Filters
            </button>
        </div>
    </form>
</div>

  <!-- Stock Data Grid -->
  <div class="stocks-grid-container">
    <div class="grid-header">
      <div class="grid-title">Philippine Stock Quotes</div>
      <div class="grid-actions">
        <button class="grid-action-btn" id="refresh-data">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="action-icon"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
              clip-rule="evenodd"
            />
          </svg>
          Refresh
        </button>
        <button class="grid-action-btn" id="export-data">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="action-icon"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
              clip-rule="evenodd"
            />
          </svg>
          Export
        </button>
      </div>
    </div>

    {% if stocks_data %}
    <div class="stocks-grid">
      <div class="grid-row header-row">
        <div class="grid-cell">Symbol</div>
        <div class="grid-cell">Company</div>
        <div class="grid-cell">Last Price</div>
        <div class="grid-cell">Change</div>
        <div class="grid-cell">% Change</div>
        <div class="grid-cell">Volume</div>
        <div class="grid-cell">Sector</div>
        <div class="grid-cell">Actions</div>
      </div>

      {% for stock in stocks_data %}
      <div
        class="grid-row"
        data-symbol="{{ stock.symbol }}"
        data-sector="{{ stock.sector|lower if stock.sector else '' }}"
        data-price="{{ stock.last_price }}"
      >
        <div class="grid-cell symbol-cell">
          <span class="symbol">{{ stock.symbol }}</span>
        </div>
        <div class="grid-cell company-cell">
          <div class="company-name">{{ stock.name }}</div>
          <div class="company-sector">
            {{ stock.sector if stock.sector else 'N/A' }}
          </div>
        </div>
        <div class="grid-cell price-cell">₱{{ stock.last_price }}</div>
        <div
          class="grid-cell change-cell {{ 'positive' if '-' not in stock.change else 'negative' }}"
        >
          {{ stock.change }}
        </div>
        <div
          class="grid-cell pchange-cell {{ 'positive' if '-' not in stock.change_pct else 'negative' }}"
        >
          {{ stock.change_pct }}
        </div>
        <div class="grid-cell volume-cell">{{ stock.volume }}</div>
        <div class="grid-cell sector-cell">
          {{ stock.sector if stock.sector else 'N/A' }}
        </div>
        <div class="grid-cell action-cell">
          <button class="action-btn view-btn" data-symbol="{{ stock.symbol }}">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="action-icon"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
              <path
                fill-rule="evenodd"
                d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                clip-rule="evenodd"
              />
            </svg>
            Details
          </button>
          <button
            class="action-btn watchlist-btn"
            data-symbol="{{ stock.symbol }}"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="action-icon"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="no-results">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="no-results-icon"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          fill-rule="evenodd"
          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
          clip-rule="evenodd"
        />
      </svg>
      <h4>No stock data available</h4>
      <p>Please try a different search or check back later.</p>
    </div>
    {% endif %}
  </div>

  <!-- Stock Details Modal -->
  <div id="stockModal" class="modal">
    <div class="modal-overlay" onclick="closeStockModal()"></div>
    <div class="modal-content">
      <button class="modal-close" onclick="closeStockModal()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"
          />
        </svg>
      </button>

      <div class="modal-header">
        <div class="stock-header">
          <div class="stock-title">
            <h3 id="modal-stock-symbol">JFC</h3>
            <h2 id="modal-stock-name">Jollibee Foods Corporation</h2>
          </div>
          <div class="stock-price">
            <div class="current-price" id="modal-stock-price">₱245.00</div>
            <div class="price-change positive" id="modal-stock-change">
              +5.00 (+2.08%)
            </div>
          </div>
        </div>

        <div class="stock-meta">
          <div class="meta-item">
            <span class="meta-label">Sector</span>
            <span class="meta-value" id="modal-stock-sector"
              >Consumer Cyclical</span
            >
          </div>
          <div class="meta-item">
            <span class="meta-label">Industry</span>
            <span class="meta-value" id="modal-stock-industry"
              >Restaurants</span
            >
          </div>
          <div class="meta-item">
            <span class="meta-label">Market Cap</span>
            <span class="meta-value" id="modal-stock-marketcap">₱273.4B</span>
          </div>
        </div>
      </div>

      <div class="modal-body">
        <div class="modal-tabs">
          <button class="tab-btn active" data-tab="chart">Chart</button>
          <button class="tab-btn" data-tab="overview">Overview</button>
          <button class="tab-btn" data-tab="financials">Financials</button>
          <button class="tab-btn" data-tab="news">News</button>
        </div>

        <div class="tab-content active" id="chart-tab">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">Price Performance</div>
              <div class="chart-periods">
                <button class="period-btn active" data-period="1d">1D</button>
                <button class="period-btn" data-period="5d">5D</button>
                <button class="period-btn" data-period="1m">1M</button>
                <button class="period-btn" data-period="6m">6M</button>
                <button class="period-btn" data-period="ytd">YTD</button>
                <button class="period-btn" data-period="1y">1Y</button>
                <button class="period-btn" data-period="5y">5Y</button>
                <button class="period-btn" data-period="max">Max</button>
              </div>
            </div>
            <div class="chart-wrapper">
              <canvas id="stockChart"></canvas>
            </div>
          </div>

          <div class="chart-metrics">
            <div class="metric-card">
              <div class="metric-label">Open</div>
              <div class="metric-value" id="metric-open">₱240.00</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">High</div>
              <div class="metric-value" id="metric-high">₱246.50</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Low</div>
              <div class="metric-value" id="metric-low">₱239.00</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Volume</div>
              <div class="metric-value" id="metric-volume">1,245,678</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">52W High</div>
              <div class="metric-value" id="metric-52high">₱258.00</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">52W Low</div>
              <div class="metric-value" id="metric-52low">₱180.50</div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="overview-tab">
          <div class="overview-section">
            <h4>Company Description</h4>
            <p id="company-description">
              Jollibee Foods Corporation is the largest fast food chain in the
              Philippines, operating a network of more than 1,400 stores
              globally. The company is engaged in the development, operation,
              and franchising of quick-service restaurants under the trade names
              Jollibee, Chowking, Greenwich, Red Ribbon, Mang Inasal, and Burger
              King. Jollibee has a strong presence in the Philippines and has
              been expanding internationally, particularly in North America, the
              Middle East, and Asia.
            </p>
          </div>

          <div class="overview-section">
            <h4>Key Executives</h4>
            <div class="executives-grid">
              <div class="executive-card">
                <div class="executive-name">Tony Tan Caktiong</div>
                <div class="executive-title">Founder & Chairman</div>
              </div>
              <div class="executive-card">
                <div class="executive-name">Ernesto Tanmantiong</div>
                <div class="executive-title">CEO</div>
              </div>
              <div class="executive-card">
                <div class="executive-name">Ysmael Baysa</div>
                <div class="executive-title">CFO</div>
              </div>
            </div>
          </div>

          <div class="overview-section">
            <h4>Recent Developments</h4>
            <ul class="developments-list">
              <li>Expanded to Canada with 5 new stores in 2022</li>
              <li>Acquired Coffee Bean & Tea Leaf Philippines in 2021</li>
              <li>Launched new plant-based menu options</li>
              <li>
                Announced plan to open 500 stores in North America by 2028
              </li>
            </ul>
          </div>
        </div>

        <div class="tab-content" id="financials-tab">
          <div class="financials-section">
            <h4>Income Statement (Annual)</h4>
            <div class="financials-table">
              <div class="financials-row header">
                <div class="financials-cell">Metric</div>
                <div class="financials-cell">2022</div>
                <div class="financials-cell">2021</div>
                <div class="financials-cell">2020</div>
              </div>
              <div class="financials-row">
                <div class="financials-cell">Revenue</div>
                <div class="financials-cell">₱179.2B</div>
                <div class="financials-cell">₱148.7B</div>
                <div class="financials-cell">₱129.5B</div>
              </div>
              <div class="financials-row">
                <div class="financials-cell">Gross Profit</div>
                <div class="financials-cell">₱62.5B</div>
                <div class="financials-cell">₱51.3B</div>
                <div class="financials-cell">₱44.8B</div>
              </div>
              <div class="financials-row">
                <div class="financials-cell">Operating Income</div>
                <div class="financials-cell">₱18.2B</div>
                <div class="financials-cell">₱12.7B</div>
                <div class="financials-cell">₱8.5B</div>
              </div>
              <div class="financials-row">
                <div class="financials-cell">Net Income</div>
                <div class="financials-cell">₱12.4B</div>
                <div class="financials-cell">₱8.9B</div>
                <div class="financials-cell">₱5.2B</div>
              </div>
              <div class="financials-row">
                <div class="financials-cell">EPS</div>
                <div class="financials-cell">₱11.25</div>
                <div class="financials-cell">₱8.05</div>
                <div class="financials-cell">₱4.72</div>
              </div>
            </div>
          </div>

          <div class="financials-section">
            <h4>Key Ratios</h4>
            <div class="ratios-grid">
              <div class="ratio-card">
                <div class="ratio-label">P/E Ratio</div>
                <div class="ratio-value">21.8</div>
              </div>
              <div class="ratio-card">
                <div class="ratio-label">P/B Ratio</div>
                <div class="ratio-value">4.2</div>
              </div>
              <div class="ratio-card">
                <div class="ratio-label">Debt/Equity</div>
                <div class="ratio-value">0.85</div>
              </div>
              <div class="ratio-card">
                <div class="ratio-label">ROE</div>
                <div class="ratio-value">19.3%</div>
              </div>
              <div class="ratio-card">
                <div class="ratio-label">Dividend Yield</div>
                <div class="ratio-value">0.8%</div>
              </div>
              <div class="ratio-card">
                <div class="ratio-label">Current Ratio</div>
                <div class="ratio-value">1.2</div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="news-tab">
          <div class="news-list">
            <div class="news-item">
              <div class="news-date">May 15, 2023</div>
              <h4 class="news-title">
                Jollibee reports 39% profit growth in Q1 2023
              </h4>
              <p class="news-excerpt">
                Jollibee Foods Corp. reported a 39% increase in net income to
                ₱3.5 billion in the first quarter, driven by strong sales growth
                in its Philippine and international operations.
              </p>
              <a href="#" class="news-link">Read more</a>
            </div>
            <div class="news-item">
              <div class="news-date">April 28, 2023</div>
              <h4 class="news-title">
                Jollibee to open 100 stores in North America this year
              </h4>
              <p class="news-excerpt">
                Jollibee plans to accelerate its North American expansion with
                100 new stores this year, focusing on markets with large
                Filipino communities.
              </p>
              <a href="#" class="news-link">Read more</a>
            </div>
            <div class="news-item">
              <div class="news-date">March 10, 2023</div>
              <h4 class="news-title">
                Jollibee launches sustainability initiative
              </h4>
              <p class="news-excerpt">
                The fast-food giant announced a comprehensive sustainability
                program aiming to reduce carbon emissions by 25% by 2025.
              </p>
              <a href="#" class="news-link">Read more</a>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="modal-btn secondary-btn" onclick="closeStockModal()">
          Close
        </button>
        <button class="modal-btn primary-btn" id="add-to-watchlist">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="btn-icon"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
              clip-rule="evenodd"
            />
          </svg>
          Add to Watchlist
        </button>
      </div>
    </div>
  </div>

  <!-- Include Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Initialize variables
      let stockChart = null;

      // Search functionality
      const searchInput = document.getElementById("stock-search");
      const searchResults = document.getElementById("search-results");

      // Search input event listener
      searchInput.addEventListener("input", function () {
        const query = this.value.trim().toUpperCase();
        searchResults.innerHTML = "";

        if (query.length < 1) {
          // Show all rows if search is empty
          document
            .querySelectorAll(".stocks-grid .grid-row:not(.header-row)")
            .forEach((row) => {
              row.style.display = "";
            });
          return;
        }

        // Get unique symbols from the table
        const symbols = [
          ...new Set(
            Array.from(
              document.querySelectorAll(
                ".stocks-grid .grid-row:not(.header-row)"
              )
            ).map((row) => row.dataset.symbol)
          ),
        ];

        // Filter matching symbols
        const matches = symbols
          .filter((symbol) => symbol.includes(query))
          .slice(0, 5); // Limit to 5 results

        // Display results
        if (matches.length > 0) {
          matches.forEach((symbol) => {
            const resultItem = document.createElement("div");
            resultItem.className = "search-result-item";
            resultItem.textContent = symbol;
            resultItem.addEventListener("click", function () {
              searchInput.value = symbol;
              searchResults.innerHTML = "";
              filterTableBySymbol(symbol); // Filter table instead of showing modal
            });
            searchResults.appendChild(resultItem);
          });
          searchResults.style.display = "block";
        } else {
          searchResults.style.display = "none";
        }
      });

      // Enter key event listener for search
      searchInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          const query = this.value.trim().toUpperCase();
          if (query.length > 0) {
            filterTableBySymbol(query);
            searchResults.style.display = "none";
          }
        }
      });

      // Search button click handler
      document
        .getElementById("search-stocks")
        .addEventListener("click", function () {
          const query = searchInput.value.trim().toUpperCase();
          if (query.length > 0) {
            filterTableBySymbol(query);
            searchResults.style.display = "none";
          }
        });

      // Function to filter table by symbol
      function filterTableBySymbol(symbol) {
        const allRows = document.querySelectorAll(
          ".stocks-grid .grid-row:not(.header-row)"
        );
        let found = false;

        allRows.forEach((row) => {
          if (row.dataset.symbol === symbol) {
            row.style.display = "";
            found = true;
          } else {
            row.style.display = "none";
          }
        });

        if (!found) {
          alert("Stock symbol not found. Please try another symbol.");
          // Show all rows if not found
          allRows.forEach((row) => {
            row.style.display = "";
          });
        }
      }

      // Close search results when clicking outside
      document.addEventListener("click", function (e) {
        if (!searchInput.contains(e.target)) {
          searchResults.style.display = "none";
        }
      });

      // Apply filters when button is clicked
      document
        .getElementById("apply-filters")
        .addEventListener("click", function(e) {
          e.preventDefault();
          applyFilters();
        });

      // View stock details (modal) - only for detail button clicks
      document.querySelectorAll(".view-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const symbol = this.dataset.symbol;
          viewStockDetails(symbol);
        });
      });

      // Tab switching in modal
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const tabId = this.dataset.tab;
          switchTab(tabId);
        });
      });

      // Chart period buttons
      document.querySelectorAll(".period-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const period = this.dataset.period;
          updateChartPeriod(period);
        });
      });

      // Add to watchlist button
      document
        .getElementById("add-to-watchlist")
        .addEventListener("click", function () {
          const symbol = this.dataset.symbol;
          addToWatchlist(symbol);
        });

      // Refresh data button
      document
        .getElementById("refresh-data")
        .addEventListener("click", function () {
          location.reload();
        });

      // Initialize filters on page load
      initializeFilters();
    });

    // Initialize filters with current values from server
    function initializeFilters() {
      // Get filter elements
      const sectorFilter = document.getElementById("sector-filter");
      const priceFilter = document.getElementById("price-filter");
      const performanceFilter = document.getElementById("performance-filter");
      
      // Apply initial filters if values are set
      if (sectorFilter.value !== "all" || priceFilter.value !== "all" || performanceFilter.value !== "all") {
        applyFilters();
      }
    }

    // Function to apply filters
    function applyFilters() {
      const sectorFilter = document.getElementById("sector-filter").value;
      const priceFilter = document.getElementById("price-filter").value;
      const performanceFilter = document.getElementById("performance-filter").value;
      const searchQuery = document.getElementById("stock-search").value.trim().toLowerCase();

      const allRows = Array.from(
        document.querySelectorAll(".stocks-grid .grid-row:not(.header-row)")
      );

      allRows.forEach((row) => {
        const rowSector = row.dataset.sector ? row.dataset.sector.toLowerCase() : '';
        const rowPrice = parseFloat(row.dataset.price) || 0;
        const rowSymbol = row.dataset.symbol.toLowerCase();
        const rowChange = row.querySelector(".pchange-cell").textContent;
        const rowVolume = parseFloat(row.querySelector(".volume-cell").textContent.replace(/,/g, '')) || 0;

        // Filter by sector
        const sectorMatch = 
          sectorFilter === "all" || 
          (rowSector && rowSector.includes(sectorFilter.toLowerCase()));

        // Filter by price range
        let priceMatch = true;
        if (priceFilter !== "all") {
          if (priceFilter === "0-10") {
            priceMatch = rowPrice >= 0 && rowPrice <= 10;
          } else if (priceFilter === "10-50") {
            priceMatch = rowPrice >= 10 && rowPrice <= 50;
          } else if (priceFilter === "50-100") {
            priceMatch = rowPrice >= 50 && rowPrice <= 100;
          } else if (priceFilter === "100-500") {
            priceMatch = rowPrice >= 100 && rowPrice <= 500;
          } else if (priceFilter === "500") {
            priceMatch = rowPrice >= 500;
          }
        }

        // Filter by performance
        let performanceMatch = true;
        if (performanceFilter === "gainers") {
          performanceMatch = !rowChange.startsWith('-');
        } else if (performanceFilter === "losers") {
          performanceMatch = rowChange.startsWith('-');
        } else if (performanceFilter === "active") {
          performanceMatch = rowVolume > 5000000; // Threshold for "active"
        } else if (performanceFilter === "volume") {
          // For "Highest Volume" we'll need to sort, handled separately
          performanceMatch = true;
        }

        // Filter by search query
        const searchMatch = 
          searchQuery === "" || 
          rowSymbol.includes(searchQuery) || 
          row.querySelector(".company-name").textContent.toLowerCase().includes(searchQuery);

        // Show/hide row based on filters
        if (sectorMatch && priceMatch && performanceMatch && searchMatch) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });

      // Special handling for "Highest Volume" filter
      if (performanceFilter === "volume") {
        sortByVolume();
      }
    }

    // Function to sort by volume (for Highest Volume filter)
    function sortByVolume() {
      const grid = document.querySelector(".stocks-grid");
      const rows = Array.from(document.querySelectorAll(".grid-row:not(.header-row)"));
      
      // Filter out hidden rows
      const visibleRows = rows.filter(row => row.style.display !== "none");
      
      // Sort by volume (descending)
      visibleRows.sort((a, b) => {
        const volumeA = parseFloat(a.querySelector(".volume-cell").textContent.replace(/,/g, '')) || 0;
        const volumeB = parseFloat(b.querySelector(".volume-cell").textContent.replace(/,/g, '')) || 0;
        return volumeB - volumeA;
      });
      
      // Reattach sorted rows
      const headerRow = document.querySelector(".grid-row.header-row");
      grid.insertBefore(headerRow, grid.firstChild);
      
      visibleRows.forEach(row => {
        grid.appendChild(row);
      });
    }

    // Function to view stock details (modal)
    function viewStockDetails(symbol) {
      // Find the row with the matching symbol
      const stockRow = document.querySelector(`.grid-row[data-symbol="${symbol}"]`);

      if (!stockRow) {
        alert("Stock details not available for this symbol.");
        return;
      }

      // Extract data from the row
      const stockData = {
        symbol: symbol,
        name: stockRow.querySelector(".company-name").textContent,
        price: stockRow.querySelector(".price-cell").textContent.replace("₱", ""),
        change: stockRow.querySelector(".change-cell").textContent,
        change_pct: stockRow.querySelector(".pchange-cell").textContent,
        sector: stockRow.querySelector(".company-sector").textContent,
        industry: stockRow.dataset.sector || "N/A",
        volume: stockRow.querySelector(".volume-cell").textContent,
        marketCap: "₱" + (Math.random() * 1000).toFixed(2) + "B",
        open: (
          parseFloat(
            stockRow.querySelector(".price-cell").textContent.replace("₱", "")
          ) -
          Math.random() * 5
        ).toFixed(2),
        high: (
          parseFloat(
            stockRow.querySelector(".price-cell").textContent.replace("₱", "")
          ) +
          Math.random() * 2
        ).toFixed(2),
        low: (
          parseFloat(
            stockRow.querySelector(".price-cell").textContent.replace("₱", "")
          ) -
          Math.random() * 3
        ).toFixed(2),
        yearHigh: (
          parseFloat(
            stockRow.querySelector(".price-cell").textContent.replace("₱", "")
          ) * 1.2
        ).toFixed(2),
        yearLow: (
          parseFloat(
            stockRow.querySelector(".price-cell").textContent.replace("₱", "")
          ) * 0.8
        ).toFixed(2),
        description: `This is a sample description for ${
          stockRow.querySelector(".company-name").textContent
        }. In a real application, this would come from your backend API.`,
      };

      // Update modal with stock data
      document.getElementById("modal-stock-symbol").textContent = stockData.symbol;
      document.getElementById("modal-stock-name").textContent = stockData.name;
      document.getElementById("modal-stock-price").textContent = `₱${stockData.price}`;
      document.getElementById("modal-stock-change").textContent = `${stockData.change} (${stockData.change_pct})`;
      document.getElementById("modal-stock-sector").textContent = stockData.sector;
      document.getElementById("modal-stock-industry").textContent = stockData.industry;
      document.getElementById("modal-stock-marketcap").textContent = stockData.marketCap;
      document.getElementById("metric-open").textContent = `₱${stockData.open}`;
      document.getElementById("metric-high").textContent = `₱${stockData.high}`;
      document.getElementById("metric-low").textContent = `₱${stockData.low}`;
      document.getElementById("metric-volume").textContent = stockData.volume;
      document.getElementById("metric-52high").textContent = `₱${stockData.yearHigh}`;
      document.getElementById("metric-52low").textContent = `₱${stockData.yearLow}`;
      document.getElementById("company-description").textContent = stockData.description;

      // Set the color for change
      const changeElement = document.getElementById("modal-stock-change");
      if (stockData.change.startsWith("-")) {
        changeElement.classList.remove("positive");
        changeElement.classList.add("negative");
      } else {
        changeElement.classList.remove("negative");
        changeElement.classList.add("positive");
      }

      // Set the add to watchlist button
      document.getElementById("add-to-watchlist").dataset.symbol = symbol;

      // Show modal
      document.getElementById("stockModal").style.display = "flex";
      document.body.style.overflow = "hidden";

      // Initialize chart
      initializeChart();
    }

    // Function to close stock modal
    function closeStockModal() {
      document.getElementById("stockModal").style.display = "none";
      document.body.style.overflow = "auto";
    }

    // Function to switch tabs in modal
    function switchTab(tabId) {
      // Hide all tab contents
      document.querySelectorAll(".tab-content").forEach((tab) => {
        tab.classList.remove("active");
      });

      // Deactivate all tab buttons
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.classList.remove("active");
      });

      // Activate selected tab
      document.getElementById(`${tabId}-tab`).classList.add("active");
      document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add("active");
    }

    // Function to initialize chart
    function initializeChart() {
      const ctx = document.getElementById("stockChart").getContext("2d");

      // Destroy previous chart if it exists
      if (window.stockChart) {
        window.stockChart.destroy();
      }

      // Sample data - in a real app, you would fetch this from your backend
      const labels = Array.from({ length: 30 }, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (29 - i));
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
      });

      const prices = Array.from({ length: 30 }, (_, i) => {
        const basePrice = 200 + Math.random() * 50;
        return basePrice + Math.sin(i / 2) * 10 + (Math.random() - 0.5) * 5;
      });

      window.stockChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Stock Price",
              data: prices,
              borderColor: "#3B82F6",
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              mode: "index",
              intersect: false,
              callbacks: {
                label: function (context) {
                  return `Price: ₱${context.parsed.y.toFixed(2)}`;
                },
              },
            },
          },
          scales: {
            x: {
              grid: {
                display: false,
              },
            },
            y: {
              ticks: {
                callback: function (value) {
                  return "₱" + value;
                },
              },
            },
          },
          interaction: {
            mode: "nearest",
            axis: "x",
            intersect: false,
          },
        },
      });
    }

    // Function to update chart period
    function updateChartPeriod(period) {
      // Deactivate all period buttons
      document.querySelectorAll(".period-btn").forEach((btn) => {
        btn.classList.remove("active");
      });

      // Activate selected period
      document.querySelector(`.period-btn[data-period="${period}"]`).classList.add("active");

      // In a real app, you would fetch new data for this period
      console.log(`Updating chart for period: ${period}`);

      // Here you would update the chart with new data
      // For now, we'll just regenerate with random data
      if (window.stockChart) {
        window.stockChart.destroy();
        initializeChart();
      }
    }

    // Function to add stock to watchlist
    function addToWatchlist(symbol) {
      // In a real app, you would save this to your backend
      alert(`Added ${symbol} to your watchlist!`);

      // Close the modal
      closeStockModal();
    }
</script>
  
  {% endblock %}
</div>
