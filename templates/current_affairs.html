{% extends "base.html" %} {% block title %} Current Affairs {% endblock %} {%
block content %}

<style>
  .timer-display-wrapper {
    min-width: 60px;
    text-align: center;
    background-color: #f8f9fa;
  }

  .timer-display {
    font-family: monospace;
    font-weight: bold;
    color: #495057;
    padding: 2px 0;
  }
</style>

<div class="container mt-4">
  <!-- Mini Tab Navigation (Top Right) -->
  <ul
    class="nav nav-pills nav-fill bg-light rounded p-2 shadow-sm"
    id="newsTabs"
  >
    <li class="nav-item">
      <a class="nav-link active" data-tab="all" href="#all">World</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-tab="north_america" href="#north_america"
        >North America</a
      >
    </li>
    <li class="nav-item">
      <a class="nav-link" data-tab="south_america" href="#south_america"
        >South America</a
      >
    </li>
    <li class="nav-item">
      <a class="nav-link" data-tab="europe" href="#europe">Europe</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-tab="asia" href="#asia">Asia</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-tab="africa" href="#africa">Africa</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-tab="australia" href="#australia">Australia</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-tab="mena" href="#mena">MENA</a>
    </li>
  </ul>

  <!-- Toggle Button for Search Panel and Timer Controls -->
  <div
    class="d-flex align-items-center mt-3 {% if news_data %} visible {% else %} d-none {% endif %}"
  >
    <button id="toggleSearch" class="btn btn-sm btn-outline-primary">
      <i class="bi bi-arrow-right-circle"></i> Show Search
    </button>

    <!-- Timer Container with added spacing -->
    <div class="timer-container ms-3 d-flex align-items-center">
      <button id="timerToggle" class="btn btn-sm btn-success timer-btn">
        <i class="bi bi-play-fill"></i>
      </button>

      <!-- Wrapped timer display with border and padding -->
      <div class="timer-display-wrapper border rounded px-2 mx-1">
        <span id="countdownDisplay" class="timer-display">--:--</span>
      </div>

      <button
        id="timerReset"
        class="btn btn-sm btn-outline-secondary timer-btn"
      >
        <i class="bi bi-arrow-counterclockwise"></i>
      </button>
    </div>
  </div>
  <!-- Two-Column Layout -->
  <div class="row mt-4">
    <!-- Left Column: Input Fields (Hidden after submitting) -->
    <div
      class="col-md-4"
      id="leftColumn"
      {%
      if
      news_data
      %}
      style="display: none"
      {%
      endif
      %}
    >
      <div class="card shadow-sm p-3" id="urlFormCard">
        <h6 class="text-center text-primary">Web URLs by Region</h6>
        <form method="POST" id="urlForm">
          <!-- Region-specific URL inputs -->
          <div class="accordion" id="regionAccordion">
            <!-- World -->
            <div class="accordion-item region-tab" data-region="world">
              <h2 class="accordion-header">
                <button
                  class="accordion-button"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseWorld"
                >
                  World
                </button>
              </h2>
              <div
                id="collapseWorld"
                class="accordion-collapse collapse show"
                data-bs-parent="#regionAccordion"
              >
                <div class="accordion-body">
                  <div id="worldContainer" class="source-container">
                    {% for i in range(1, 5) %}
                    <div class="input-group mb-2 source-field">
                      <span class="input-group-text">#{{ i }}</span>
                      <input
                        type="text"
                        name="world_urls"
                        class="form-control"
                        placeholder="Enter URL"
                        value="{{ urls.world[i-1] if urls.world and i <= urls.world|length else '' }}"
                        data-source-order="{{ i }}"
                      />
                    </div>
                    {% endfor %}
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm w-100 mb-2 add-source-btn"
                    data-region="world"
                  >
                    <i class="bi bi-plus-circle"></i> Add Source
                  </button>
                </div>
              </div>
            </div>

            <!-- North America -->
            <div class="accordion-item region-tab" data-region="north_america">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseNorthAmerica"
                >
                  North America
                </button>
              </h2>
              <div
                id="collapseNorthAmerica"
                class="accordion-collapse collapse"
                data-bs-parent="#regionAccordion"
              >
                <div class="accordion-body">
                  <div id="north_americaContainer" class="source-container">
                    {% for i in range(1, 5) %}
                    <div class="input-group mb-2 source-field">
                      <span class="input-group-text">#{{ i }}</span>
                      <input
                        type="text"
                        name="north_america_urls"
                        class="form-control"
                        placeholder="Enter URL"
                        value="{{ urls.north_america[i-1] if urls.north_america and i <= urls.north_america|length else '' }}"
                        data-source-order="{{ i }}"
                      />
                    </div>
                    {% endfor %}
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm w-100 mb-2 add-source-btn"
                    data-region="north_america"
                  >
                    <i class="bi bi-plus-circle"></i> Add Source
                  </button>
                </div>
              </div>
            </div>

            <!-- South America -->
            <div class="accordion-item region-tab" data-region="south_america">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseSouthAmerica"
                >
                  South America
                </button>
              </h2>
              <div
                id="collapseSouthAmerica"
                class="accordion-collapse collapse"
                data-bs-parent="#regionAccordion"
              >
                <div class="accordion-body">
                  <div id="south_americaContainer" class="source-container">
                    {% for i in range(1, 5) %}
                    <div class="input-group mb-2 source-field">
                      <span class="input-group-text">#{{ i }}</span>
                      <input
                        type="text"
                        name="south_america_urls"
                        class="form-control"
                        placeholder="Enter URL"
                        value="{{ urls.south_america[i-1] if urls.south_america and i <= urls.south_america|length else '' }}"
                        data-source-order="{{ i }}"
                      />
                    </div>
                    {% endfor %}
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm w-100 mb-2 add-source-btn"
                    data-region="south_america"
                  >
                    <i class="bi bi-plus-circle"></i> Add Source
                  </button>
                </div>
              </div>
            </div>

            <!-- Europe -->
            <div class="accordion-item region-tab" data-region="europe">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseEurope"
                >
                  Europe
                </button>
              </h2>
              <div
                id="collapseEurope"
                class="accordion-collapse collapse"
                data-bs-parent="#regionAccordion"
              >
                <div class="accordion-body">
                  <div id="europeContainer" class="source-container">
                    {% for i in range(1, 5) %}
                    <div class="input-group mb-2 source-field">
                      <span class="input-group-text">#{{ i }}</span>
                      <input
                        type="text"
                        name="europe_urls"
                        class="form-control"
                        placeholder="Enter URL"
                        value="{{ urls.europe[i-1] if urls.europe and i <= urls.europe|length else '' }}"
                        data-source-order="{{ i }}"
                      />
                    </div>
                    {% endfor %}
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm w-100 mb-2 add-source-btn"
                    data-region="europe"
                  >
                    <i class="bi bi-plus-circle"></i> Add Source
                  </button>
                </div>
              </div>
            </div>

            <!-- Asia -->
            <div class="accordion-item region-tab" data-region="asia">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseAsia"
                >
                  Asia
                </button>
              </h2>
              <div
                id="collapseAsia"
                class="accordion-collapse collapse"
                data-bs-parent="#regionAccordion"
              >
                <div class="accordion-body">
                  <div id="asiaContainer" class="source-container">
                    {% for i in range(1, 5) %}
                    <div class="input-group mb-2 source-field">
                      <span class="input-group-text">#{{ i }}</span>
                      <input
                        type="text"
                        name="asia_urls"
                        class="form-control"
                        placeholder="Enter URL"
                        value="{{ urls.asia[i-1] if urls.asia and i <= urls.asia|length else '' }}"
                        data-source-order="{{ i }}"
                      />
                    </div>
                    {% endfor %}
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm w-100 mb-2 add-source-btn"
                    data-region="asia"
                  >
                    <i class="bi bi-plus-circle"></i> Add Source
                  </button>
                </div>
              </div>
            </div>

            <!-- Africa -->
            <div class="accordion-item region-tab" data-region="africa">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseAfrica"
                >
                  Africa
                </button>
              </h2>
              <div
                id="collapseAfrica"
                class="accordion-collapse collapse"
                data-bs-parent="#regionAccordion"
              >
                <div class="accordion-body">
                  <div id="africaContainer" class="source-container">
                    {% for i in range(1, 5) %}
                    <div class="input-group mb-2 source-field">
                      <span class="input-group-text">#{{ i }}</span>
                      <input
                        type="text"
                        name="africa_urls"
                        class="form-control"
                        placeholder="Enter URL"
                        value="{{ urls.africa[i-1] if urls.africa and i <= urls.africa|length else '' }}"
                        data-source-order="{{ i }}"
                      />
                    </div>
                    {% endfor %}
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm w-100 mb-2 add-source-btn"
                    data-region="africa"
                  >
                    <i class="bi bi-plus-circle"></i> Add Source
                  </button>
                </div>
              </div>
            </div>

            <!-- Australia -->
            <div class="accordion-item region-tab" data-region="australia">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseAustralia"
                >
                  Australia
                </button>
              </h2>
              <div
                id="collapseAustralia"
                class="accordion-collapse collapse"
                data-bs-parent="#regionAccordion"
              >
                <div class="accordion-body">
                  <div id="australiaContainer" class="source-container">
                    {% for i in range(1, 5) %}
                    <div class="input-group mb-2 source-field">
                      <span class="input-group-text">#{{ i }}</span>
                      <input
                        type="text"
                        name="australia_urls"
                        class="form-control"
                        placeholder="Enter URL"
                        value="{{ urls.australia[i-1] if urls.australia and i <= urls.australia|length else '' }}"
                        data-source-order="{{ i }}"
                      />
                    </div>
                    {% endfor %}
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm w-100 mb-2 add-source-btn"
                    data-region="australia"
                  >
                    <i class="bi bi-plus-circle"></i> Add Source
                  </button>
                </div>
              </div>
            </div>

            <!-- MENA -->
            <div class="accordion-item region-tab" data-region="mena">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseMENA"
                >
                  MENA
                </button>
              </h2>
              <div
                id="collapseMENA"
                class="accordion-collapse collapse"
                data-bs-parent="#regionAccordion"
              >
                <div class="accordion-body">
                  <div id="menaContainer" class="source-container">
                    {% for i in range(1, 5) %}
                    <div class="input-group mb-2 source-field">
                      <span class="input-group-text">#{{ i }}</span>
                      <input
                        type="text"
                        name="mena_urls"
                        class="form-control"
                        placeholder="Enter URL"
                        value="{{ urls.mena[i-1] if urls.mena and i <= urls.mena|length else '' }}"
                        data-source-order="{{ i }}"
                      />
                    </div>
                    {% endfor %}
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm w-100 mb-2 add-source-btn"
                    data-region="mena"
                  >
                    <i class="bi bi-plus-circle"></i> Add Source
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Update Frequency Selection -->
          <div
            class="d-flex align-items-center justify-content-between mb-2 mt-3"
          >
            <label class="small mb-0">Update Frequency</label>
            <select
              id="frequencyDropdown"
              class="form-select form-select-sm"
              style="width: 70%"
            >
              <option value="2min">2 Min</option>
              <option value="5min">5 Min</option>
              <option value="10min">10 Min</option>
              <option value="20min">20 Min</option>
              <option value="30min">30 Min</option>
            </select>
          </div>

          <!-- Submit Button (now also starts auto-refresh) -->
          <button
            id="submitSources"
            type="submit"
            class="btn btn-primary btn-sm w-100 mt-2"
          >
            <i class="bi bi-check-lg"></i> Submit and Start Auto-refresh
          </button>

          <!-- Auto-refresh status indicator -->
          <div id="refreshStatus" class="small text-center mt-2 d-none">
            <span class="badge bg-success">
              <i class="bi bi-arrow-repeat"></i>
              Auto-refreshing every <span id="minutesDisplay">2</span> minutes
            </span>
            <div class="progress mt-1" style="height: 4px">
              <div
                id="refreshProgress"
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Right Column: News -->
    <div
      class="col-md-{% if news_data %}12{% else %}8{% endif %}"
      id="newsColumn"
    >
      <div class="card shadow-sm p-3" id="newsCard">
        <h6 class="text-center text-primary">News Feed</h6>

        {% if news_data %}
        <!-- Trending/Top News Section -->
        <div class="trending-news-section" id="trendingNews">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
              <span class="trending-label">Trending</span> Top Stories
            </h5>
          </div>

          <!-- Featured News Items (Top 6 stories) in grid layout -->
          <div class="row">
            {% set seen_titles = [] %} {% for news in news_data %} {% if
            loop.index0 < 5 and news.title not in seen_titles %} {% set _ =
            seen_titles.append(news.title) %}
            <div class="col-md-6 col-xl-4 mb-3">
              <div class="card h-100">
                <div class="row g-0">
                  <div class="col-md-4">
                    <img
                      src="{{ news.image }}"
                      class="img-fluid rounded-start"
                      alt="Featured News"
                      style="height: 100%; object-fit: cover"
                      onerror="this.src='/static/images/default_news.jpg';"
                    />
                  </div>
                  <div class="col-md-8">
                    <div class="card-body">
                      <h5 class="card-title">{{ news.title }}</h5>
                      <p class="card-text small">{{ news.content }}</p>
                      <div class="d-flex justify-content-between">
                        <a
                          href="{{ news.link }}"
                          target="_blank"
                          class="btn btn-sm btn-outline-primary"
                          >Read More</a
                        >
                        <span class="badge bg-secondary"
                          >{{ news.category|capitalize }}</span
                        >
                      </div>
                      <div class="mt-2">
                        <small
                          class="text-muted url-display"
                          data-source-region="{{ news.category }}"
                        >
                          <a
                            href="{{ news.link }}"
                            target="_blank"
                            class="text-muted text-truncate d-inline-block"
                            style="max-width: 200px"
                          >
                            {{ news.link }}
                          </a>
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %} {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Regular News Grid -->
        <div class="row" id="newsItems">
          {% if news_data %} {% set seen_titles = [] %} {% for news in news_data
          %} {% if loop.index0 >= 6 %}
          <!-- Skip the first 6 items as they're shown in the featured section -->
          {% if news.title not in seen_titles %} {% set _ =
          seen_titles.append(news.title) %}
          <div
            class="col-md-6 col-xl-4 mb-3 news-grid-item"
            data-category="{{ news.category }}"
            data-source-url="{{ news.source_url }}"
          >
            <div class="card h-100">
              <div class="row g-0">
                <div class="col-md-4">
                  <img
                    src="{{ news.image }}"
                    class="img-fluid rounded-start"
                    alt="News Image"
                    style="height: 100%; object-fit: cover"
                    onerror="this.src='/static/images/default_news.jpg';"
                  />
                </div>
                <div class="col-md-8">
                  <div class="card-body">
                    <h5 class="card-title">{{ news.title }}</h5>
                    <p class="card-text small">{{ news.content }}</p>
                    <div class="d-flex justify-content-between">
                      <a
                        href="{{ news.link }}"
                        target="_blank"
                        class="btn btn-sm btn-outline-primary"
                        >Read More</a
                      >
                      <span class="badge bg-secondary"
                        >{{ news.category|capitalize }}</span
                      >
                    </div>
                    <div class="mt-2">
                      <small
                        class="text-muted url-display"
                        data-source-region="{{ news.category }}"
                      >
                        <a
                          href="{{ news.link }}"
                          target="_blank"
                          class="text-muted text-truncate d-inline-block"
                          style="max-width: 200px"
                        >
                          {{ news.link }}
                        </a>
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %} {% endif %} {% endfor %} {% else %}
          <div class="col-12 text-center py-5">
            <p>No news data available. Submit the form to fetch news.</p>
            {% if request.method == "POST" and not news_data %}
            <div class="alert alert-warning">
              No news could be fetched from the provided URLs. Please check the
              URLs or try again later.
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let urlForm = document.querySelector("form");
    let leftColumn = document.querySelector("#leftColumn");
    let newsColumn = document.querySelector("#newsColumn");
    let newsItems = document.querySelector("#newsItems");
    let toggleButton = document.querySelector("#toggleSearch");
    let submitButton = document.querySelector("#submitSources");

    // Auto-refresh elements
    const frequencyDropdown = document.getElementById("frequencyDropdown");
    const refreshStatus = document.getElementById("refreshStatus");
    const refreshProgress = document.getElementById("refreshProgress");
    const minutesDisplay = document.getElementById("minutesDisplay");

    // Timer elements
    const timerToggle = document.getElementById("timerToggle");
    const timerReset = document.getElementById("timerReset");
    const countdownDisplay = document.getElementById("countdownDisplay");

    let refreshInterval;
    let progressInterval;
    let countdownInterval;
    let timerIsActive = false;
    let secondsRemaining = 0;
    let lastTimerCheckpoint = Date.now();
    let announcementMade = false;
    let urlSourceOrder = {};

    // Function to add new source field for a specific region
    function addSourceField(region, value = "") {
      const container = document.getElementById(`${region}Container`);
      const existingFields = container.querySelectorAll(".source-field").length;
      const nextNum = existingFields + 1;

      const newField = document.createElement("div");
      newField.className = "input-group mb-2 source-field";
      newField.innerHTML = `
            <span class="input-group-text">#${nextNum}</span>
            <input
              type="text"
              name="${region}_urls"
              class="form-control"
              placeholder="Enter URL"
              value="${value}"
              data-source-order="${nextNum}"
            />
            <button type="button" class="btn btn-outline-danger remove-field">
              <i class="bi bi-x"></i>
            </button>
          `;

      container.appendChild(newField);

      newField
        .querySelector(".remove-field")
        .addEventListener("click", function () {
          newField.remove();
          renumberFields(container);
          saveUrlsToLocalStorage();
        });

      // Add input event listener to save on change
      newField
        .querySelector('input[name^="' + region + '"]')
        .addEventListener("input", saveUrlsToLocalStorage);

      // Add this to your addSourceField function after creating the new field
      function attachURLHandlers(newField) {
        const input = newField.querySelector('input[type="text"]');

        input.addEventListener("paste", function (e) {
          setTimeout(() => {
            let value = this.value;
            if (value) {
              value = value.replace(/^https?:\/\//, "");
              this.value = value;
              saveUrlsToLocalStorage();
            }
          }, 0);
        });

        input.addEventListener("blur", function () {
          let value = this.value;
          if (value && value.match(/^https?:\/\//)) {
            this.value = value.replace(/^https?:\/\//, "");
            saveUrlsToLocalStorage();
          }
        });
      }

      // Attach URL handlers
      attachURLHandlers(newField);
    }

    // Function to activate a tab based on hash
    function activateTabFromHash() {
      const hash = window.location.hash.substring(1); // Remove the #
      if (hash) {
        const tabToActivate = document.querySelector(
          `#newsTabs .nav-link[href="#${hash}"]`
        );
        if (tabToActivate) {
          // Remove active class from all tabs
          document.querySelectorAll("#newsTabs .nav-link").forEach((tab) => {
            tab.classList.remove("active");
          });

          // Add active class to the correct tab
          tabToActivate.classList.add("active");

          // Update the current active category and apply filter
          currentActiveCategory = hash;
          applyCurrentCategoryFilter();

          // Show/hide URL inputs based on active tab
          updateURLInputVisibility(hash);
        }
      }
    }

    // Function to show/hide URL inputs based on active tab
    function updateURLInputVisibility(activeTab) {
      // Show all region tabs if "all" is selected
      if (activeTab === "all") {
        document.querySelectorAll(".region-tab").forEach((tab) => {
          tab.style.display = "block";
        });
      } else {
        // Hide all region tabs first
        document.querySelectorAll(".region-tab").forEach((tab) => {
          if (tab.getAttribute("data-region") === activeTab) {
            tab.style.display = "block";
          } else {
            tab.style.display = "none";
          }
        });
      }

      // Show/hide URL displays in news items
      document.querySelectorAll(".url-display").forEach((urlDisplay) => {
        const region = urlDisplay.getAttribute("data-source-region");
        if (activeTab === "all" || region === activeTab) {
          urlDisplay.style.display = "block";
        } else {
          urlDisplay.style.display = "none";
        }
      });
    }

    // Function to strip protocol from URLs on paste
    function setupURLInputs() {
      // Select all URL input fields
      const urlInputs = document.querySelectorAll('input[name$="_urls"]');

      urlInputs.forEach((input) => {
        // Add paste event listener
        input.addEventListener("paste", function (e) {
          // Let the paste happen normally
          setTimeout(() => {
            // After paste, get the value and remove protocol if present
            let value = this.value;
            if (value) {
              // Strip http:// or https:// from the beginning
              value = value.replace(/^https?:\/\//, "");
              this.value = value;

              // Save the modified URLs to localStorage
              saveUrlsToLocalStorage();
            }
          }, 0);
        });

        // Also handle manual input to catch if someone types a URL with protocol
        input.addEventListener("blur", function () {
          let value = this.value;
          if (value && value.match(/^https?:\/\//)) {
            this.value = value.replace(/^https?:\/\//, "");
            saveUrlsToLocalStorage();
          }
        });
      });
    }

    // Call this function to initialize the URL input handlers
    setupURLInputs();

    // Function to renumber fields after removal for a specific container
    function renumberFields(container) {
      const fields = container.querySelectorAll(".source-field");
      fields.forEach((field, index) => {
        field.querySelector(".input-group-text").textContent = `#${index + 1}`;
        field
          .querySelector('input[type="text"]')
          .setAttribute("data-source-order", index + 1);
      });
    }

    // Store the URL order for sorting news items
    function storeUrlOrder() {
      const regions = [
        "world",
        "north_america",
        "south_america",
        "europe",
        "asia",
        "africa",
        "australia",
        "mena",
      ];

      urlSourceOrder = {};

      regions.forEach((region) => {
        const inputs = document.querySelectorAll(
          `input[name="${region}_urls"]`
        );
        inputs.forEach((input, index) => {
          if (input.value) {
            try {
              const url = new URL(input.value);
              const domain = url.hostname;
              urlSourceOrder[domain] = { region, order: index };
            } catch (e) {
              urlSourceOrder[input.value] = { region, order: index };
            }
          }
        });
      });
    }

    // Sort news items based on source URL order and region
    function sortNewsBySourceOrder() {
      const newsContainer = document.getElementById("newsItems");
      const trendingContainer = document.getElementById("trendingNews");

      if (!newsContainer || !trendingContainer) return;

      // Get and sort all news items (including trending)
      const allNewsItems = Array.from(
        document.querySelectorAll("[data-source-url]")
      );

      allNewsItems.sort((a, b) => {
        const urlA = a.getAttribute("data-source-url");
        const urlB = b.getAttribute("data-source-url");
        const categoryA = a.getAttribute("data-category");
        const categoryB = b.getAttribute("data-category");

        // Extract domains
        let domainA, domainB;
        try {
          domainA = new URL(urlA).hostname;
        } catch (e) {
          domainA = urlA;
        }

        try {
          domainB = new URL(urlB).hostname;
        } catch (e) {
          domainB = urlB;
        }

        // Get order (default to high number if not found)
        const orderA = urlSourceOrder[domainA] || {
          region: categoryA,
          order: 999,
        };
        const orderB = urlSourceOrder[domainB] || {
          region: categoryB,
          order: 999,
        };

        // First sort by region (to match the accordion order)
        const regionOrder = [
          "world",
          "north_america",
          "south_america",
          "europe",
          "asia",
          "africa",
          "australia",
          "mena",
        ];

        const regionIndexA = regionOrder.indexOf(orderA.region);
        const regionIndexB = regionOrder.indexOf(orderB.region);

        if (regionIndexA !== regionIndexB) {
          return regionIndexA - regionIndexB;
        }

        // Then sort by order within the region
        return orderA.order - orderB.order;
      });

      // Get first 6 for trending section
      const topSix = allNewsItems.slice(0, 6);
      const rest = allNewsItems.slice(6);

      // Clear and repopulate trending section
      const trendingContent = document.querySelector("#trendingNews .d-flex");
      if (trendingContent) {
        let trendingParent = trendingContent.parentNode;
        // Keep the heading
        while (trendingParent.childNodes.length > 1) {
          trendingParent.removeChild(trendingParent.lastChild);
        }

        // Add top 6 items
        topSix.forEach((item) => {
          const clone = item.cloneNode(true);
          clone.classList.add("featured-news-card");
          clone.classList.remove(
            "col-md-6",
            "col-xl-4",
            "mb-3",
            "news-grid-item"
          );
          trendingParent.appendChild(clone);
        });
      }

      // Clear and repopulate regular news grid
      newsContainer.innerHTML = "";
      rest.forEach((item) => {
        newsContainer.appendChild(item);
      });
    }

    // Function to save timer state to local storage with timestamp
    function saveTimerState() {
      localStorage.setItem("timerIsActive", timerIsActive);
      localStorage.setItem("secondsRemaining", secondsRemaining);
      localStorage.setItem("lastTimerCheckpoint", Date.now());
    }

    // Function to load timer state from local storage
    function loadTimerState() {
      const savedTimerIsActive = localStorage.getItem("timerIsActive");
      const savedSecondsRemaining = localStorage.getItem("secondsRemaining");
      const savedTimerCheckpoint = localStorage.getItem("lastTimerCheckpoint");

      if (savedTimerIsActive !== null) {
        timerIsActive = savedTimerIsActive === "true";

        // Calculate how much time has passed since the timer state was saved
        if (savedTimerCheckpoint && timerIsActive) {
          const elapsedTime = Math.floor(
            (Date.now() - parseInt(savedTimerCheckpoint)) / 1000
          );
          secondsRemaining = Math.max(
            0,
            parseInt(savedSecondsRemaining, 10) - elapsedTime
          );

          // If timer ran out while page was closed, reset it to the selected frequency
          if (secondsRemaining <= 0) {
            const minutes = parseInt(
              frequencyDropdown.value.replace("min", "")
            );
            secondsRemaining = minutes * 60;
          }
        } else {
          secondsRemaining = parseInt(savedSecondsRemaining, 10);
        }

        // Update the display immediately
        countdownDisplay.textContent = formatTime(secondsRemaining);
      }
    }

    // Periodically save timer state while page is open
    setInterval(saveTimerState, 5000);

    // Save timer state when page is about to unload
    window.addEventListener("beforeunload", saveTimerState);

    // Function to announce page refresh using text-to-speech
    function announceRefresh() {
      if ("speechSynthesis" in window) {
        const announcement = new SpeechSynthesisUtterance(
          "Page will now be refreshed"
        );
        window.speechSynthesis.speak(announcement);
      }
    }

    // Format time as MM:SS
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins
        .toString()
        .padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
    }

    // Function to save URLs to local storage
    function saveUrlsToLocalStorage() {
      const regions = [
        "world",
        "north_america",
        "south_america",
        "europe",
        "asia",
        "africa",
        "australia",
        "mena",
      ];

      const savedUrls = {};

      regions.forEach((region) => {
        const inputs = document.querySelectorAll(
          `input[name="${region}_urls"]`
        );
        savedUrls[region] = Array.from(inputs).map((input) => input.value);
      });

      localStorage.setItem("currentAffairsUrls", JSON.stringify(savedUrls));
      // Also store URL order
      storeUrlOrder();
    }

    // Function to load URLs from local storage
    function loadUrlsFromLocalStorage() {
      const savedUrls = localStorage.getItem("currentAffairsUrls");
      if (savedUrls) {
        const urls = JSON.parse(savedUrls);
        const regions = [
          "world",
          "north_america",
          "south_america",
          "europe",
          "asia",
          "africa",
          "australia",
          "mena",
        ];

        regions.forEach((region) => {
          if (urls[region]) {
            const container = document.getElementById(`${region}Container`);
            // Clear existing fields beyond the first 4
            const existingFields = container.querySelectorAll(".source-field");
            for (let i = 4; i < existingFields.length; i++) {
              existingFields[i].remove();
            }

            // Fill existing fields
            const inputs = container.querySelectorAll(
              'input[name^="' + region + '"]'
            );
            inputs.forEach((input, index) => {
              if (index < urls[region].length) {
                input.value = urls[region][index];
              }
            });

            // Add additional fields if needed
            if (urls[region].length > 4) {
              for (let i = 4; i < urls[region].length; i++) {
                addSourceField(region, urls[region][i]);
              }
            }
          }
        });
      }
      // Store URL order
      storeUrlOrder();
    }

    // Timer toggle functionality
    timerToggle.addEventListener("click", function () {
      if (timerIsActive) {
        // Stop timer
        stopAutoRefresh();
        timerIsActive = false;
        this.classList.remove("btn-danger");
        this.classList.add("btn-success");
        this.innerHTML = '<i class="bi bi-play-fill"></i>';
      } else {
        // Start timer
        startAutoRefresh();
        timerIsActive = true;
        this.classList.remove("btn-success");
        this.classList.add("btn-danger");
        this.innerHTML = '<i class="bi bi-pause-fill"></i>';
      }
      saveTimerState();
    });

    // Timer reset functionality
    timerReset.addEventListener("click", function () {
      if (timerIsActive) {
        stopAutoRefresh();
        startAutoRefresh();
      } else {
        // Just reset the display without starting
        const minutes = parseInt(frequencyDropdown.value.replace("min", ""));
        secondsRemaining = minutes * 60;
        countdownDisplay.textContent = formatTime(secondsRemaining);
      }
      saveTimerState();
    });

    // Add event listeners to all "Add Source" buttons
    document.querySelectorAll(".add-source-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const region = this.getAttribute("data-region");
        addSourceField(region);
        saveUrlsToLocalStorage();
      });
    });

    // Add event listeners to all existing URL inputs
    document.querySelectorAll('input[name$="_urls"]').forEach((input) => {
      input.addEventListener("input", saveUrlsToLocalStorage);
    });

    // Toggle search panel visibility
    toggleButton.addEventListener("click", function () {
      const isSearchVisible = leftColumn.style.display !== "none";

      if (isSearchVisible) {
        leftColumn.style.display = "none";
        toggleButton.innerHTML =
          '<i class="bi bi-arrow-right-circle"></i> Show Search';
        newsColumn.className = "col-md-12";

        // Preserve the 3-column layout on large screens
        document.querySelectorAll(".news-grid-item").forEach((item) => {
          item.className = item.className.replace(
            /col-md-\d+/g,
            "col-md-6 col-xl-4"
          );
        });
      } else {
        leftColumn.style.display = "block";
        toggleButton.innerHTML =
          '<i class="bi bi-arrow-left-circle"></i> Hide Search';
        newsColumn.className = "col-md-8";

        // Adjust to 2-column layout when sidebar is visible
        document.querySelectorAll(".news-grid-item").forEach((item) => {
          item.className = item.className.replace(/col-md-\d+/g, "col-md-12");
        });
      }
    });

    // Auto-refresh functionality
    function startAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        clearInterval(progressInterval);
        clearInterval(countdownInterval);
      }

      const selectedValue = frequencyDropdown.value;
      const minutes = parseInt(selectedValue.replace("min", ""));
      const milliseconds = minutes * 60 * 1000;

      minutesDisplay.textContent = minutes;
      refreshStatus.classList.remove("d-none");

      // Initialize countdown timer
      if (secondsRemaining <= 0) {
        secondsRemaining = minutes * 60;
      }
      countdownDisplay.textContent = formatTime(secondsRemaining);
      announcementMade = false;

      // Start countdown interval
      countdownInterval = setInterval(() => {
        secondsRemaining--;

        // When countdown reaches 0, make the voice announcement
        if (secondsRemaining <= 0) {
          if (!announcementMade) {
            announceRefresh();
            announcementMade = true;
          }
          secondsRemaining = minutes * 60;
        }

        countdownDisplay.textContent = formatTime(secondsRemaining);
        saveTimerState(); // Save timer state on each tick
      }, 1000);

      refreshInterval = setInterval(() => {
        fetch(window.location.href, {
          method: "POST",
          body: new FormData(urlForm),
        })
          .then((response) => response.text())
          .then((html) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // Update both trending news and regular news grid
            const newTrendingNews = doc.querySelector("#trendingNews");
            const newNewsItems = doc.querySelector("#newsItems");

            if (newTrendingNews) {
              const trendingNewsSection =
                document.querySelector("#trendingNews");
              if (trendingNewsSection) {
                trendingNewsSection.innerHTML = newTrendingNews.innerHTML;
              }
            }

            if (newNewsItems) {
              newsItems.innerHTML = newNewsItems.innerHTML;

              // Sort news by source URL order
              sortNewsBySourceOrder();

              // Reapply column classes after refresh
              const isSearchVisible = leftColumn.style.display !== "none";
              if (!isSearchVisible) {
                document.querySelectorAll(".news-grid-item").forEach((item) => {
                  item.className = item.className.replace(
                    /col-md-\d+/g,
                    "col-md-6 col-xl-4"
                  );
                });
              }
            }

            refreshProgress.style.width = "0%";
            // Reset countdown timer
            secondsRemaining = minutes * 60;
            countdownDisplay.textContent = formatTime(secondsRemaining);
            announcementMade = false;
            saveTimerState(); // Save timer state after refresh

            // Apply category filtering
            applyCurrentCategoryFilter();
          })
          .catch((error) => {
            console.error("Error refreshing news:", error);
          });
      }, milliseconds);

      const updateProgress = () => {
        const step = 100 / (minutes * 60);
        let currentProgress = 0;

        progressInterval = setInterval(() => {
          currentProgress += step;
          if (currentProgress > 100) currentProgress = 0;
          refreshProgress.style.width = currentProgress + "%";
        }, 1000);
      };

      updateProgress();
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        clearInterval(progressInterval);
        clearInterval(countdownInterval);
        refreshInterval = null;
        progressInterval = null;
        countdownInterval = null;
      }

      refreshStatus.classList.add("d-none");
      refreshProgress.style.width = "0%";
      saveTimerState(); // Save timer state when stopped
    }

    // Load timer state when the page loads
    loadTimerState();

    // If the timer was active, start it again
    if (timerIsActive) {
      startAutoRefresh();
      timerToggle.classList.remove("btn-success");
      timerToggle.classList.add("btn-danger");
      timerToggle.innerHTML = '<i class="bi bi-pause-fill"></i>';
    }

    // Update minutes display when frequency changes
    frequencyDropdown.addEventListener("change", function () {
      const minutes = parseInt(this.value.replace("min", ""));
      minutesDisplay.textContent = minutes;
      localStorage.setItem("selectedFrequency", this.value);

      // Update countdown timer to reflect new frequency
      secondsRemaining = minutes * 60;
      countdownDisplay.textContent = formatTime(secondsRemaining);

      if (refreshStatus.classList.contains("d-none") === false) {
        stopAutoRefresh();
        startAutoRefresh();
      }

      // If timer is active, restart it with new time
      if (timerIsActive) {
        stopAutoRefresh();
        startAutoRefresh();
      }
    });

    // Submit form with validation and start auto-refresh
    urlForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const selectedFrequency = frequencyDropdown.value;
      localStorage.setItem("selectedFrequency", selectedFrequency);

      // Save the URLs to local storage
      saveUrlsToLocalStorage();

      if (leftColumn) {
        leftColumn.style.display = "none";
      }

      if (newsColumn) {
        newsColumn.className = "col-md-12";
      }

      toggleButton.classList.remove("d-none");
      toggleButton.classList.add("visible");
      toggleButton.innerHTML =
        '<i class="bi bi-arrow-right-circle"></i> Show Search';

      this.submit();

      setTimeout(function () {
        // Start auto-refresh and activate timer
        startAutoRefresh();
        timerIsActive = true;
        timerToggle.classList.remove("btn-success");
        timerToggle.classList.add("btn-danger");
        timerToggle.innerHTML = '<i class="bi bi-pause-fill"></i>';
        saveTimerState(); // Save timer state after starting
      }, 1000);
    });

    // Keep track of current active category
    let currentActiveCategory = "all";

    // Function to apply current category filter
    function applyCurrentCategoryFilter() {
      document
        .querySelectorAll("#newsItems > div[data-category]")
        .forEach((row) => {
          if (
            currentActiveCategory === "all" ||
            row.getAttribute("data-category") === currentActiveCategory
          ) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });

      // Also handle featured news item based on category
      const featuredNews = document.querySelector(".featured-news-card");
      if (featuredNews) {
        const category = featuredNews
          .querySelector(".badge")
          .textContent.toLowerCase();
        if (
          currentActiveCategory !== "all" &&
          category !== currentActiveCategory
        ) {
          document.querySelector(".trending-news-section").style.display =
            "none";
        } else {
          document.querySelector(".trending-news-section").style.display =
            "block";
        }
      }
    }

    // Category filtering for news
    let tabs = document.querySelectorAll("#newsTabs .nav-link");
    tabs.forEach((tab) => {
      tab.addEventListener("click", function (e) {
        e.preventDefault();
        const tabName = this.getAttribute("data-tab");

        // Update URL hash
        window.location.hash = tabName;

        // The rest of your existing tab click handler
        tabs.forEach((t) => t.classList.remove("active"));
        this.classList.add("active");

        currentActiveCategory = tabName;
        applyCurrentCategoryFilter();
      });
    });

    // Initialize with previously selected frequency if available
    const savedFrequency = localStorage.getItem("selectedFrequency");
    if (savedFrequency) {
      frequencyDropdown.value = savedFrequency;
      minutesDisplay.textContent = parseInt(savedFrequency.replace("min", ""));

      // Initialize countdown display with saved frequency
      const minutes = parseInt(savedFrequency.replace("min", ""));
      secondsRemaining = minutes * 60;
      countdownDisplay.textContent = formatTime(secondsRemaining);
    } else {
      // Initialize with default frequency
      const defaultMinutes = parseInt(
        frequencyDropdown.value.replace("min", "")
      );
      secondsRemaining = defaultMinutes * 60;
      countdownDisplay.textContent = formatTime(secondsRemaining);
    }

    // If there's news data, display the timer but don't start it automatically
    if (
      document.querySelectorAll("#newsItems > div[data-category]").length > 0
    ) {
      const timerContainer = document.querySelector(".timer-container");
      if (timerContainer) {
        timerContainer.style.display = "inline-flex";
      }
    }

    // Load saved URLs when the page loads
    loadUrlsFromLocalStorage();
    // Add this at the end:
    activateTabFromHash();
    window.addEventListener("hashchange", activateTabFromHash);
  });
</script>
{% endblock %}
